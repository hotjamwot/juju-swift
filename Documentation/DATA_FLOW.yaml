# Juju Data Flow Map
# AI/Dev reference for component dependencies and data movement
# See ARCHITECTURE.md for data types and patterns

flowName: Juju Data Flow
description: Processing steps and data object transfers between components

nodes:
  # Session Management Flow
  - id: A1_Session_Recorder
    component: SessionManager
    function: Capture Session Duration
    description: Records session start/stop times using Date objects with projectID support
  - id: A2_Session_State_Manager
    component: SessionStateManager
    function: Manage Session State
    description: Handles session state and data creation
  - id: A3_CSV_Operations
    component: SessionCSVManager
    function: CSV Operations
    description: Handles CSV formatting and year-based file routing
  - id: A4_File_Operations
    component: SessionFileManager
    function: File I/O Operations
    description: Thread-safe file operations with proper quoting
  - id: A5_Persistence_Writer
    component: SessionPersistenceManager
    function: Persist Session Data
    description: Coordinates session persistence and posts notifications
  - id: A6_Session_Cache_Updater
    component: ProjectStatisticsCache
    function: Update Project Statistics
    description: Updates cached project statistics with projectID lookups
  - id: A7_Data_Validator
    component: DataValidator
    function: Validate Session Data
    description: Validates sessions and triggers migration if needed
  - id: A8_Session_Data_Parser
    component: SessionDataParser
    function: Parse CSV Session Data
    description: Parses CSV data with format detection and creates SessionRecord objects

  # Dashboard Data Flow
  - id: B1_Data_Aggregator
    component: ChartDataPreparer
    function: Aggregate Dashboard Data
    description: Processes session data into chart-ready formats for weekly and yearly dashboards. Filters data based on view requirements (current week/year).
  - id: B2_Editorial_Engine
    component: NarrativeEngine
    function: Generate Narrative Headlines
    description: Creates dashboard editorial content using projectID lookups
  - id: B3_Dashboard_Navigator_and_Data_Orchestrator
    component: DashboardRootView
    function: Navigate Views & Load Initial Data
    description: Handles dashboard view switching and orchestrates initial loading of all session data into SessionManager.
  - id: B4_Weekly_View_Controller
    component: WeeklyDashboardView
    function: Display Weekly Dashboard
    description: Manages the display of the weekly dashboard, consuming data from ChartDataPreparer.
  - id: B5_Yearly_View_Controller
    component: YearlyDashboardView
    function: Display Yearly Dashboard
    description: Manages the display of the yearly dashboard, consuming data from ChartDataPreparer.

  # Project Management Flow
  - id: C1_Project_Loader
    component: ProjectManager
    function: Load Projects from JSON
    description: Reads project data from JSON files
  - id: C2_Project_Saver
    component: ProjectManager
    function: Save Projects to JSON
    description: Writes project data to JSON files
  - id: C3_Project_Name_Resolver
    component: ProjectManager
    function: Resolve Project Names from IDs
    description: Resolves project names from projectID
  - id: C4_Project_Statistics_Cache
    component: ProjectStatisticsCache
    function: Cache Project Statistics
    description: Caches project statistics for performance

  # Activity Type Management Flow
  - id: D1_ActivityType_Loader
    component: ActivityTypeManager
    function: Load Activity Types from JSON
    description: Reads activity type data from JSON files
  - id: D2_ActivityType_Saver
    component: ActivityTypeManager
    function: Save Activity Types to JSON
    description: Writes activity type data to JSON files

  # UI Session Recording Flow
  - id: U1_Menu_Bar_Interface
    component: MenuManager
    function: Session Recording via Menu Bar
    description: Menu bar session recording interface
  - id: U2_Dashboard_Display
    component: ActiveSessionStatusView
    function: Display Active Session Status
    description: Dashboard active session display
  - id: U3_Session_Editing
    component: SessionsRowView
    function: Edit Session Details
    description: Session editing interface

  # Inline Session Editing Flow
  - id: I1_Project_Editor
    component: SessionsRowView
    function: Edit Project Assignment
    description: Inline project selection
  - id: I2_Phase_Editor
    component: SessionsRowView
    function: Edit Project Phase
    description: Inline phase selection
  - id: I3_ActivityType_Editor
    component: SessionsRowView
    function: Edit Activity Type
    description: Inline activity type selection
  - id: I4_Milestone_Editor
    component: SessionsRowView
    function: Edit Milestone Text
    description: Inline milestone editing
  - id: I5_Mood_Editor
    component: SessionsRowView
    function: Edit Mood Rating
    description: Inline mood selection
  - id: I6_Time_Editor
    component: SessionsRowView
    function: Edit Start/End Times
    description: Inline time editing
  - id: I7_Date_Editor
    component: SessionsRowView
    function: Edit Session Date
    description: Inline date editing
  - id: I8_Notes_Editor
    component: SessionsRowView
    function: Edit Session Notes
    description: Inline notes editing

  # Project Selection Flow
  - id: P1_Project_Selection
    component: InlineSelectionPopover
    function: Generic Project Selection
    description: Project selection interface

  # Data Integrity and Management Flow
  - id: E1_Data_Validator
    component: DataValidator
    function: Validate Data Integrity
    description: Validates data before persistence
  - id: E2_Cache_Manager
    component: CacheManager
    function: Manage Cache Invalidation
    description: Handles cache management
  - id: E3_Data_Migrator
    component: DataMigrationManager
    function: Migrate Legacy Data
    description: Migrates legacy sessions
  - id: E4_Error_Handler
    component: ErrorHandler
    function: Handle Data Errors
    description: Manages error recovery
  - id: E5_Midnight_Session_Fixer
    component: SessionRecord.fixMidnightCrossingSession
    function: Fix Midnight-Crossing Sessions
    description: Fixes midnight-crossing sessions

  # Session Data Processing Flow
  - id: S1_Session_Parser
    component: SessionDataParser
    function: Parse Session CSV Data
    description: Parses CSV session data
  - id: S2_Session_Model_Creation
    component: SessionRecord
    function: Create Session Models
    description: Creates SessionRecord models
  - id: S3_Midnight_Fix_Application
    component: SessionRecord.fixMidnightCrossingSession
    function: Apply Midnight Fix to Sessions
    description: Applies midnight fix

  # Filter Bar and Session Filtering Flow
  - id: F1_Filter_Toggle_Button
    component: FilterToggleButton
    function: Toggle Filter Bar Visibility
    description: Toggles filter bar visibility
  - id: F2_Bottom_Filter_Bar
    component: BottomFilterBar
    function: Filter Session Data
    description: Filters session data
  - id: F3_Filter_Export_State
    component: FilterExportState
    function: Manage Filter State
    description: Manages filter state
  - id: F4_Sessions_View
    component: SessionsView
    function: Display Filtered Sessions
    description: Displays filtered sessions

edges:
  # Session Flow
  - source: A1_Session_Recorder
    target: A2_Persistence_Writer
    data_packet: SessionRecord
  - source: A2_Persistence_Writer
    target: A8_Session_Data_Parser
    data_packet: CSVContent
  - source: A8_Session_Data_Parser
    target: A2_Persistence_Writer
    data_packet: SessionRecord
  - source: A2_Persistence_Writer
    target: A3_Session_Cache_Updater
    data_packet: SessionRecord
  - source: A1_Session_Recorder
    target: A4_Session_Operations
    data_packet: SessionData

  # Dashboard Flow (Updated)
  - source: A2_Persistence_Writer # Full data load notification or initial load
    target: B3_Dashboard_Navigator_and_Data_Orchestrator
    data_packet: SessionLoadNotification # Or direct [SessionRecord] if B3 directly calls loadAllSessions
  - source: B3_Dashboard_Navigator_and_Data_Orchestrator
    target: SessionManager # Implicit call to loadAllSessions
    action: loadAllSessions
  - source: SessionManager
    target: B1_Data_Aggregator (Weekly Instance) # Through WeeklyDashboardView
    data_packet: [SessionRecord] (allSessions)
  - source: SessionManager
    target: B1_Data_Aggregator (Yearly Instance) # Through YearlyDashboardView
    data_packet: [SessionRecord] (allSessions)
  - source: B1_Data_Aggregator
    target: B2_Editorial_Engine
    data_packet: DashboardData
  - source: C1_Project_Loader
    target: B1_Data_Aggregator
    data_packet: [Project]
  - source: D1_ActivityType_Loader
    target: B1_Data_Aggregator
    data_packet: [ActivityType]
  - source: B3_Dashboard_Navigator_and_Data_Orchestrator
    target: B4_Weekly_View_Controller
    data_packet: DashboardViewType (weekly)
  - source: B3_Dashboard_Navigator_and_Data_Orchestrator
    target: B5_Yearly_View_Controller
    data_packet: DashboardViewType (yearly)
  - source: B4_Weekly_View_Controller
    target: B1_Data_Aggregator (Weekly Instance) # To prepare weekly data
    data_packet: [SessionRecord] (allSessions) # Passes all, ChartDataPreparer filters
  - source: B5_Yearly_View_Controller
    target: B1_Data_Aggregator (Yearly Instance) # To prepare yearly data
    data_packet: [SessionRecord] (allSessions) # Passes all, ChartDataPreparer filters


  # Project Flow
  - source: C1_Project_Loader
    target: C2_Project_Saver
    data_packet: Project
  - source: C1_Project_Loader
    target: C3_Project_Name_Resolver
    data_packet: Project

  # Activity Type Flow
  - source: D1_ActivityType_Loader
    target: D2_ActivityType_Saver
    data_packet: ActivityType

  # UI Session Recording Flow
  - source: U1_Menu_Bar_Interface
    target: A1_Session_Recorder
    data_packet: SessionData
  - source: U2_Dashboard_Display
    target: C3_Project_Name_Resolver
    data_packet: ProjectID
  - source: U3_Session_Editing
    target: A1_Session_Recorder
    data_packet: SessionData

  # Project Selection Flow
  - source: P1_Project_Selection
    target: U1_Menu_Bar_Interface
    data_packet: Project
  - source: P1_Project_Selection
    target: U3_Session_Editing
    data_packet: Project

  # Data Migration Flow
  - source: E3_Data_Migrator
    target: A2_Persistence_Writer
    data_packet: SessionRecord
  - source: E3_Data_Migrator
    target: C2_Project_Saver
    data_packet: Project

  # Cache Management Flow
  - source: A3_Session_Cache_Updater
    target: E2_Cache_Manager
    data_packet: CacheUpdate
  - source: E2_Cache_Manager
    target: B1_Data_Aggregator
    data_packet: CachedData # This edge might need re-evaluation based on current ChartDataPreparer interaction with caches

  # Data Validation Flow
  - source: A1_Session_Recorder
    target: E1_Data_Validator
    data_packet: SessionRecord
  - source: C1_Project_Loader
    target: E1_Data_Validator
    data_packet: Project
  - source: D1_ActivityType_Loader
    target: E1_Data_Validator
    data_packet: ActivityType
  - source: E1_Data_Validator
    target: A2_Persistence_Writer
    data_packet: ValidatedSessionRecord
  - source: E1_Data_Validator
    target: C2_Project_Saver
    data_packet: ValidatedProject

  # Error Handling Flow
  - source: A2_Persistence_Writer
    target: E4_Error_Handler
    data_packet: Error
  - source: E3_Data_Migrator
    target: E4_Error_Handler
    data_packet: MigrationError

  # Project Name Resolution Flow
  - source: U2_Dashboard_Display
    target: C3_Project_Name_Resolver
    data_packet: ProjectID
  - source: C3_Project_Name_Resolver
    target: U2_Dashboard_Display
    data_packet: ProjectName

  # Project Statistics Cache Flow
  - source: A6_Session_Cache_Updater
    target: C4_Project_Statistics_Cache
    data_packet: ProjectStatisticsUpdate
  - source: C4_Project_Statistics_Cache
    target: Project
    data_packet: CachedStatistics
  - source: C1_Project_Loader
    target: C4_Project_Statistics_Cache
    data_packet: ProjectID
  - source: C4_Project_Statistics_Cache
    target: C1_Project_Loader
    data_packet: CachedStatistics

  # Filter Bar and Session Filtering Flow
  - source: F1_Filter_Toggle_Button
    target: F2_Bottom_Filter_Bar
    data_packet: FilterState
  - source: F2_Bottom_Filter_Bar
    target: F4_Sessions_View
    data_packet: FilteredSessions
  - source: F3_Filter_Export_State
    target: F2_Bottom_Filter_Bar
    data_packet: FilterParameters
  - source: F4_Sessions_View
    target: F1_Filter_Toggle_Button
    data_packet: SessionCount
  - source: F4_Sessions_View
    target: F3_Filter_Export_State
    data_packet: FilterState
  - source: F4_Sessions_View
    target: A2_Persistence_Writer
    data_packet: SessionRecord
  - source: F4_Sessions_View
    target: C1_Project_Loader
    data_packet: Project
  - source: F4_Sessions_View
    target: D1_ActivityType_Loader
    data_packet: ActivityType

  # Helper Extensions Flow
  - source: A1_Session_Recorder
    target: Date+SessionExtensions
    data_packet: Date
  - source: Date+SessionExtensions
    target: A1_Session_Recorder
    data_packet: Date
  - source: B1_Data_Aggregator
    target: Array+SessionExtensions
    data_packet: [SessionRecord]
  - source: Array+SessionExtensions
    target: B1_Data_Aggregator
    data_packet: [SessionRecord]
  - source: F4_Sessions_View
    target: Array+SessionExtensions
    data_packet: [SessionRecord]
  - source: Array+SessionExtensions
    target: F4_Sessions_View
    data_packet: [SessionRecord]
  - source: B4_Weekly_View_Controller
    target: View+DashboardExtensions # Assuming this exists or is conceptual
    data_packet: View
  - source: View+DashboardExtensions
    target: B4_Weekly_View_Controller
    data_packet: View
  - source: B5_Yearly_View_Controller
    target: View+DashboardExtensions # Assuming this exists or is conceptual
    data_packet: View
  - source: View+DashboardExtensions
    target: B5_Yearly_View_Controller
    data_packet: View
  - source: Array+SessionExtensions
