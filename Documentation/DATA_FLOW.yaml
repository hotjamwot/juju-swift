# Juju Application Critical Data Flow Map
# 
# ðŸ¤– How to Use This Documentation
#
# For AI Assistants and Developers:
# - Data Flow Reference: Use this file to understand how data moves through the system
# - Component Dependencies: See which components depend on each other and how
# - Processing Steps: Understand the sequence of data transformations
# - Cross-Reference: See ARCHITECTURE_RULES.md for architectural patterns and 
#   ARCHITECTURE_SCHEMA.md for exact data type definitions
#
# Key Relationships:
# - This file shows the DATA FLOW through the architecture defined in ARCHITECTURE_RULES.md
# - All data_packet types are defined in ARCHITECTURE_SCHEMA.md
# - Component names map to actual Swift classes defined in the codebase
#
# When making changes:
# 1. Update this file to reflect new data flows
# 2. Update ARCHITECTURE_RULES.md for new architectural patterns
# 3. Update ARCHITECTURE_SCHEMA.md for new data types

flowName: Juju Application Critical Data Flow Map
description: Defines the sequence of processing steps (nodes) and the transfer of major data objects (data_packet) via edges. This map is the source of truth for all business logic dependencies.

nodes:
  # Session Management Flow
  - id: A1_Session_Recorder
    component: SessionManager
    function: Capture Session Duration
    description: Records start/stop times and calculates session duration using full Date objects. Now supports projectID parameter for new sessions. Duration calculated on-demand using DurationCalculator. **UPDATED: No longer uses computed properties - uses startDate/endDate directly**
  - id: A2_Session_State_Manager
    component: SessionStateManager
    function: Manage Session State
    description: Handles session state management, start/end operations, and session data creation with unified DurationCalculator
  - id: A3_CSV_Operations
    component: SessionCSVManager
    function: CSV Operations
    description: Handles CSV formatting, year-based file routing, and header management for timestamp-based sessions
  - id: A4_File_Operations
    component: SessionFileManager
    function: File I/O Operations
    description: Thread-safe file operations (read, write, append) with proper quoting support
  - id: A5_Persistence_Writer
    component: SessionPersistenceManager
    function: Persist Session Data
    description: Coordinates session persistence through CSV and File managers. Uses timestamp-based SessionRecord with computed duration. Posts notifications when sessions are loaded to trigger UI updates
  - id: A6_Session_Cache_Updater
    component: ProjectStatisticsCache
    function: Update Project Statistics
    description: Updates cached project statistics after session changes. Supports projectID-based lookups with automatic duration calculation
  - id: A7_Data_Validator
    component: DataValidator
    function: Validate Session Data
    description: Validates timestamp-based sessions before persistence and triggers automatic migration if needed
  - id: A8_Session_Data_Parser
    component: SessionDataParser
    function: Parse CSV Session Data
    description: Parses CSV session data with comprehensive debug logging. Handles both old and new CSV formats with automatic format detection. Filters data lines and creates SessionRecord objects. **UPDATED: Fixed all 6 optional string unwrapping errors - production ready**

  # Dashboard Data Flow
  - id: B1_Data_Aggregator
    component: ChartDataPreparer
    function: Aggregate Weekly Dashboard Data
    description: Processes raw session data into weekly dashboard-ready formats. Filters to current week only for optimal performance
  - id: B2_Editorial_Engine
    component: NarrativeEngine
    function: Generate Narrative Headlines
    description: Creates dynamic editorial content for dashboard using projectID lookups and session.durationMinutes
  - id: B3_Dashboard_Navigator
    component: DashboardRootView
    function: Navigate Between Dashboard Views
    description: Handles switching between weekly and yearly dashboard views

  # Project Management Flow
  - id: C1_Project_Loader
    component: ProjectManager
    function: Load Projects from JSON
    description: Reads and deserializes project data from JSON files. Supports project phases and cached statistics
  - id: C2_Project_Saver
    component: ProjectManager
    function: Save Projects to JSON
    description: Serializes and writes project data to JSON files
  - id: C3_Project_Name_Resolver
    component: ProjectManager
    function: Resolve Project Names from IDs
    description: Resolves project names from projectID for display. Includes getProjectName(from:) method
  - id: C4_Project_Statistics_Cache
    component: ProjectStatisticsCache
    function: Cache Project Statistics
    description: Caches project statistics (total duration, last session date) for performance optimization

  # Activity Type Management Flow
  - id: D1_ActivityType_Loader
    component: ActivityTypeManager
    function: Load Activity Types from JSON
    description: Reads and deserializes activity type data from JSON files
  - id: D2_ActivityType_Saver
    component: ActivityTypeManager
    function: Save Activity Types to JSON
    description: Serializes and writes activity type data to JSON files

  # UI Session Recording Flow
  - id: U1_Menu_Bar_Interface
    component: MenuManager
    function: Session Recording via Menu Bar
    description: Menu bar interface uses projectID for session creation
  - id: U2_Dashboard_Display
    component: ActiveSessionStatusView
    function: Display Active Session Status
    description: Dashboard resolves project names from projectID
  - id: U3_Session_Editing
    component: SessionsRowView
    function: Edit Session Details
    description: Session editing uses projectID internally

  # Inline Session Editing Flow
  - id: I1_Project_Editor
    component: SessionsRowView
    function: Edit Project Assignment
    description: Inline project selection with automatic phase validation and clearing
  - id: I2_Phase_Editor
    component: SessionsRowView
    function: Edit Project Phase
    description: Inline phase selection with project compatibility validation
  - id: I3_ActivityType_Editor
    component: SessionsRowView
    function: Edit Activity Type
    description: Inline activity type selection with fallback to "Uncategorized"
  - id: I4_Milestone_Editor
    component: SessionsRowView
    function: Edit Milestone Text
    description: Inline milestone text editing with star icon display
  - id: I5_Mood_Editor
    component: SessionsRowView
    function: Edit Mood Rating
    description: Inline mood selection with emoji display (1-10 scale)
  - id: I6_Time_Editor
    component: SessionsRowView
    function: Edit Start/End Times
    description: Inline time picker for start and end times with midnight session handling
  - id: I7_Date_Editor
    component: SessionsRowView
    function: Edit Session Date
    description: Inline date picker with automatic midnight session adjustment
  - id: I8_Notes_Editor
    component: SessionsRowView
    function: Edit Session Notes
    description: Inline notes editing with overlay modal for longer text

  # Project Selection Flow
  - id: P1_Project_Selection
    component: InlineSelectionPopover
    function: Generic Project Selection
    description: ID-based project selection with SelectionItem protocol

  # Data Integrity and Management Flow
  - id: E1_Data_Validator
    component: DataValidator
    function: Validate Data Integrity
    description: Validates sessions, projects, and activity types before persistence
  - id: E2_Cache_Manager
    component: CacheManager
    function: Manage Cache Invalidation
    description: Handles cache invalidation and warming strategies
  - id: E3_Data_Migrator
    component: DataMigrationManager
    function: Migrate Legacy Data
    description: Handles migration of legacy sessions to new schema
  - id: E4_Error_Handler
    component: ErrorHandler
    function: Handle Data Errors
    description: Manages error recovery and user notifications
  - id: E5_Midnight_Session_Fixer
    component: SessionRecord.fixMidnightCrossingSession
    function: Fix Midnight-Crossing Sessions
    description: Automatically fixes sessions that cross midnight by adjusting end time when end time is between midnight and 4 AM, ensuring proper duration calculation for sessions spanning across days

  # Session Data Processing Flow
  - id: S1_Session_Parser
    component: SessionDataParser
    function: Parse Session CSV Data
    description: Parses CSV session data and applies midnight-crossing fixes to all loaded sessions
  - id: S2_Session_Model_Creation
    component: SessionRecord
    function: Create Session Models
    description: Creates SessionRecord models with proper date/time calculations including midnight fix
  - id: S3_Midnight_Fix_Application
    component: SessionRecord.fixMidnightCrossingSession
    function: Apply Midnight Fix to Sessions
    description: Automatically applies midnight-crossing fix during session parsing to ensure proper duration calculation

  # Filter Bar and Session Filtering Flow
  - id: F1_Filter_Toggle_Button
    component: FilterToggleButton
    function: Toggle Filter Bar Visibility
    description: Displays session count and toggles filter bar. Shows current session count for current week
  - id: F2_Bottom_Filter_Bar
    component: BottomFilterBar
    function: Filter Session Data
    description: Provides filtering by project, activity type, and date range. Displays session count for filtered results
  - id: F3_Filter_Export_State
    component: FilterExportState
    function: Manage Filter State
    description: ObservableObject managing filter state (project, activity type, date filters, custom date ranges)
  - id: F4_Sessions_View
    component: SessionsView
    function: Display Filtered Sessions
    description: Main sessions view that applies filters and displays grouped session data

edges:
  # Session Flow
  - source: A1_Session_Recorder
    target: A2_Persistence_Writer
    data_packet: SessionRecord
  - source: A2_Persistence_Writer
    target: A8_Session_Data_Parser
    data_packet: CSVContent
  - source: A8_Session_Data_Parser
    target: A2_Persistence_Writer
    data_packet: SessionRecord
  - source: A2_Persistence_Writer
    target: A3_Session_Cache_Updater
    data_packet: SessionRecord
  - source: A1_Session_Recorder
    target: A4_Session_Operations
    data_packet: SessionData

  # Dashboard Flow
  - source: A2_Persistence_Writer
    target: B1_Data_Aggregator
    data_packet: SessionRecord
  - source: B1_Data_Aggregator
    target: B2_Editorial_Engine
    data_packet: DashboardData

  # Project Flow
  - source: C1_Project_Loader
    target: C2_Project_Saver
    data_packet: Project
  - source: C1_Project_Loader
    target: C3_Project_Name_Resolver
    data_packet: Project

  # Activity Type Flow
  - source: D1_ActivityType_Loader
    target: D2_ActivityType_Saver
    data_packet: ActivityType

  # UI Session Recording Flow
  - source: U1_Menu_Bar_Interface
    target: A1_Session_Recorder
    data_packet: SessionData
  - source: U2_Dashboard_Display
    target: C3_Project_Name_Resolver
    data_packet: ProjectID
  - source: U3_Session_Editing
    target: A1_Session_Recorder
    data_packet: SessionData

  # Project Selection Flow
  - source: P1_Project_Selection
    target: U1_Menu_Bar_Interface
    data_packet: Project
  - source: P1_Project_Selection
    target: U3_Session_Editing
    data_packet: Project

  # Dashboard Navigation Flow
  - source: B3_Dashboard_Navigator
    target: B4_Yearly_Data_Aggregator
    data_packet: DashboardViewType
  - source: B4_Yearly_Data_Aggregator
    target: YearlyDashboardView
    data_packet: YearlyDashboardData

  # Data Migration Flow
  - source: E3_Data_Migrator
    target: A2_Persistence_Writer
    data_packet: SessionRecord
  - source: E3_Data_Migrator
    target: C2_Project_Saver
    data_packet: Project

  # Cache Management Flow
  - source: A3_Session_Cache_Updater
    target: E2_Cache_Manager
    data_packet: CacheUpdate
  - source: E2_Cache_Manager
    target: B1_Data_Aggregator
    data_packet: CachedData

  # Data Validation Flow
  - source: A1_Session_Recorder
    target: E1_Data_Validator
    data_packet: SessionRecord
  - source: C1_Project_Loader
    target: E1_Data_Validator
    data_packet: Project
  - source: D1_ActivityType_Loader
    target: E1_Data_Validator
    data_packet: ActivityType
  - source: E1_Data_Validator
    target: A2_Persistence_Writer
    data_packet: ValidatedSessionRecord
  - source: E1_Data_Validator
    target: C2_Project_Saver
    data_packet: ValidatedProject

  # Error Handling Flow
  - source: A2_Persistence_Writer
    target: E4_Error_Handler
    data_packet: Error
  - source: E3_Data_Migrator
    target: E4_Error_Handler
    data_packet: MigrationError

  # Project Name Resolution Flow
  - source: U2_Dashboard_Display
    target: C3_Project_Name_Resolver
    data_packet: ProjectID
  - source: C3_Project_Name_Resolver
    target: U2_Dashboard_Display
    data_packet: ProjectName

  # Project Statistics Cache Flow
  - source: A6_Session_Cache_Updater
    target: C4_Project_Statistics_Cache
    data_packet: ProjectStatisticsUpdate
  - source: C4_Project_Statistics_Cache
    target: Project
    data_packet: CachedStatistics
  - source: C1_Project_Loader
    target: C4_Project_Statistics_Cache
    data_packet: ProjectID
  - source: C4_Project_Statistics_Cache
    target: C1_Project_Loader
    data_packet: CachedStatistics

  # Filter Bar and Session Filtering Flow
  - source: F1_Filter_Toggle_Button
    target: F2_Bottom_Filter_Bar
    data_packet: FilterState
  - source: F2_Bottom_Filter_Bar
    target: F4_Sessions_View
    data_packet: FilteredSessions
  - source: F3_Filter_Export_State
    target: F2_Bottom_Filter_Bar
    data_packet: FilterParameters
  - source: F4_Sessions_View
    target: F1_Filter_Toggle_Button
    data_packet: SessionCount
  - source: F4_Sessions_View
    target: F3_Filter_Export_State
    data_packet: FilterState
  - source: F4_Sessions_View
    target: A2_Persistence_Writer
    data_packet: SessionRecord
  - source: F4_Sessions_View
    target: C1_Project_Loader
    data_packet: Project
  - source: F4_Sessions_View
    target: D1_ActivityType_Loader
    data_packet: ActivityType

  # Helper Extensions Flow
  - source: A1_Session_Recorder
    target: Date+SessionExtensions
    data_packet: Date
  - source: Date+SessionExtensions
    target: A1_Session_Recorder
    data_packet: Date
  - source: B1_Data_Aggregator
    target: Array+SessionExtensions
    data_packet: [SessionRecord]
  - source: Array+SessionExtensions
    target: B1_Data_Aggregator
    data_packet: [SessionRecord]
  - source: F4_Sessions_View
    target: Array+SessionExtensions
    data_packet: [SessionRecord]
  - source: Array+SessionExtensions
    target: F4_Sessions_View
    data_packet: [SessionRecord]
  - source: WeeklyDashboardView
    target: View+DashboardExtensions
    data_packet: View
  - source: View+DashboardExtensions
    target: WeeklyDashboardView
    data_packet: View
  - source: YearlyDashboardView
    target: View+DashboardExtensions
    data_packet: View
  - source: View+DashboardExtensions
    target: YearlyDashboardView
    data_packet: View
