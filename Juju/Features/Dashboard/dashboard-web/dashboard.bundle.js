(()=>{var Rt=Object.defineProperty;var T=(o,t)=>()=>(o&&(t=o(o=0)),t);var ot=(o,t)=>{for(var n in t)Rt(o,n,{get:t[n],enumerable:!0})};var at,N,z,yt,gt=T(()=>{at=["#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F","#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#E494A6","#F1A861","#86BCB6","#A8A07D","#B881A3"],N={grid:{display:!0,color:"rgba(224, 224, 224, 0.1)"},ticks:{color:"#E0E0E0",font:{size:11},padding:5}},z={display:!0,position:"top",labels:{color:"#E0E0E0",font:{size:12},padding:15}},yt={callbacks:{label:function(o){let t=o.dataset,n=o.raw;return`${t.label}: ${n.toFixed(1)} hours`}}}});async function zt(){let o=Date.now();if(!K||o-wt>qt)try{K=await window.jujuApi.loadProjects(),wt=o}catch(t){console.warn("Error loading projects:",t),K=[]}return K}async function Kt(o,t){let e=(await zt()).find(a=>a.name===o);return e&&e.color?e.color:at[t%at.length]}async function V(o){let t=[];for(let n=0;n<o.length;n++)t.push(await Kt(o[n],n));return t}async function Et(o,t,n,e,a=null){let s=document.getElementById(o);if(!s)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;if(!t.length||!n.length||n.every(y=>!y.data.length)){let y=s.getContext("2d");return y.save(),y.textAlign="center",y.textBaseline="middle",y.fillStyle="#888888",y.font="14px Poppins",y.fillText("No data available for this period",s.width/2,s.height/2),y.restore(),null}let d=s.getContext("2d"),c=n.filter(y=>y.data.some(l=>l>0)),m=c.map(y=>y.label),E=await V(m);return c.forEach((y,l)=>{y.backgroundColor=E[l],y.borderRadius=8}),new Chart(d,{type:"bar",data:{labels:t,datasets:c},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:0,bottom:0,left:0,right:0}},animation:J,scales:{x:{stacked:!0,...N,grid:{display:!1},border:{color:"#444",width:2},ticks:{...N.ticks,callback:function(y,l){if(!t||l>=t.length)return"";let h=t[l];if(a&&a[h])return a[h];if(a&&h&&h.includes("-"))try{let w=new Date(h+"T00:00:00");return!isNaN(w.getTime())&&w.getDate()!==1?w.toLocaleDateString("en-US",{month:"numeric",day:"numeric"}):""}catch{return h}return h}}},y:{stacked:!0,...N,grid:{display:!1},border:{color:"#444",width:2},title:{display:!0,text:e,color:"#E0E0E0"}}},plugins:{legend:z,tooltip:yt,softShadow:!0}}})}async function bt(o,t,n){let e=document.getElementById(o);if(!e)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let a=e.getContext("2d"),s=.01,d=[],c=[];if(t.forEach((E,y)=>{n[y]>=s&&(d.push(E),c.push(n[y]))}),d.length===0)return console.log(`[Charts] No significant data for pie chart ${o}.`),null;let m=await V(d);return new Chart(a,{type:"pie",data:{labels:d,datasets:[{data:c,backgroundColor:m,borderColor:"#1E1E1E",borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,animation:J,plugins:{legend:{...z,position:"top"},tooltip:{callbacks:{label:function(E){let y=E.label||"",l=E.parsed||0,h=E.chart.data.datasets[0].data.reduce((C,k)=>C+k,0),w=h>0?(l/h*100).toFixed(1):0;return`${y}: ${l.toFixed(1)} hours (${w}%)`}}},softShadow:!0},hover:{mode:"nearest",animationDuration:400,onHover:(E,y)=>{}},elements:{arc:{hoverOffset:18,borderWidth:0}}}})}async function vt(o,t,n="Weekly Hours by Project"){let e=document.getElementById(o).getContext("2d"),a=await V(t.datasets.map(d=>d.label)),s=t.datasets.map((d,c)=>({...d,backgroundColor:a[c],borderColor:a[c],fill:!0,tension:.4,borderWidth:1,pointRadius:0,pointHoverRadius:0}));return new Chart(e,{type:"line",data:{labels:t.labels,datasets:s},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},animation:J,scales:{y:{stacked:!0,...N,grid:{display:!1},border:{color:"#444",width:2},title:{display:!0,text:"Hours",color:"#E0E0E0"}},x:{...N,grid:{display:!1},border:{color:"#444",width:2}}},plugins:{title:{display:!0,text:n,color:"#E0E0E0",padding:{bottom:15}},legend:{...z,position:"bottom"},tooltip:{callbacks:{label:function(d){let c=d.dataset.label||"";return c&&(c+=": "),d.parsed.y!==null&&(c+=d.parsed.y.toFixed(1)+" hours"),c}}},softShadow:!0}}})}async function Ct(o,t,n){let e=document.getElementById(o);if(!e)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;let a=e.getContext("2d"),s=await V(t);return new Chart(a,{type:"bar",data:{labels:t,datasets:[{label:"Total Hours",data:n,backgroundColor:s,borderColor:"#1E1E1E",borderWidth:1,borderRadius:6,maxBarThickness:48}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:10,bottom:10,left:10,right:10}},animation:J,scales:{x:{grid:{display:!1},border:{color:"#444",width:2},ticks:{color:"#E0E0E0",font:{size:12},autoSkip:!1}},y:{beginAtZero:!0,grid:{display:!1},border:{color:"#444",width:2},title:{display:!0,text:"Total Hours",color:"#E0E0E0"},ticks:{color:"#E0E0E0",font:{size:12}}}},plugins:{legend:{display:!1},title:{display:!0,text:"Total Hours by Project",color:"#E0E0E0",padding:{bottom:10}},tooltip:{callbacks:{label:function(d){return`${d.label}: ${d.parsed.y.toFixed(1)} hours`}}},softShadow:!0}}})}var K,wt,qt,Vt,J,jt=T(()=>{gt();K=null,wt=0,qt=5e3;Vt={id:"softShadow",beforeDatasetsDraw(o,t,n){let e=o.ctx;e.save(),e.shadowColor="rgba(0,0,0,0.55)",e.shadowBlur=32,e.shadowOffsetX=0,e.shadowOffsetY=14},afterDatasetsDraw(o,t,n){o.ctx.restore()}};typeof Chart<"u"&&!Chart.registry.plugins.get("softShadow")&&Chart.register(Vt);J={duration:600,easing:"easeOutCubic"}});function Dt(o){let t=parseInt(String(o),10);if(o==null||isNaN(t)||t<0)return"?";let n=Math.floor(t/60),e=t%60;return`${n}h ${e}m`}function kt(o){o=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate())),o.setUTCDate(o.getUTCDate()+4-(o.getUTCDay()||7));var t=new Date(Date.UTC(o.getUTCFullYear(),0,1)),n=Math.ceil(((o.getTime()-t.getTime())/864e5+1)/7);return n}var rt=T(()=>{});function Lt(o){if(!o||o.length===0)return console.log("[Charts] No sessions for daily breakdown chart."),{labels:[],monthLabels:{},datasets:[]};let t={},n=new Set,e=null,a=null;if(o.forEach(l=>{let h=l.date;try{let w=new Date(h+"T00:00:00");if(!h||isNaN(w.getTime()))return;(e===null||w<e)&&(e=w),(a===null||w>a)&&(a=w);let C=l.project||"Unassigned";n.add(C);let k=(l.duration_minutes||0)/60;t[h]||(t[h]={}),t[h][C]=(t[h][C]||0)+k}catch{}}),e===null||a===null)return{labels:[],monthLabels:{},datasets:[]};let s=[],d={},c=new Date(e);for(new Date().setHours(0,0,0,0);c<=a;){let l=c.getFullYear(),h=(c.getMonth()+1).toString().padStart(2,"0"),w=c.getDate().toString().padStart(2,"0"),C=`${l}-${h}-${w}`;s.push(C),c.getDate()===1&&(d[C]=c.toLocaleDateString("en-GB",{month:"short"})),c.setDate(c.getDate()+1)}let y=Array.from(n).sort().map(l=>({label:l,data:s.map(h=>t[h]?.[l]||0),backgroundColor:"#000000"}));return{labels:s,monthLabels:d,datasets:y}}function xt(o){if(!o||o.length===0)return console.log("[Charts] No sessions for weekly chart."),{labels:[],datasets:[]};let t={},n=new Set,e=new Set;o.forEach(c=>{try{let m=new Date(c.date+"T00:00:00");if(isNaN(m.getTime()))return;let E=m.getFullYear(),y=kt(m),l=`${E}-W${y.toString().padStart(2,"0")}`;e.add(l);let h=c.project||"Unassigned";n.add(h);let w=(c.duration_minutes||0)/60;t[l]||(t[l]={}),t[l][h]=(t[l][h]||0)+w}catch{}});let a=Array.from(e).sort(),d=Array.from(n).sort().map(c=>{let m=a.map(E=>t[E]?.[c]||0);return{label:c,data:m,backgroundColor:"#000000",borderWidth:2,fill:!0}});return{labels:a,datasets:d.reverse()}}function At(o){let t={};o.forEach(a=>{let s=a.project||"Unassigned";t[s]=(t[s]||0)+(a.duration_minutes||0)});let n=Object.keys(t).sort(),e=n.map(a=>t[a]/60);return{labels:n,data:e}}var St=T(()=>{rt()});var Tt={};ot(Tt,{destroyCharts:()=>$t,updateCharts:()=>Xt});function Jt(){if(typeof Chart>"u")throw new Error("Chart.js is not loaded. Cannot create charts.")}function $t(){M&&M.destroy(),_&&_.destroy(),W&&W.destroy(),it&&it.destroy(),st&&st.destroy(),lt&&lt.destroy(),X&&X.destroy(),M=_=W=null,it=st=lt=null,X=null,console.log("[Charts] Destroyed existing chart instances.")}async function Xt(o,t,n){try{Jt();let e=document.getElementById("chart-range-title");if(e&&(e.textContent=`Showing data for: ${n}`),$t(),console.log("[Charts] Called destroyCharts before creating new charts."),!o||o.length===0)return console.log("[Charts] No filtered session data for main charts."),{yearlyChart:null,weeklyChart:null,pieChart:null};console.log(`[Charts] Updating main charts for "${n}" with ${o.length} sessions.`);try{let a=Lt(o);M=await Et("yearly-chart",a.labels,a.datasets,"Hours",a.monthLabels);let s=xt(o);_=await vt("weekly-chart",s,"Weekly Hours by Project");let d=At(o);return W=await bt("pie-chart",d.labels,d.data),X=await Ct("project-bar-chart",d.labels,d.data),{yearlyChart:M,weeklyChart:_,pieChart:W}}catch(a){return console.error("[Charts] Error creating charts:",a),{yearlyChart:null,weeklyChart:null,pieChart:null}}}catch(e){return console.error("[Charts] Error updating charts:",e),{yearlyChart:null,weeklyChart:null,pieChart:null}}}var M,_,W,it,st,lt,X,It=T(()=>{jt();St();M=null,_=null,W=null,it=null,st=null,lt=null,X=null});var Bt={};ot(Bt,{default:()=>A});var ct,Gt,A,dt=T(()=>{ct=class{constructor(){this.events={},this.notificationContainer=null,this.modal=null,this.init()}init(){this.notificationContainer=document.getElementById("notification-container"),this.modal=document.getElementById("confirmation-modal"),this.setupModalListeners()}on(t,n){this.events[t]||(this.events[t]=[]),this.events[t].push(n)}off(t,n){if(!this.events[t])return;let e=this.events[t].indexOf(n);e>-1&&this.events[t].splice(e,1)}emit(t,n){this.events[t]&&this.events[t].forEach(e=>{try{e(n)}catch(a){console.error(`Error in event handler for ${t}:`,a)}})}showNotification(t,n,e,a=5e3){if(!this.notificationContainer)return;let s=document.createElement("div");s.className=`notification ${t}`;let d=this.getNotificationIcon(t);return s.innerHTML=`
            <div class="notification-icon">${d}</div>
            <div class="notification-content">
                <div class="notification-title">${n}</div>
                <div class="notification-message">${e}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
        `,this.notificationContainer.appendChild(s),setTimeout(()=>s.classList.add("show"),10),a>0&&setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},a),s}getNotificationIcon(t){return{success:"\u2713",error:"\u2715",warning:"\u26A0",info:"\u2139"}[t]||"\u2139"}showConfirmation(t,n,e,a){return this.modal?new Promise((s,d)=>{let c=document.getElementById("modal-title"),m=document.getElementById("modal-message"),E=document.getElementById("modal-confirm"),y=document.getElementById("modal-cancel"),l=document.getElementById("modal-close");c&&(c.textContent=t),m&&(m.textContent=n);let h=()=>{this.hideModal(),C(),e&&e(),s(!0)},w=()=>{this.hideModal(),C(),a&&a(),s(!1)},C=()=>{E.removeEventListener("click",h),y.removeEventListener("click",w),l.removeEventListener("click",w),this.modal.removeEventListener("click",k)},k=P=>{P.target===this.modal&&w()};E.addEventListener("click",h),y.addEventListener("click",w),l.addEventListener("click",w),this.modal.addEventListener("click",k),this.showModal()}):Promise.reject("Modal not found")}showModal(){this.modal&&(this.modal.classList.add("show"),document.body.style.overflow="hidden")}hideModal(){this.modal&&(this.modal.classList.remove("show"),document.body.style.overflow="")}setupModalListeners(){this.modal&&document.addEventListener("keydown",t=>{t.key==="Escape"&&this.modal.classList.contains("show")&&this.hideModal()})}async deleteWithConfirmation(t,n,e,a){let s=`Delete ${t}`,d=`Are you sure you want to delete "${e}"? This action cannot be undone.`;if(!await this.showConfirmation(s,d))return{success:!1,cancelled:!0};try{let m=await a(n);if(m&&m.success)return this.showNotification("success","Deleted",`${t} "${e}" has been deleted successfully.`),this.emit(`${t.toLowerCase()}Deleted`,{id:n,name:e}),{success:!0};{let E=m&&m.error?m.error:"Unknown error occurred";return this.showNotification("error","Delete Failed",`Failed to delete ${t.toLowerCase()}: ${E}`),{success:!1,error:E}}}catch(m){return this.showNotification("error","Delete Failed",`An error occurred while deleting the ${t.toLowerCase()}.`),{success:!1,error:m.message}}}async deleteSessionWithFallback(t,n){let e=[async a=>{if(window.jujuApi&&typeof window.jujuApi.deleteSession=="function")return await window.jujuApi.deleteSession(a);throw new Error("Delete API not available")},async a=>await this.manualDeleteSession(a)];for(let a=0;a<e.length;a++)try{let s=await this.deleteWithConfirmation("Session",t,n,e[a]);if(s.success||s.cancelled)return s}catch(s){if(a===e.length-1)throw s}}async deleteProjectWithFallback(t,n){let e=[async a=>{if(window.jujuApi&&typeof window.jujuApi.deleteProject=="function")return await window.jujuApi.deleteProject(a);throw new Error("Delete API not available")},async a=>await this.manualDeleteProject(a)];for(let a=0;a<e.length;a++)try{let s=await this.deleteWithConfirmation("Project",t,n,e[a]);if(s.success||s.cancelled)return s}catch(s){if(a===e.length-1)throw s}}async manualDeleteSession(t){throw new Error("Manual session deletion not implemented")}async manualDeleteProject(t){throw new Error("Manual project deletion not implemented")}},Gt=new ct,A=Gt});var Pt={};ot(Pt,{setupTabs:()=>Qt,updateSessionsTable:()=>Zt});function Qt(){document.querySelectorAll(".tab").forEach(o=>{o.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),o.classList.add("active");let t=o.dataset.tab,n=document.getElementById(t);n&&n.classList.add("active")})})}function Zt(o,t){if(G){if(G.innerHTML="",!o||o.length===0){G.innerHTML=`
            <tr><td colspan="7" class="no-data">No sessions match the current filter or page.</td></tr>`;return}o.forEach(n=>{let e=document.createElement("tr");e.setAttribute("data-session-key",`${n.id}-${n.date}-${n.start_time}`);let a="Invalid Date";try{let l=new Date(n.date+"T00:00:00");if(!isNaN(l.getTime())){let h=l.getFullYear(),w=(l.getMonth()+1).toString().padStart(2,"0"),C=l.getDate().toString().padStart(2,"0");a=`${h}-${w}-${C}`}}catch{}let s=typeof n.start_time=="string"?n.start_time.slice(0,5):"??:??",d=typeof n.end_time=="string"?n.end_time.slice(0,5):"??:??",c=n.project||"N/A",m=n.notes||"",E=n.mood!==void 0&&n.mood!==null&&n.mood!==""?String(n.mood):"",y=`${c} on ${a}`;e.innerHTML=`
            <td class="editable" data-field="date" data-id="${n.id}">${a}</td>
            <td class="editable" data-field="project" data-id="${n.id}">${c}</td>
            <td data-field="duration_minutes" data-id="${n.id}">${Dt(n.duration_minutes)}</td>
            <td class="editable" data-field="start_time" data-id="${n.id}">${s}</td>
            <td class="editable" data-field="end_time" data-id="${n.id}">${d}</td>
            <td class="editable" data-field="notes" data-id="${n.id}">${m}</td>
            <td class="editable" data-field="mood" data-id="${n.id}">${E}</td>
            <td class="actions">
                <button class="btn btn-delete" data-id="${n.id}" data-info="${y}" title="Delete Session">\xD7</button>
            </td>
        `,G.appendChild(e)}),te(t),oe(t)}}function te(o){document.querySelectorAll("#recent-sessions-body td.editable").forEach(t=>{let n=ee.bind(t,o);t.removeEventListener("click",t._boundHandleCellClick),t.addEventListener("click",n),t._boundHandleCellClick=n})}async function ee(o){if(this.querySelector("input, textarea, select"))return;let t=this.textContent,n=this.dataset.field;this.setAttribute("data-original-value",t);let e;if(n==="project"){e=document.createElement("select"),e.classList.add("inline-edit-input"),e.style.width="100%",e.style.height="100%";try{let d=await window.jujuApi.getProjectNames();e.innerHTML="";let c=document.createElement("option");c.value="",c.text="-- Select Project --",e.add(c),d.forEach(m=>{let E=document.createElement("option");E.value=m,E.text=m,m===t&&(E.selected=!0),e.add(E)})}catch{A.showNotification("error","Error","Failed to load project names")}}else if(n==="start_time"||n==="end_time")e=document.createElement("input"),e.type="time",e.value=/^\d{2}:\d{2}$/.test(t)?t:"00:00";else if(n==="date")e=document.createElement("input"),e.type="date",e.value=/^\d{4}-\d{2}-\d{2}$/.test(t)?t:new Date().toISOString().slice(0,10);else if(n==="notes")e=document.createElement("textarea"),e.value=t,e.rows=2;else if(n==="mood"){e=document.createElement("select"),e.classList.add("inline-edit-input"),e.style.width="100%",e.style.height="2em";let d=document.createElement("option");d.value="",d.text="--",e.appendChild(d);for(let c=0;c<=10;c++){let m=document.createElement("option");m.value=c,m.text=c,String(c)===t&&(m.selected=!0),e.appendChild(m)}this.innerHTML="",this.appendChild(e),e.focus()}else e=document.createElement("input"),e.type="text",e.value=t;e.classList.add("inline-edit-input"),e.style.width="100%",e.style.boxSizing="border-box",e.tagName==="TEXTAREA"&&(e.rows=1,e.style.resize="none",e.style.minHeight="32px",e.style.maxHeight="80px",e.style.lineHeight="1.4"),this.innerHTML="",this.appendChild(e),e.focus(),e.type==="text"&&e.select();let a=Nt.bind(e,o),s=ne.bind(e,o);e.addEventListener("blur",a),e.addEventListener("keydown",s),e._boundBlurHandler=a,e._boundKeydownHandler=s}async function ne(o,t){if(t.key==="Enter"){if(this.tagName==="TEXTAREA"&&t.shiftKey)return;t.preventDefault(),await Nt.call(this,o)}else if(t.key==="Escape"){let n=this.parentElement,e=n.getAttribute("data-original-value");this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),n.textContent=e,n.removeAttribute("data-original-value")}}async function Nt(o){let t=this.parentElement;if(!t||!t.dataset){this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler);try{this.remove()}catch{}return}let n=this.value.trim(),e=t.getAttribute("data-original-value"),a=t.dataset.id,s=t.dataset.field;if(this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),n===e){t.textContent=e,t.removeAttribute("data-original-value");return}try{let d=await window.jujuApi.updateSession(a,s,n);t.classList.add("success"),setTimeout(()=>t.classList.remove("success"),1e3),A.showNotification("success","Updated",`Session ${s} updated successfully`),window.jujuApi&&typeof window.jujuApi.loadSessions=="function"?window.jujuApi.loadSessions():typeof o=="function"&&o()}catch(d){t.classList.add("error"),setTimeout(()=>t.classList.remove("error"),1200),t.textContent=e,A.showNotification("error","Update Failed",`Failed to update session: ${d.message}`)}finally{t.removeAttribute("data-original-value")}}function oe(o){document.querySelectorAll("#recent-sessions-body .btn-delete").forEach(t=>{t._boundDeleteHandler&&t.removeEventListener("click",t._boundDeleteHandler);let n=async e=>{e.preventDefault(),e.stopPropagation();let a=e.target.dataset.id,s=e.target.dataset.info||`Session ${a}`;if(!a){A.showNotification("error","Error","Session ID not found");return}try{let d=await A.deleteSessionWithFallback(a,s);d.success?typeof o=="function"&&o():d.cancelled||console.error("Session deletion failed:",d.error)}catch{A.showNotification("error","Delete Failed","An unexpected error occurred while deleting the session")}};t.addEventListener("click",n),t._boundDeleteHandler=n})}var G,Ft=T(()=>{rt();dt();G=document.getElementById("recent-sessions-body")});document.addEventListener("DOMContentLoaded",async()=>{try{let et=function(r,i=null,p=null){let f=new Date;f.setHours(0,0,0,0);let g=new Date(f),u=new Date(f);u.setHours(23,59,59,999);let v="";switch(r){case"7d":g.setDate(f.getDate()-6),v="Last 7 Days";break;case"1m":g=new Date(f.getFullYear(),f.getMonth()-1,f.getDate()),v="Last Month";break;case"3m":g=new Date(f.getFullYear(),f.getMonth()-3,f.getDate()),v="Last Quarter";break;case"1y":g=new Date(f.getFullYear(),0,1),v="This Year";break;case"all":g=null,u=null,v="All Time";break;case"custom":try{if(g=i?new Date(i+"T00:00:00"):null,u=p?new Date(p+"T23:59:59.999"):null,g&&u&&g>u)return l.showNotification("warning","Invalid Range","Start date cannot be after end date."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"};v=`Custom (${i||"..."} - ${p||"..."})`}catch{return l.showNotification("error","Invalid Date","Invalid custom date format."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"}}break;default:g=new Date(f.getFullYear(),0,1),v="This Year"}return g&&!(g instanceof Date&&!isNaN(g))&&(g=null),u&&!(u instanceof Date&&!isNaN(u))&&(u=null),{startDate:g,endDate:u,rangeTitle:v}},nt=function(r,i){return h?r===null&&i===null?[...h]:h.filter(p=>{try{let f=new Date(p.date+"T00:00:00");if(isNaN(f.getTime()))return!1;let g=r===null||f>=r,u=i===null||f<=i;return g&&u}catch{return!1}}):[]},R=function(){if(!F)return;let r=F.value;F.innerHTML='<option value="All">All Projects</option>',w&&w.length>0&&w.forEach(i=>{let p=document.createElement("option");p.value=i.name,p.textContent=i.name,i.name===r&&(p.selected=!0),F.appendChild(p)})},ht=function(){let r=Y?.value||null,i=O?.value||null;return{start:r,end:i}},mt=function(){let r=[...h];U&&U!=="All"&&(r=r.filter(f=>f.project===U));let{start:i,end:p}=ht();return i&&(r=r.filter(f=>f.date>=i)),p&&(r=r.filter(f=>f.date<=p)),r},q=function(){let r=mt();r.sort((u,v)=>{try{let b=u.start_time||"00:00",$=v.start_time||"00:00",B=new Date(`${u.date}T${b}`),H=new Date(`${v.date}T${$}`);if(isNaN(B.getTime())||isNaN(H.getTime())){let L=new Date(u.date+"T00:00:00");return new Date(v.date+"T00:00:00")-L}return H.getTime()-B.getTime()}catch{let $=new Date(u.date+"T00:00:00");return new Date(v.date+"T00:00:00")-$}});let i=Math.ceil(r.length/P),p=(D-1)*P,f=p+P;return{visibleSessions:r.slice(p,f),totalPages:i,filteredSessions:r}},x=function(){let{visibleSessions:r,totalPages:i}=q();y(r,S),ut&&(ut.textContent=`Page ${D} of ${i}`),Z&&(Z.disabled=D<=1),tt&&(tt.disabled=D>=i)};var o=et,t=nt,n=R,e=ht,a=mt,s=q,d=x;let{updateCharts:c,destroyCharts:m}=await Promise.resolve().then(()=>(It(),Tt)),{setupTabs:E,updateSessionsTable:y}=await Promise.resolve().then(()=>(Ft(),Pt)),l=await Promise.resolve().then(()=>(dt(),Bt)).then(r=>r.default),h=[],w=[],C="1y",k="This Year",P=20,D=1,U="All",Q=document.querySelectorAll(".btn-filter"),Ht=document.getElementById("date-from"),Mt=document.getElementById("date-to"),_t=document.getElementById("apply-custom-date"),F=document.getElementById("project-filter-select"),Z=document.getElementById("prev-page-btn"),tt=document.getElementById("next-page-btn"),ut=document.getElementById("page-info"),Y=document.getElementById("session-filter-start-date"),O=document.getElementById("session-filter-end-date"),Wt=document.getElementById("export-sessions-btn"),Ut=document.getElementById("session-clear-dates-btn");window.onSessionsLoaded=function(r){if(typeof r=="string")try{r=JSON.parse(r)}catch{r=[]}window.allSessions=r,h=r,S()},window.onProjectsLoaded=function(r){if(typeof r=="string")try{r=JSON.parse(r)}catch{r=[]}w=r,R(),typeof I=="function"&&I()};async function ft(r){let i=null,p=null;if(r==="custom"&&(i=Ht.value,p=Mt.value,!i||!p)){l.showNotification("warning","Invalid Range",'Please select both "From" and "To" dates for custom range.');return}let{startDate:f,endDate:g,rangeTitle:u}=et(r,i,p);if(u==="Invalid Range")return;let v=nt(f,g);C=r,k=u,Q.forEach(b=>{b.dataset.range===r?b.classList.add("active"):b.classList.remove("active")}),r==="custom"&&Q.forEach(b=>{b.closest(".date-filter-buttons")&&b.classList.remove("active")});try{await c(v,h,u)}catch{l.showNotification("error","Chart Error","Failed to update charts")}}async function S(){if(!h)return;let{startDate:r,endDate:i}=et(C),p=nt(r,i);try{await c(p,h,k)}catch{l.showNotification("error","Chart Error","Failed to update charts")}R(),x()}async function Yt(){let r=document.getElementById("projects-list"),i=document.getElementById("add-project-form");!r||!i||(await I(),i.addEventListener("submit",async p=>{p.preventDefault();let f=document.getElementById("new-project-name"),g=document.getElementById("new-project-color");if(!(!f||!g))try{let u=await window.jujuApi.addProject({name:f.value.trim(),color:g.value});u&&u.success&&(f.value="",g.value="#4E79A7",await I(),await S(),l.showNotification("success","Project Added",`Project "${f.value.trim()}" created successfully`))}catch(u){l.showNotification("error","Add Failed",`Failed to add project: ${u.message}`)}}))}async function I(){let r=document.getElementById("projects-list");if(r)try{r.innerHTML="",w.forEach(i=>{let p=document.createElement("div");p.className="project-item",p.innerHTML=`
                        <div class="project-info">
                            <span class="project-name">${i.name}</span>
                            <div class="project-color">
                                <input type="color" value="${i.color||"#4E79A7"}" 
                                       data-project-id="${i.id}">
                            </div>
                        </div>
                        <div class="project-about">
                            <div class="about-display ${i.about&&i.about.trim()?"":"placeholder"}" data-project-id="${i.id}">
                                ${i.about&&i.about.trim()?i.about.replace(/\n/g,"<br>"):"(Click to add about...)"}
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-delete" data-id="${i.id}" data-name="${i.name}" title="Delete Project" aria-label="Delete Project">&times;</button>
                        </div>
                    `;let f=p.querySelector('input[type="color"]');f&&f.addEventListener("change",async u=>{try{await window.jujuApi.updateProjectColor(i.id,u.target.value),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),l.showNotification("success","Color Updated",`Project "${i.name}" color updated`)}catch(v){l.showNotification("error","Update Failed",`Failed to update color: ${v.message}`)}});let g=p.querySelector(".project-about .about-display");if(g){let u=()=>{if(p.querySelector(".project-about textarea"))return;let v=i.about||"",b=document.createElement("textarea");b.className="inline-edit-input",b.rows=Math.min(6,Math.max(2,v.split(`
`).length)),b.value=v,b.style.width="100%",g.replaceWith(b),b.focus();let $=async L=>{if(b.removeEventListener("blur",B),b.removeEventListener("keydown",H),L)try{await window.jujuApi.updateProjectAbout(i.id,b.value),i.about=b.value,l.showNotification("success","Saved",`About updated for "${i.name}"`)}catch(Ot){l.showNotification("error","Update Failed",`Failed to update about: ${Ot.message}`)}let j=document.createElement("div");j.className="about-display",j.setAttribute("data-project-id",i.id),j.style.minHeight="1.8em",j.style.padding="6px 8px",j.style.border="1px solid transparent",j.style.borderRadius="4px",j.style.cursor="text",j.style.background="transparent",j.style.textAlign="left";let pt=i.about&&i.about.trim()?i.about:"";pt?(j.style.color="inherit",j.innerHTML=pt.replace(/\n/g,"<br>")):(j.style.color="var(--text-muted)",j.textContent="(Click to add about...)"),b.replaceWith(j),j.addEventListener("click",u)},B=()=>$(!0),H=L=>{L.key==="Enter"&&!L.shiftKey?(L.preventDefault(),$(!0)):L.key==="Escape"&&(L.preventDefault(),$(!1))};b.addEventListener("blur",B),b.addEventListener("keydown",H)};g.addEventListener("click",u)}r.appendChild(p)}),R()}catch{r.innerHTML='<div class="error">Failed to load projects</div>',l.showNotification("error","Load Failed","Failed to load projects")}}Q.forEach(r=>{r.closest(".date-filter-buttons")&&r.addEventListener("click",()=>ft(r.dataset.range))}),_t.addEventListener("click",()=>ft("custom")),F?.addEventListener("change",r=>{U=r.target.value,D=1,x()}),Z?.addEventListener("click",()=>{D>1&&(D--,x())}),tt?.addEventListener("click",()=>{let{totalPages:r}=q();D<r&&(D++,x())}),Ut?.addEventListener("click",()=>{Y&&(Y.value=""),O&&(O.value=""),D=1,x()}),document.getElementById("projects-list").addEventListener("click",async function(r){if(r.target.classList.contains("btn-delete")){r.preventDefault(),r.stopPropagation();let i=r.target,p=i.dataset.id,f=i.dataset.name||`Project ${p}`;if(!p){l.showNotification("error","Error","Project ID not found");return}try{let g=await l.deleteProjectWithFallback(p,f);g.success?(await I(),await S(),window.jujuApi&&typeof window.jujuApi.refreshMenu=="function"&&window.jujuApi.refreshMenu()):g.cancelled||console.error("Project deletion failed:",g.error)}catch{l.showNotification("error","Delete Failed","An unexpected error occurred while deleting the project")}}}),Y?.addEventListener("change",()=>{D=1,x()}),O?.addEventListener("change",()=>{D=1,x()}),Wt?.addEventListener("click",()=>{let{filteredSessions:r}=q();if(!r.length){l.showNotification("warning","No Data","No sessions to export for the current filter.");return}let i=Object.keys(r[0]).filter(u=>u!=="id");i.includes("mood")||r.some(u=>"mood"in u)&&i.push("mood");let p=r.map(u=>{let v={};return i.forEach(b=>{v[b]=u[b]??""}),v}),f=document.getElementById("export-format-select"),g=f?f.value:"txt";window.jujuApi.exportSessions({sessions:p,fields:i,format:g}).then(u=>{u&&u.success?l.showNotification("success","Exported","Sessions exported successfully."):l.showNotification("error","Export Failed",u&&u.error?u.error:"Unknown error")}).catch(u=>{l.showNotification("error","Export Failed",u&&u.message?u.message:"Unknown error")})}),E(),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),await Yt(),await S(),l.on("sessionDeleted",()=>{S()}),l.on("projectDeleted",()=>{I(),S()})}catch(c){eventSystem&&eventSystem.showNotification("error","Initialization Failed","Failed to initialize dashboard. Please check console for details.");let m=document.getElementById("charts");m&&(m.innerHTML=`<div class="error-message">Failed to initialize dashboard. Please check console for details. Error: ${c.message}</div>`)}});})();
