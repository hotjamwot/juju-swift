(()=>{var ke=Object.defineProperty;var k=(n,e)=>()=>(n&&(e=n(n=0)),e);var ae=(n,e)=>{for(var a in e)ke(n,a,{get:e[a],enumerable:!0})};var V,L,P,ne,oe=k(()=>{V=["#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F","#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#E494A6","#F1A861","#86BCB6","#A8A07D","#B881A3"],L={grid:{display:!0,color:"rgba(224, 224, 224, 0.1)"},ticks:{color:"#E0E0E0",font:{size:11},padding:5}},P={display:!0,position:"top",labels:{color:"#E0E0E0",font:{size:12},padding:15}},ne={callbacks:{label:function(n){let e=n.dataset,a=n.raw;return`${e.label}: ${a.toFixed(1)} hours`}}}});async function Ae(){let n=Date.now();if(!F||n-re>Le)try{F=await window.jujuApi.loadProjects(),re=n}catch(e){console.warn("Error loading projects:",e),F=[]}return F}async function xe(n,e){let t=(await Ae()).find(s=>s.name===n);return t&&t.color?t.color:V[e%V.length]}async function q(n){let e=[];for(let a=0;a<n.length;a++)e.push(await xe(n[a],a));return e}async function se(n,e,a,t,s=null){let o=document.getElementById(n);if(!o)return console.error(`Canvas element with ID ${n} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;if(!e.length||!a.length||a.every(l=>!l.data.length)){let l=o.getContext("2d");return l.save(),l.textAlign="center",l.textBaseline="middle",l.fillStyle="#888888",l.font="14px Poppins",l.fillText("No data available for this period",o.width/2,o.height/2),l.restore(),null}let c=o.getContext("2d"),u=a.filter(l=>l.data.some(d=>d>0)),b=u.map(l=>l.label),f=await q(b);return u.forEach((l,d)=>{l.backgroundColor=f[d]}),new Chart(c,{type:"bar",data:{labels:e,datasets:u},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:0,bottom:0,left:0,right:0}},scales:{x:{stacked:!0,...L,ticks:{...L.ticks,callback:function(l,d){if(!e||d>=e.length)return"";let m=e[d];if(s&&s[m])return s[m];if(s&&m&&m.includes("-"))try{let C=new Date(m+"T00:00:00");return!isNaN(C.getTime())&&C.getDate()!==1?C.toLocaleDateString("en-US",{month:"numeric",day:"numeric"}):""}catch{return m}return m}}},y:{stacked:!0,...L,title:{display:!0,text:t,color:"#E0E0E0"}}},plugins:{legend:P,tooltip:ne}}})}function H(n,e,a,t=3){let s=document.getElementById(n);if(!s)return console.error(`Canvas element with ID ${n} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let o=s.getContext("2d");if(!e||!a||e.length!==4||a.length!==4)return console.warn(`[Charts] Invalid data for multi-bar comparison chart ${n}. Expected 4 labels and 4 values.`),o.save(),o.textAlign="center",o.textBaseline="middle",o.fillStyle="#888888",o.font="12px Poppins",o.fillText("Invalid data",s.width/2,s.height/2),o.restore(),null;let c="rgba(78, 121, 167, 0.4)",u="#F28E2B",b=a.map((l,d)=>d===t?u:c),f=a.map((l,d)=>d===t?u:"#4E79A7");return new Chart(o,{type:"bar",data:{labels:e,datasets:[{label:"Hours",data:a,backgroundColor:b,borderColor:f,borderWidth:1,barPercentage:1,categoryPercentage:.9}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:2,bottom:2,left:20,right:15}},scales:{x:{beginAtZero:!0,position:"top",grid:{display:!1,drawBorder:!1},ticks:{color:"#888888",font:{size:10},maxTicksLimit:4,padding:2,callback:l=>l.toFixed(1)+"h"}},y:{grid:{display:!1,drawBorder:!1},ticks:{color:"#CCCCCC",font:{size:11},padding:4,maxRotation:0,minRotation:0,autoSkip:!1,callback:function(l,d){return this.getLabelForValue(l).replace(/(Sun|Mon|Tue|Wed|Thu|Fri|Sat)day/,"$1").replace(" Weeks Ago","w ago").replace(" Months Ago","m ago")}}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,callbacks:{title:function(l){return l[0].label},label:function(l){return`Hours: ${l.parsed.x.toFixed(1)}`}}}}}})}async function le(n,e,a){let t=document.getElementById(n);if(!t)return console.error(`Canvas element with ID ${n} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let s=t.getContext("2d"),o=.01,c=[],u=[];if(e.forEach((f,l)=>{a[l]>=o&&(c.push(f),u.push(a[l]))}),c.length===0)return console.log(`[Charts] No significant data for pie chart ${n}.`),null;let b=await q(c);return new Chart(s,{type:"pie",data:{labels:c,datasets:[{data:u,backgroundColor:b,borderColor:"#1E1E1E",borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{...P,position:"top"},tooltip:{callbacks:{label:function(f){let l=f.label||"",d=f.parsed||0,m=f.chart.data.datasets[0].data.reduce((w,j)=>w+j,0),C=m>0?(d/m*100).toFixed(1):0;return`${l}: ${d.toFixed(1)} hours (${C}%)`}}}}}})}async function ie(n,e){let a=document.getElementById(n).getContext("2d"),t=await q(e.datasets.map(o=>o.label)),s=e.datasets.map((o,c)=>({...o,backgroundColor:t[c],borderColor:t[c],fill:!0,tension:.4,borderWidth:1,pointRadius:0,pointHoverRadius:0}));return new Chart(a,{type:"line",data:{labels:e.labels,datasets:s},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},scales:{y:{stacked:!0,...L,title:{display:!0,text:"Cumulative Hours",color:"#E0E0E0"}},x:L},plugins:{title:{display:!0,text:"Cumulative Hours by Project",color:"#E0E0E0",padding:{bottom:15}},legend:{...P,position:"bottom"},tooltip:{callbacks:{label:function(o){let c=o.dataset.label||"";return c&&(c+=": "),o.parsed.y!==null&&(c+=o.parsed.y.toFixed(1)+" total hours"),c}}}}}})}var F,re,Le,ce=k(()=>{oe();F=null,re=0,Le=5e3});function de(n){let e=parseInt(String(n),10);if(n==null||isNaN(e)||e<0)return"?";let a=Math.floor(e/60),t=e%60;return`${a}h ${t}m`}function ue(n){n=new Date(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate())),n.setUTCDate(n.getUTCDate()+4-(n.getUTCDay()||7));var e=new Date(Date.UTC(n.getUTCFullYear(),0,1)),a=Math.ceil(((n.getTime()-e.getTime())/864e5+1)/7);return a}var K=k(()=>{});function pe(n){if(!n||n.length===0)return console.log("[Charts] No sessions for daily breakdown chart."),{labels:[],monthLabels:{},datasets:[]};let e={},a=new Set,t=null,s=null;if(n.forEach(d=>{let m=d.date;try{let C=new Date(m+"T00:00:00");if(!m||isNaN(C.getTime()))return;(t===null||C<t)&&(t=C),(s===null||C>s)&&(s=C);let w=d.project||"Unassigned";a.add(w);let j=(d.duration_minutes||0)/60;e[m]||(e[m]={}),e[m][w]=(e[m][w]||0)+j}catch{}}),t===null||s===null)return{labels:[],monthLabels:{},datasets:[]};let o=[],c={},u=new Date(t);for(new Date().setHours(0,0,0,0);u<=s;){let d=u.getFullYear(),m=(u.getMonth()+1).toString().padStart(2,"0"),C=u.getDate().toString().padStart(2,"0"),w=`${d}-${m}-${C}`;o.push(w),u.getDate()===1&&(c[w]=u.toLocaleDateString("en-GB",{month:"short"})),u.setDate(u.getDate()+1)}let l=Array.from(a).sort().map(d=>({label:d,data:o.map(m=>e[m]?.[d]||0),backgroundColor:"#000000"}));return{labels:o,monthLabels:c,datasets:l}}function fe(n){if(!n||n.length===0)return console.log("[Charts] No sessions for weekly chart."),{labels:[],datasets:[]};let e={},a=new Set,t=new Set;n.forEach(u=>{try{let b=new Date(u.date+"T00:00:00");if(isNaN(b.getTime()))return;let f=b.getFullYear(),l=ue(b),d=`${f}-W${l.toString().padStart(2,"0")}`;t.add(d);let m=u.project||"Unassigned";a.add(m);let C=(u.duration_minutes||0)/60;e[d]||(e[d]={}),e[d][m]=(e[d][m]||0)+C}catch{}});let s=Array.from(t).sort(),c=Array.from(a).sort().map(u=>{let b=0,f=s.map(l=>(b+=e[l]?.[u]||0,b));return{label:u,data:f,backgroundColor:"#000000",borderWidth:2,fill:!0}});return{labels:s,datasets:c.reverse()}}function me(n){let e={};n.forEach(s=>{let o=s.project||"Unassigned";e[o]=(e[o]||0)+(s.duration_minutes||0)});let a=Object.keys(e).sort(),t=a.map(s=>e[s]/60);return{labels:a,data:t}}var he=k(()=>{K()});var ye={};ae(ye,{destroyCharts:()=>ge,updateCharts:()=>Se});function Te(){if(typeof Chart>"u")throw new Error("Chart.js is not loaded. Cannot create charts.")}function ge(){S&&S.destroy(),$&&$.destroy(),I&&I.destroy(),N&&N.destroy(),M&&M.destroy(),_&&_.destroy(),S=$=I=null,N=M=_=null,console.log("[Charts] Destroyed existing chart instances.")}async function Se(n,e,a){try{Te();let t=document.getElementById("chart-range-title");t&&(t.textContent=`Showing data for: ${a}`),ge(),console.log("[Charts] Called destroyCharts before creating new charts.");try{console.log("[Charts] Fetching comparison stats...");let s=await window.jujuApi.getComparisonStats();if(s){let o=s.day;if(o&&o.past&&o.current){let b=[...o.past.map(m=>m.label),o.current.label],f=[...o.past.map(m=>m.value),o.current.value];N=H("day-comparison-bar-chart",b,f,3);let l=document.getElementById("day-comparison-details");l&&(l.textContent=`Today: ${o.current.value.toFixed(1)}h (${o.current.range})`);let d=document.getElementById("day-comparison-title");if(d){let m=o.past.length>0?o.past[o.past.length-1].label:"Previous Day";d.textContent=`Compared to Previous ${m.split(" ")[1]}s`}}else console.warn("Day comparison data missing or invalid:",o);let c=s.week;if(c&&c.past&&c.current){let b=[...c.past.map(d=>d.label),c.current.label],f=[...c.past.map(d=>d.value),c.current.value];M=H("week-comparison-bar-chart",b,f,3);let l=document.getElementById("week-comparison-details");l&&(l.textContent=`This Week: ${c.current.value.toFixed(1)}h (${c.current.range})`)}else console.warn("Week comparison data missing or invalid:",c);let u=s.month;if(u&&u.past&&u.current){let b=[...u.past.map(d=>d.label),u.current.label],f=[...u.past.map(d=>d.value),u.current.value];_=H("month-comparison-bar-chart",b,f,3);let l=document.getElementById("month-comparison-details");l&&(l.textContent=`This Month: ${u.current.value.toFixed(1)}h (${u.current.range})`)}else console.warn("Month comparison data missing or invalid:",u)}else console.warn("Comparison stats data is missing.")}catch(s){console.error("[Charts] Error with comparison stats:",s),["day","week","month"].forEach(o=>{let c=document.getElementById(`${o}-comparison-details`);c&&(c.textContent="Error loading stats")})}if(!n||n.length===0)return console.log("[Charts] No filtered session data for main charts."),{yearlyChart:null,weeklyChart:null,pieChart:null};console.log(`[Charts] Updating main charts for "${a}" with ${n.length} sessions.`);try{let s=pe(n);S=await se("yearly-chart",s.labels,s.datasets,"Hours",s.monthLabels);let o=fe(n);$=await ie("weekly-chart",o);let c=me(n);return I=await le("pie-chart",c.labels,c.data),{yearlyChart:S,weeklyChart:$,pieChart:I}}catch(s){return console.error("[Charts] Error creating charts:",s),{yearlyChart:null,weeklyChart:null,pieChart:null}}}catch(t){return console.error("[Charts] Error updating charts:",t),{yearlyChart:null,weeklyChart:null,pieChart:null}}}var S,$,I,N,M,_,be=k(()=>{ce();he();S=null,$=null,I=null,N=null,M=null,_=null});var Ce={};ae(Ce,{setupTabs:()=>$e,updateSessionsTable:()=>Ie});function $e(){document.querySelectorAll(".tab").forEach(n=>{n.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),n.classList.add("active");let e=n.dataset.tab,a=document.getElementById(e);a?a.classList.add("active"):console.error(`Tab content not found for ID: ${e}`)})}),console.log("[UI] Tabs setup complete.")}function Ie(n,e){if(!U){console.error("[UI] Cannot update sessions table: recentSessionsBody element not found.");return}if(U.innerHTML="",!n||n.length===0){U.innerHTML=`
            <tr><td colspan="6" class="no-data">No sessions match the current filter or page.</td></tr>`,console.log("[UI] Sessions table updated with no data message.");return}n.forEach(a=>{let t=document.createElement("tr");t.setAttribute("data-session-key",`${a.id}-${a.date}-${a.start_time}`);let s="Invalid Date";try{let f=new Date(a.date+"T00:00:00");if(!isNaN(f.getTime())){let l=f.getFullYear(),d=(f.getMonth()+1).toString().padStart(2,"0"),m=f.getDate().toString().padStart(2,"0");s=`${l}-${d}-${m}`}}catch{}let o=typeof a.start_time=="string"?a.start_time.slice(0,5):"??:??",c=typeof a.end_time=="string"?a.end_time.slice(0,5):"??:??",u=a.project||"N/A",b=a.notes||"";t.innerHTML=`
            <td class="editable" data-field="date" data-id="${a.id}">${s}</td>
            <td class="editable" data-field="project" data-id="${a.id}">${u}</td>
            <td data-field="duration_minutes" data-id="${a.id}">${de(a.duration_minutes)}</td>
            <td class="editable" data-field="start_time" data-id="${a.id}">${o}</td>
            <td class="editable" data-field="end_time" data-id="${a.id}">${c}</td>
            <td class="editable" data-field="notes" data-id="${a.id}">${b}</td>
            <td class="actions">
                <button class="btn btn-delete" data-id="${a.id}" title="Delete Session">\xD7</button>
            </td>
        `,U.appendChild(t)}),Be(e),He(e),console.log("[UI] Sessions table updated.")}function Be(n){document.querySelectorAll("#recent-sessions-body td.editable").forEach(e=>{let a=Pe.bind(e,n);e.removeEventListener("click",e._boundHandleCellClick),e.addEventListener("click",a),e._boundHandleCellClick=a})}async function Pe(n){if(this.querySelector("input, textarea, select"))return;let e=this.textContent,a=this.dataset.field;this.setAttribute("data-original-value",e);let t;if(a==="project"){t=document.createElement("select"),t.classList.add("inline-edit-input"),t.style.width="100%",t.style.height="100%";let c=document.createElement("option");c.text="Loading...",t.add(c);try{let u=await window.jujuApi.getProjectNames();t.innerHTML="";let b=document.createElement("option");b.value="",b.text="-- Select Project --",t.add(b),u.forEach(f=>{let l=document.createElement("option");l.value=f,l.text=f,f===e&&(l.selected=!0),t.add(l)})}catch(u){console.error("Failed to load project names:",u)}}else a==="start_time"||a==="end_time"?(t=document.createElement("input"),t.type="time",t.value=/^\d{2}:\d{2}$/.test(e)?e:"00:00"):a==="date"?(t=document.createElement("input"),t.type="date",t.value=/^\d{4}-\d{2}-\d{2}$/.test(e)?e:new Date().toISOString().slice(0,10)):a==="notes"?(t=document.createElement("textarea"),t.value=e,t.rows=2):(t=document.createElement("input"),t.type="text",t.value=e);t.classList.add("inline-edit-input"),t.style.width="100%",t.style.boxSizing="border-box",t.tagName==="TEXTAREA"&&(t.rows=1,t.style.resize="none",t.style.minHeight="32px",t.style.maxHeight="80px",t.style.lineHeight="1.4"),this.innerHTML="",this.appendChild(t),t.focus(),t.type==="text"&&t.select();let s=we.bind(t,n),o=Fe.bind(t,n);t.addEventListener("blur",s),t.addEventListener("keydown",o),t._boundBlurHandler=s,t._boundKeydownHandler=o}async function Fe(n,e){if(e.key==="Enter"){if(this.tagName==="TEXTAREA"&&e.shiftKey)return;e.preventDefault(),console.log("[UI] Enter key pressed, saving..."),await we.call(this,n)}else if(e.key==="Escape"){console.log("[UI] Escape key pressed, cancelling edit.");let a=this.parentElement,t=a.getAttribute("data-original-value");this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),a.textContent=t,a.removeAttribute("data-original-value")}}async function we(n){let e=this.parentElement;if(!e||!e.dataset){console.warn("[UI] handleCellUpdate called on detached or invalid element."),this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler);try{this.remove()}catch{}return}let a=this.value.trim(),t=e.getAttribute("data-original-value"),s=e.dataset.id,o=e.dataset.field;if(this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),a===t){e.textContent=t,e.removeAttribute("data-original-value");return}e.classList.add("saving"),e.innerHTML='<span class="spinner"></span>';try{let c=await window.jujuApi.updateSession(Number(s),o,a);e.classList.remove("saving"),e.classList.add("success"),setTimeout(()=>e.classList.remove("success"),1e3),window.jujuApi&&typeof window.jujuApi.loadSessions=="function"?window.jujuApi.loadSessions():typeof n=="function"&&n()}catch{e.classList.remove("saving"),e.classList.add("error"),setTimeout(()=>e.classList.remove("error"),1200),e.textContent=t}finally{e.removeAttribute("data-original-value")}}function He(n){document.querySelectorAll("#recent-sessions-body .btn-delete").forEach(e=>{e._boundDeleteHandler&&e.removeEventListener("click",e._boundDeleteHandler);let a=async t=>{let s=t.target.dataset.id;if(s&&(console.log("[UI] Delete button clicked for session id:",s,"type:",typeof s),confirm("Are you sure you want to delete this session? This cannot be undone.")))try{if(!window.jujuApi||typeof window.jujuApi.deleteSession!="function"){alert("Delete function not available.");return}console.log("[UI] Calling window.jujuApi.deleteSession with id:",String(s),"type:",typeof String(s));let o=await window.jujuApi.deleteSession(String(s));console.log(`[UI] Session deleted successfully: ${s}. Result:`,o),typeof n=="function"&&n()}catch(o){console.error("[UI] Error deleting session:",o),alert("Failed to delete session. Please try again.")}};e.addEventListener("click",a),e._boundDeleteHandler=a,console.log("[UI] Delete handler attached for session id:",e.dataset.id)})}var U,Ee=k(()=>{K();U=document.getElementById("recent-sessions-body")});document.addEventListener("DOMContentLoaded",async()=>{try{let B=function(r,i=null,h=null){let g=new Date;g.setHours(0,0,0,0);let y=new Date(g),p=new Date(g);p.setHours(23,59,59,999);let E="";switch(r){case"7d":y.setDate(g.getDate()-6),E="Last 7 Days";break;case"1m":y=new Date(g.getFullYear(),g.getMonth()-1,g.getDate()),E="Last Month";break;case"3m":y=new Date(g.getFullYear(),g.getMonth()-3,g.getDate()),E="Last Quarter";break;case"1y":y=new Date(g.getFullYear(),0,1),E="This Year";break;case"all":y=null,p=null,E="All Time";break;case"custom":try{if(y=i?new Date(i+"T00:00:00"):null,p=h?new Date(h+"T23:59:59.999"):null,y&&p&&y>p)return alert("Start date cannot be after end date."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"};E=`Custom (${i||"..."} - ${h||"..."})`}catch(v){return console.error("Error parsing custom dates:",v),alert("Invalid custom date format."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"}}break;default:y=new Date(g.getFullYear(),0,1),E="This Year"}return y&&!(y instanceof Date&&!isNaN(y))&&(y=null),p&&!(p instanceof Date&&!isNaN(p))&&(p=null),{startDate:y,endDate:p,rangeTitle:E}},O=function(r,i){return f?r===null&&i===null?[...f]:f.filter(h=>{try{let g=new Date(h.date+"T00:00:00");if(isNaN(g.getTime()))return!1;let y=r===null||g>=r,p=i===null||g<=i;return y&&p}catch(g){return console.warn("Error parsing session date during filter:",h.date,g),!1}}):[]},Z=function(){if(!D)return;let r=[...new Set(f.map(i=>i.project||"N/A"))].sort();D.innerHTML='<option value="All">All Projects</option>',r.forEach(i=>{if(i){let h=document.createElement("option");h.value=i,h.textContent=i,D.appendChild(h)}}),D.value=j,console.log("[Dashboard] Project filter populated.")},z=function(){let r=f;j!=="All"&&(r=f.filter(E=>(E.project||"N/A")===j)),r.sort((E,v)=>{let ee=new Date(`${E.date||""}T${E.start_time||""}`).getTime(),te=new Date(`${v.date||""}T${v.start_time||""}`).getTime(),De=isNaN(ee)?-1/0:ee;return(isNaN(te)?-1/0:te)-De});let i=r.length,h=Math.max(1,Math.ceil(i/C));w>h&&(w=h),w<1&&(w=1);let g=(w-1)*C,y=g+C;return{visibleSessions:r.slice(g,y),currentPage:w,totalPages:h}},x=function(){let{visibleSessions:r,currentPage:i,totalPages:h}=z();w=i,b(r,A),X&&(X.textContent=`Page ${w} of ${h}`),R&&(R.disabled=w<=1),W&&(W.disabled=w>=h),console.log(`[Dashboard] Session display refreshed. Page: ${w}/${h}, Filter: ${j}`)};var n=B,e=O,a=Z,t=z,s=x;let{updateCharts:o,destroyCharts:c}=await Promise.resolve().then(()=>(be(),ye)),{setupTabs:u,updateSessionsTable:b}=await Promise.resolve().then(()=>(Ee(),Ce)),f=[],l=[],d="1y",m="This Year",C=20,w=1,j="All",Y=document.querySelectorAll(".btn-filter"),J=document.getElementById("date-from"),G=document.getElementById("date-to"),ve=document.getElementById("apply-custom-date"),D=document.getElementById("project-filter-select"),R=document.getElementById("prev-page-btn"),W=document.getElementById("next-page-btn"),X=document.getElementById("page-info");window.onSessionsLoaded=function(r){if(console.log("[Dashboard] onSessionsLoaded called",r),typeof r=="string")try{r=JSON.parse(r)}catch(i){console.error("Failed to parse sessions JSON",i),r=[]}window.allSessions=r,f=r,A()},window.onProjectsLoaded=function(r){if(typeof r=="string")try{r=JSON.parse(r)}catch(i){console.error("Failed to parse projects JSON",i),r=[]}l=r,typeof T=="function"&&T()};async function Q(r){console.log(`[Dashboard] Date filter changed to: ${r}`);let i=null,h=null;if(r==="custom"&&(i=J.value,h=G.value,!i||!h)){alert("Please select both 'From' and 'To' dates for custom range.");return}let{startDate:g,endDate:y,rangeTitle:p}=B(r,i,h);if(p==="Invalid Range")return;let E=O(g,y);console.log(`[Dashboard] Filtered sessions count for chart "${p}": ${E.length}`),d=r,m=p,Y.forEach(v=>{v.dataset.range===r?v.classList.add("active"):v.classList.remove("active")}),r==="custom"&&Y.forEach(v=>{v.closest(".date-filter-buttons")&&v.classList.remove("active")});try{await o(E,f,p)}catch(v){console.error(`[Dashboard] Error updating charts for range ${r}:`,v)}}async function A(){console.log("[Dashboard] Refreshing dashboard data...");try{D.options.length<=1&&Z(),x();let r,i;d==="custom"?{startDate:r,endDate:i}=B(d,J.value,G.value):{startDate:r,endDate:i}=B(d);let h=O(r,i);await o(h,f,m)}catch(r){console.error("[Dashboard] Error refreshing dashboard data:",r)}}async function je(){console.log("[DEBUG] initProjectManagement called");let r=document.getElementById("projects-list"),i=document.getElementById("add-project-form");if(!r||!i){console.error("Project management elements not found");return}await T(),i.addEventListener("submit",async h=>{h.preventDefault();let g=document.getElementById("new-project-name"),y=document.getElementById("new-project-color");if(!(!g||!y))try{let p=await window.jujuApi.addProject({name:g.value.trim(),color:y.value});p&&p.success&&(g.value="",y.value="#4E79A7",await T(),await A())}catch(p){console.error("Error adding project:",p),alert("Failed to add project: "+p.message)}})}async function T(){let r=document.getElementById("projects-list");if(!r){console.error("Projects list element not found");return}try{r.innerHTML="",l.forEach(i=>{let h=document.createElement("div");h.className="project-item",h.innerHTML=`
                        <div class="project-info">
                            <span class="project-name">${i.name}</span>
                            <div class="project-color">
                                <input type="color" value="${i.color||"#4E79A7"}" 
                                       data-project-id="${i.id}">
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-delete" data-id="${i.id}" title="Delete Project" aria-label="Delete Project">&times;</button>
                        </div>
                    `;let g=h.querySelector('input[type="color"]');g&&g.addEventListener("change",async y=>{try{await window.jujuApi.updateProjectColor(i.id,y.target.value),window.jujuApi.loadProjects(),window.jujuApi.loadSessions()}catch(p){console.error("Error updating project color:",p),alert("Failed to update color: "+p.message)}}),r.appendChild(h)})}catch(i){console.error("Error loading projects:",i),r.innerHTML='<div class="error">Failed to load projects</div>'}}Y.forEach(r=>{r.closest(".date-filter-buttons")&&r.addEventListener("click",()=>Q(r.dataset.range))}),ve.addEventListener("click",()=>Q("custom")),D?.addEventListener("change",r=>{j=r.target.value,w=1,x()}),R?.addEventListener("click",()=>{w>1&&(w--,x())}),W?.addEventListener("click",()=>{let{totalPages:r}=z();w<r&&(w++,x())}),document.getElementById("projects-list").addEventListener("click",function(r){if(r.target.classList.contains("btn-delete")){console.log("[Dashboard] Project delete button clicked",r.target.dataset.id);let i=r.target,h=i.dataset.id,g=l.find(p=>String(p.id)===String(h));if(!g||!confirm(`Are you sure you want to delete ${g.name}?`))return;i.disabled=!0;let y=i.innerHTML;if(i.innerHTML='<span class="spinner"></span>',console.log("[Dashboard] Entering deleteProject .then() block"),typeof window.jujuApi.deleteProject!="function"){alert("window.jujuApi.deleteProject is not a function!"),i.disabled=!1,i.innerHTML=y;return}window.jujuApi.deleteProject(h).then(p=>{if(console.log("[Dashboard] window.jujuApi.deleteProject returned",p),p&&p.success)T(),A();else{let E=p&&p.error?p.error:"Unknown error";alert("Failed to delete project: "+E),console.error("Error deleting project:",E),i.disabled=!1,i.innerHTML=y}}).catch(p=>{alert("Error calling window.jujuApi.deleteProject: "+(p&&p.message?p.message:p)),console.error("[Dashboard] Error in deleteProject handler:",p),i.disabled=!1,i.innerHTML=y})}}),u(),console.log("Calling window.jujuApi.loadProjects and loadSessions"),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),await je(),await A()}catch(o){console.error("[Dashboard] Error initializing dashboard:",o);let c=document.getElementById("charts");c&&(c.innerHTML=`<div class="error-message">Failed to initialize dashboard. Please check console for details. Error: ${o.message}</div>`)}});})();
