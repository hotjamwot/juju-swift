(()=>{var Ye=Object.defineProperty;var S=(o,e)=>()=>(o&&(e=o(o=0)),e);var ee=(o,e)=>{for(var n in e)Ye(o,n,{get:e[n],enumerable:!0})};var te,T,Y,he,me=S(()=>{te=["#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F","#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#E494A6","#F1A861","#86BCB6","#A8A07D","#B881A3"],T={grid:{display:!0,color:"rgba(224, 224, 224, 0.1)"},ticks:{color:"#E0E0E0",font:{size:11},padding:5}},Y={display:!0,position:"top",labels:{color:"#E0E0E0",font:{size:12},padding:15}},he={callbacks:{label:function(o){let e=o.dataset,n=o.raw;return`${e.label}: ${n.toFixed(1)} hours`}}}});async function Oe(){let o=Date.now();if(!U||o-pe>Ue)try{U=await window.jujuApi.loadProjects(),pe=o}catch(e){console.warn("Error loading projects:",e),U=[]}return U}async function Re(o,e){let t=(await Oe()).find(a=>a.name===o);return t&&t.color?t.color:te[e%te.length]}async function O(o){let e=[];for(let n=0;n<o.length;n++)e.push(await Re(o[n],n));return e}async function ge(o,e,n,t,a=null){let i=document.getElementById(o);if(!i)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;if(!e.length||!n.length||n.every(g=>!g.data.length)){let g=i.getContext("2d");return g.save(),g.textAlign="center",g.textBaseline="middle",g.fillStyle="#888888",g.font="14px Poppins",g.fillText("No data available for this period",i.width/2,i.height/2),g.restore(),null}let c=i.getContext("2d"),l=n.filter(g=>g.data.some(s=>s>0)),m=l.map(g=>g.label),E=await O(m);return l.forEach((g,s)=>{g.backgroundColor=E[s],g.borderRadius=8}),new Chart(c,{type:"bar",data:{labels:e,datasets:l},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:0,bottom:0,left:0,right:0}},animation:R,scales:{x:{stacked:!0,...T,grid:{display:!1},border:{color:"#444",width:2},ticks:{...T.ticks,callback:function(g,s){if(!e||s>=e.length)return"";let h=e[s];if(a&&a[h])return a[h];if(a&&h&&h.includes("-"))try{let w=new Date(h+"T00:00:00");return!isNaN(w.getTime())&&w.getDate()!==1?w.toLocaleDateString("en-US",{month:"numeric",day:"numeric"}):""}catch{return h}return h}}},y:{stacked:!0,...T,grid:{display:!1},border:{color:"#444",width:2},title:{display:!0,text:t,color:"#E0E0E0"}}},plugins:{legend:Y,tooltip:he,softShadow:!0}}})}async function ye(o,e,n){let t=document.getElementById(o);if(!t)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let a=t.getContext("2d"),i=.01,c=[],l=[];if(e.forEach((E,g)=>{n[g]>=i&&(c.push(E),l.push(n[g]))}),c.length===0)return console.log(`[Charts] No significant data for pie chart ${o}.`),null;let m=await O(c);return new Chart(a,{type:"pie",data:{labels:c,datasets:[{data:l,backgroundColor:m,borderColor:"#1E1E1E",borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,animation:R,plugins:{legend:{...Y,position:"top"},tooltip:{callbacks:{label:function(E){let g=E.label||"",s=E.parsed||0,h=E.chart.data.datasets[0].data.reduce((b,D)=>b+D,0),w=h>0?(s/h*100).toFixed(1):0;return`${g}: ${s.toFixed(1)} hours (${w}%)`}}},softShadow:!0},hover:{mode:"nearest",animationDuration:400,onHover:(E,g)=>{}},elements:{arc:{hoverOffset:18,borderWidth:0}}}})}async function we(o,e,n="Weekly Hours by Project"){let t=document.getElementById(o).getContext("2d"),a=await O(e.datasets.map(c=>c.label)),i=e.datasets.map((c,l)=>({...c,backgroundColor:a[l],borderColor:a[l],fill:!0,tension:.4,borderWidth:1,pointRadius:0,pointHoverRadius:0}));return new Chart(t,{type:"line",data:{labels:e.labels,datasets:i},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},animation:R,scales:{y:{stacked:!0,...T,grid:{display:!1},border:{color:"#444",width:2},title:{display:!0,text:"Hours",color:"#E0E0E0"}},x:{...T,grid:{display:!1},border:{color:"#444",width:2}}},plugins:{title:{display:!0,text:n,color:"#E0E0E0",padding:{bottom:15}},legend:{...Y,position:"bottom"},tooltip:{callbacks:{label:function(c){let l=c.dataset.label||"";return l&&(l+=": "),c.parsed.y!==null&&(l+=c.parsed.y.toFixed(1)+" hours"),l}}},softShadow:!0}}})}async function Ee(o,e,n){let t=document.getElementById(o);if(!t)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;let a=t.getContext("2d"),i=await O(e);return new Chart(a,{type:"bar",data:{labels:e,datasets:[{label:"Total Hours",data:n,backgroundColor:i,borderColor:"#1E1E1E",borderWidth:1,borderRadius:6,maxBarThickness:48}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:10,bottom:10,left:10,right:10}},animation:R,scales:{x:{grid:{display:!1},border:{color:"#444",width:2},ticks:{color:"#E0E0E0",font:{size:12},autoSkip:!1}},y:{beginAtZero:!0,grid:{display:!1},border:{color:"#444",width:2},title:{display:!0,text:"Total Hours",color:"#E0E0E0"},ticks:{color:"#E0E0E0",font:{size:12}}}},plugins:{legend:{display:!1},title:{display:!0,text:"Total Hours by Project",color:"#E0E0E0",padding:{bottom:10}},tooltip:{callbacks:{label:function(c){return`${c.label}: ${c.parsed.y.toFixed(1)} hours`}}},softShadow:!0}}})}var U,pe,Ue,ze,R,ve=S(()=>{me();U=null,pe=0,Ue=5e3;ze={id:"softShadow",beforeDatasetsDraw(o,e,n){let t=o.ctx;t.save(),t.shadowColor="rgba(0,0,0,0.55)",t.shadowBlur=32,t.shadowOffsetX=0,t.shadowOffsetY=14},afterDatasetsDraw(o,e,n){o.ctx.restore()}};typeof Chart<"u"&&!Chart.registry.plugins.get("softShadow")&&Chart.register(ze);R={duration:600,easing:"easeOutCubic"}});function be(o){let e=parseInt(String(o),10);if(o==null||isNaN(e)||e<0)return"?";let n=Math.floor(e/60),t=e%60;return`${n}h ${t}m`}function Ce(o){o=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate())),o.setUTCDate(o.getUTCDate()+4-(o.getUTCDay()||7));var e=new Date(Date.UTC(o.getUTCFullYear(),0,1)),n=Math.ceil(((o.getTime()-e.getTime())/864e5+1)/7);return n}var ne=S(()=>{});function je(o){if(!o||o.length===0)return console.log("[Charts] No sessions for daily breakdown chart."),{labels:[],monthLabels:{},datasets:[]};let e={},n=new Set,t=null,a=null;if(o.forEach(s=>{let h=s.date;try{let w=new Date(h+"T00:00:00");if(!h||isNaN(w.getTime()))return;(t===null||w<t)&&(t=w),(a===null||w>a)&&(a=w);let b=s.project||"Unassigned";n.add(b);let D=(s.duration_minutes||0)/60;e[h]||(e[h]={}),e[h][b]=(e[h][b]||0)+D}catch{}}),t===null||a===null)return{labels:[],monthLabels:{},datasets:[]};let i=[],c={},l=new Date(t);for(new Date().setHours(0,0,0,0);l<=a;){let s=l.getFullYear(),h=(l.getMonth()+1).toString().padStart(2,"0"),w=l.getDate().toString().padStart(2,"0"),b=`${s}-${h}-${w}`;i.push(b),l.getDate()===1&&(c[b]=l.toLocaleDateString("en-GB",{month:"short"})),l.setDate(l.getDate()+1)}let g=Array.from(n).sort().map(s=>({label:s,data:i.map(h=>e[h]?.[s]||0),backgroundColor:"#000000"}));return{labels:i,monthLabels:c,datasets:g}}function De(o){if(!o||o.length===0)return console.log("[Charts] No sessions for weekly chart."),{labels:[],datasets:[]};let e={},n=new Set,t=new Set;o.forEach(l=>{try{let m=new Date(l.date+"T00:00:00");if(isNaN(m.getTime()))return;let E=m.getFullYear(),g=Ce(m),s=`${E}-W${g.toString().padStart(2,"0")}`;t.add(s);let h=l.project||"Unassigned";n.add(h);let w=(l.duration_minutes||0)/60;e[s]||(e[s]={}),e[s][h]=(e[s][h]||0)+w}catch{}});let a=Array.from(t).sort(),c=Array.from(n).sort().map(l=>{let m=a.map(E=>e[E]?.[l]||0);return{label:l,data:m,backgroundColor:"#000000",borderWidth:2,fill:!0}});return{labels:a,datasets:c.reverse()}}function ke(o){let e={};o.forEach(a=>{let i=a.project||"Unassigned";e[i]=(e[i]||0)+(a.duration_minutes||0)});let n=Object.keys(e).sort(),t=n.map(a=>e[a]/60);return{labels:n,data:t}}var Le=S(()=>{ne()});var Se={};ee(Se,{destroyCharts:()=>xe,updateCharts:()=>Ke});function qe(){if(typeof Chart>"u")throw new Error("Chart.js is not loaded. Cannot create charts.")}function xe(){B&&B.destroy(),N&&N.destroy(),P&&P.destroy(),oe&&oe.destroy(),ae&&ae.destroy(),re&&re.destroy(),z&&z.destroy(),B=N=P=null,oe=ae=re=null,z=null,console.log("[Charts] Destroyed existing chart instances.")}async function Ke(o,e,n){try{qe();let t=document.getElementById("chart-range-title");if(t&&(t.textContent=`Showing data for: ${n}`),xe(),console.log("[Charts] Called destroyCharts before creating new charts."),!o||o.length===0)return console.log("[Charts] No filtered session data for main charts."),{yearlyChart:null,weeklyChart:null,pieChart:null};console.log(`[Charts] Updating main charts for "${n}" with ${o.length} sessions.`);try{let a=je(o);B=await ge("yearly-chart",a.labels,a.datasets,"Hours",a.monthLabels);let i=De(o);N=await we("weekly-chart",i,"Weekly Hours by Project");let c=ke(o);return P=await ye("pie-chart",c.labels,c.data),z=await Ee("project-bar-chart",c.labels,c.data),{yearlyChart:B,weeklyChart:N,pieChart:P}}catch(a){return console.error("[Charts] Error creating charts:",a),{yearlyChart:null,weeklyChart:null,pieChart:null}}}catch(t){return console.error("[Charts] Error updating charts:",t),{yearlyChart:null,weeklyChart:null,pieChart:null}}}var B,N,P,oe,ae,re,z,Ae=S(()=>{ve();Le();B=null,N=null,P=null,oe=null,ae=null,re=null,z=null});var Te={};ee(Te,{default:()=>L});var ie,Ve,L,se=S(()=>{ie=class{constructor(){this.events={},this.notificationContainer=null,this.modal=null,this.init()}init(){this.notificationContainer=document.getElementById("notification-container"),this.modal=document.getElementById("confirmation-modal"),this.setupModalListeners()}on(e,n){this.events[e]||(this.events[e]=[]),this.events[e].push(n)}off(e,n){if(!this.events[e])return;let t=this.events[e].indexOf(n);t>-1&&this.events[e].splice(t,1)}emit(e,n){this.events[e]&&this.events[e].forEach(t=>{try{t(n)}catch(a){console.error(`Error in event handler for ${e}:`,a)}})}showNotification(e,n,t,a=5e3){if(!this.notificationContainer)return;let i=document.createElement("div");i.className=`notification ${e}`;let c=this.getNotificationIcon(e);return i.innerHTML=`
            <div class="notification-icon">${c}</div>
            <div class="notification-content">
                <div class="notification-title">${n}</div>
                <div class="notification-message">${t}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
        `,this.notificationContainer.appendChild(i),setTimeout(()=>i.classList.add("show"),10),a>0&&setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),300)},a),i}getNotificationIcon(e){return{success:"\u2713",error:"\u2715",warning:"\u26A0",info:"\u2139"}[e]||"\u2139"}showConfirmation(e,n,t,a){return this.modal?new Promise((i,c)=>{let l=document.getElementById("modal-title"),m=document.getElementById("modal-message"),E=document.getElementById("modal-confirm"),g=document.getElementById("modal-cancel"),s=document.getElementById("modal-close");l&&(l.textContent=e),m&&(m.textContent=n);let h=()=>{this.hideModal(),b(),t&&t(),i(!0)},w=()=>{this.hideModal(),b(),a&&a(),i(!1)},b=()=>{E.removeEventListener("click",h),g.removeEventListener("click",w),s.removeEventListener("click",w),this.modal.removeEventListener("click",D)},D=$=>{$.target===this.modal&&w()};E.addEventListener("click",h),g.addEventListener("click",w),s.addEventListener("click",w),this.modal.addEventListener("click",D),this.showModal()}):Promise.reject("Modal not found")}showModal(){this.modal&&(this.modal.classList.add("show"),document.body.style.overflow="hidden")}hideModal(){this.modal&&(this.modal.classList.remove("show"),document.body.style.overflow="")}setupModalListeners(){this.modal&&document.addEventListener("keydown",e=>{e.key==="Escape"&&this.modal.classList.contains("show")&&this.hideModal()})}async deleteWithConfirmation(e,n,t,a){let i=`Delete ${e}`,c=`Are you sure you want to delete "${t}"? This action cannot be undone.`;if(!await this.showConfirmation(i,c))return{success:!1,cancelled:!0};try{let m=await a(n);if(m&&m.success)return this.showNotification("success","Deleted",`${e} "${t}" has been deleted successfully.`),this.emit(`${e.toLowerCase()}Deleted`,{id:n,name:t}),{success:!0};{let E=m&&m.error?m.error:"Unknown error occurred";return this.showNotification("error","Delete Failed",`Failed to delete ${e.toLowerCase()}: ${E}`),{success:!1,error:E}}}catch(m){return this.showNotification("error","Delete Failed",`An error occurred while deleting the ${e.toLowerCase()}.`),{success:!1,error:m.message}}}async deleteSessionWithFallback(e,n){let t=[async a=>{if(window.jujuApi&&typeof window.jujuApi.deleteSession=="function")return await window.jujuApi.deleteSession(a);throw new Error("Delete API not available")},async a=>await this.manualDeleteSession(a)];for(let a=0;a<t.length;a++)try{let i=await this.deleteWithConfirmation("Session",e,n,t[a]);if(i.success||i.cancelled)return i}catch(i){if(a===t.length-1)throw i}}async deleteProjectWithFallback(e,n){let t=[async a=>{if(window.jujuApi&&typeof window.jujuApi.deleteProject=="function")return await window.jujuApi.deleteProject(a);throw new Error("Delete API not available")},async a=>await this.manualDeleteProject(a)];for(let a=0;a<t.length;a++)try{let i=await this.deleteWithConfirmation("Project",e,n,t[a]);if(i.success||i.cancelled)return i}catch(i){if(a===t.length-1)throw i}}async manualDeleteSession(e){throw new Error("Manual session deletion not implemented")}async manualDeleteProject(e){throw new Error("Manual project deletion not implemented")}},Ve=new ie,L=Ve});var Ie={};ee(Ie,{setupTabs:()=>Je,updateSessionsTable:()=>Xe});function Je(){document.querySelectorAll(".tab").forEach(o=>{o.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),o.classList.add("active");let e=o.dataset.tab,n=document.getElementById(e);n&&n.classList.add("active")})})}function Xe(o,e){if(q){if(q.innerHTML="",!o||o.length===0){q.innerHTML=`
            <tr><td colspan="7" class="no-data">No sessions match the current filter or page.</td></tr>`;return}o.forEach(n=>{let t=document.createElement("tr");t.setAttribute("data-session-key",`${n.id}-${n.date}-${n.start_time}`);let a="Invalid Date";try{let s=new Date(n.date+"T00:00:00");if(!isNaN(s.getTime())){let h=s.getFullYear(),w=(s.getMonth()+1).toString().padStart(2,"0"),b=s.getDate().toString().padStart(2,"0");a=`${h}-${w}-${b}`}}catch{}let i=typeof n.start_time=="string"?n.start_time.slice(0,5):"??:??",c=typeof n.end_time=="string"?n.end_time.slice(0,5):"??:??",l=n.project||"N/A",m=n.notes||"",E=n.mood!==void 0&&n.mood!==null&&n.mood!==""?String(n.mood):"",g=`${l} on ${a}`;t.innerHTML=`
            <td class="editable" data-field="date" data-id="${n.id}">${a}</td>
            <td class="editable" data-field="project" data-id="${n.id}">${l}</td>
            <td data-field="duration_minutes" data-id="${n.id}">${be(n.duration_minutes)}</td>
            <td class="editable" data-field="start_time" data-id="${n.id}">${i}</td>
            <td class="editable" data-field="end_time" data-id="${n.id}">${c}</td>
            <td class="editable" data-field="notes" data-id="${n.id}">${m}</td>
            <td class="editable" data-field="mood" data-id="${n.id}">${E}</td>
            <td class="actions">
                <button class="btn btn-delete" data-id="${n.id}" data-info="${g}" title="Delete Session">\xD7</button>
            </td>
        `,q.appendChild(t)}),Ge(e),et(e)}}function Ge(o){document.querySelectorAll("#recent-sessions-body td.editable").forEach(e=>{let n=Qe.bind(e,o);e.removeEventListener("click",e._boundHandleCellClick),e.addEventListener("click",n),e._boundHandleCellClick=n})}async function Qe(o){if(this.querySelector("input, textarea, select"))return;let e=this.textContent,n=this.dataset.field;this.setAttribute("data-original-value",e);let t;if(n==="project"){t=document.createElement("select"),t.classList.add("inline-edit-input"),t.style.width="100%",t.style.height="100%";try{let c=await window.jujuApi.getProjectNames();t.innerHTML="";let l=document.createElement("option");l.value="",l.text="-- Select Project --",t.add(l),c.forEach(m=>{let E=document.createElement("option");E.value=m,E.text=m,m===e&&(E.selected=!0),t.add(E)})}catch{L.showNotification("error","Error","Failed to load project names")}}else if(n==="start_time"||n==="end_time")t=document.createElement("input"),t.type="time",t.value=/^\d{2}:\d{2}$/.test(e)?e:"00:00";else if(n==="date")t=document.createElement("input"),t.type="date",t.value=/^\d{4}-\d{2}-\d{2}$/.test(e)?e:new Date().toISOString().slice(0,10);else if(n==="notes")t=document.createElement("textarea"),t.value=e,t.rows=2;else if(n==="mood"){t=document.createElement("select"),t.classList.add("inline-edit-input"),t.style.width="100%",t.style.height="2em";let c=document.createElement("option");c.value="",c.text="--",t.appendChild(c);for(let l=0;l<=10;l++){let m=document.createElement("option");m.value=l,m.text=l,String(l)===e&&(m.selected=!0),t.appendChild(m)}this.innerHTML="",this.appendChild(t),t.focus()}else t=document.createElement("input"),t.type="text",t.value=e;t.classList.add("inline-edit-input"),t.style.width="100%",t.style.boxSizing="border-box",t.tagName==="TEXTAREA"&&(t.rows=1,t.style.resize="none",t.style.minHeight="32px",t.style.maxHeight="80px",t.style.lineHeight="1.4"),this.innerHTML="",this.appendChild(t),t.focus(),t.type==="text"&&t.select();let a=$e.bind(t,o),i=Ze.bind(t,o);t.addEventListener("blur",a),t.addEventListener("keydown",i),t._boundBlurHandler=a,t._boundKeydownHandler=i}async function Ze(o,e){if(e.key==="Enter"){if(this.tagName==="TEXTAREA"&&e.shiftKey)return;e.preventDefault(),await $e.call(this,o)}else if(e.key==="Escape"){let n=this.parentElement,t=n.getAttribute("data-original-value");this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),n.textContent=t,n.removeAttribute("data-original-value")}}async function $e(o){let e=this.parentElement;if(!e||!e.dataset){this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler);try{this.remove()}catch{}return}let n=this.value.trim(),t=e.getAttribute("data-original-value"),a=e.dataset.id,i=e.dataset.field;if(this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),n===t){e.textContent=t,e.removeAttribute("data-original-value");return}try{let c=await window.jujuApi.updateSession(a,i,n);e.classList.add("success"),setTimeout(()=>e.classList.remove("success"),1e3),L.showNotification("success","Updated",`Session ${i} updated successfully`),window.jujuApi&&typeof window.jujuApi.loadSessions=="function"?window.jujuApi.loadSessions():typeof o=="function"&&o()}catch(c){e.classList.add("error"),setTimeout(()=>e.classList.remove("error"),1200),e.textContent=t,L.showNotification("error","Update Failed",`Failed to update session: ${c.message}`)}finally{e.removeAttribute("data-original-value")}}function et(o){document.querySelectorAll("#recent-sessions-body .btn-delete").forEach(e=>{e._boundDeleteHandler&&e.removeEventListener("click",e._boundDeleteHandler);let n=async t=>{t.preventDefault(),t.stopPropagation();let a=t.target.dataset.id,i=t.target.dataset.info||`Session ${a}`;if(!a){L.showNotification("error","Error","Session ID not found");return}try{let c=await L.deleteSessionWithFallback(a,i);c.success?typeof o=="function"&&o():c.cancelled||console.error("Session deletion failed:",c.error)}catch{L.showNotification("error","Delete Failed","An unexpected error occurred while deleting the session")}};e.addEventListener("click",n),e._boundDeleteHandler=n})}var q,Be=S(()=>{ne();se();q=document.getElementById("recent-sessions-body")});document.addEventListener("DOMContentLoaded",async()=>{try{let X=function(r,d=null,p=null){let f=new Date;f.setHours(0,0,0,0);let y=new Date(f),u=new Date(f);u.setHours(23,59,59,999);let v="";switch(r){case"7d":y.setDate(f.getDate()-6),v="Last 7 Days";break;case"1m":y=new Date(f.getFullYear(),f.getMonth()-1,f.getDate()),v="Last Month";break;case"3m":y=new Date(f.getFullYear(),f.getMonth()-3,f.getDate()),v="Last Quarter";break;case"1y":y=new Date(f.getFullYear(),0,1),v="This Year";break;case"all":y=null,u=null,v="All Time";break;case"custom":try{if(y=d?new Date(d+"T00:00:00"):null,u=p?new Date(p+"T23:59:59.999"):null,y&&u&&y>u)return s.showNotification("warning","Invalid Range","Start date cannot be after end date."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"};v=`Custom (${d||"..."} - ${p||"..."})`}catch{return s.showNotification("error","Invalid Date","Invalid custom date format."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"}}break;default:y=new Date(f.getFullYear(),0,1),v="This Year"}return y&&!(y instanceof Date&&!isNaN(y))&&(y=null),u&&!(u instanceof Date&&!isNaN(u))&&(u=null),{startDate:y,endDate:u,rangeTitle:v}},G=function(r,d){return h?r===null&&d===null?[...h]:h.filter(p=>{try{let f=new Date(p.date+"T00:00:00");if(isNaN(f.getTime()))return!1;let y=r===null||f>=r,u=d===null||f<=d;return y&&u}catch{return!1}}):[]},_=function(){if(!I)return;let r=I.value;I.innerHTML='<option value="All">All Projects</option>',w&&w.length>0&&w.forEach(d=>{let p=document.createElement("option");p.value=d.name,p.textContent=d.name,d.name===r&&(p.selected=!0),I.appendChild(p)})},de=function(){let r=H?.value||null,d=M?.value||null;return{start:r,end:d}},ue=function(){let r=[...h];F&&F!=="All"&&(r=r.filter(f=>f.project===F));let{start:d,end:p}=de();return d&&(r=r.filter(f=>f.date>=d)),p&&(r=r.filter(f=>f.date<=p)),r},W=function(){let r=ue();r.sort((u,v)=>{try{let C=u.start_time||"00:00",Q=v.start_time||"00:00",Z=new Date(`${u.date}T${C}`),fe=new Date(`${v.date}T${Q}`);if(isNaN(Z.getTime())||isNaN(fe.getTime())){let We=new Date(u.date+"T00:00:00");return new Date(v.date+"T00:00:00")-We}return fe.getTime()-Z.getTime()}catch{let Q=new Date(u.date+"T00:00:00");return new Date(v.date+"T00:00:00")-Q}});let d=Math.ceil(r.length/$),p=(j-1)*$,f=p+$;return{visibleSessions:r.slice(p,f),totalPages:d,filteredSessions:r}},k=function(){let{visibleSessions:r,totalPages:d}=W();g(r,x),le&&(le.textContent=`Page ${j} of ${d}`),V&&(V.disabled=j<=1),J&&(J.disabled=j>=d)};var o=X,e=G,n=_,t=de,a=ue,i=W,c=k;let{updateCharts:l,destroyCharts:m}=await Promise.resolve().then(()=>(Ae(),Se)),{setupTabs:E,updateSessionsTable:g}=await Promise.resolve().then(()=>(Be(),Ie)),s=await Promise.resolve().then(()=>(se(),Te)).then(r=>r.default),h=[],w=[],b="1y",D="This Year",$=20,j=1,F="All",K=document.querySelectorAll(".btn-filter"),Ne=document.getElementById("date-from"),Pe=document.getElementById("date-to"),Fe=document.getElementById("apply-custom-date"),I=document.getElementById("project-filter-select"),V=document.getElementById("prev-page-btn"),J=document.getElementById("next-page-btn"),le=document.getElementById("page-info"),H=document.getElementById("session-filter-start-date"),M=document.getElementById("session-filter-end-date"),He=document.getElementById("export-sessions-btn"),Me=document.getElementById("session-clear-dates-btn");window.onSessionsLoaded=function(r){if(typeof r=="string")try{r=JSON.parse(r)}catch{r=[]}window.allSessions=r,h=r,x()},window.onProjectsLoaded=function(r){if(typeof r=="string")try{r=JSON.parse(r)}catch{r=[]}w=r,_(),typeof A=="function"&&A()};async function ce(r){let d=null,p=null;if(r==="custom"&&(d=Ne.value,p=Pe.value,!d||!p)){s.showNotification("warning","Invalid Range",'Please select both "From" and "To" dates for custom range.');return}let{startDate:f,endDate:y,rangeTitle:u}=X(r,d,p);if(u==="Invalid Range")return;let v=G(f,y);b=r,D=u,K.forEach(C=>{C.dataset.range===r?C.classList.add("active"):C.classList.remove("active")}),r==="custom"&&K.forEach(C=>{C.closest(".date-filter-buttons")&&C.classList.remove("active")});try{await l(v,h,u)}catch{s.showNotification("error","Chart Error","Failed to update charts")}}async function x(){if(!h)return;let{startDate:r,endDate:d}=X(b),p=G(r,d);try{await l(p,h,D)}catch{s.showNotification("error","Chart Error","Failed to update charts")}_(),k()}async function _e(){let r=document.getElementById("projects-list"),d=document.getElementById("add-project-form");!r||!d||(await A(),d.addEventListener("submit",async p=>{p.preventDefault();let f=document.getElementById("new-project-name"),y=document.getElementById("new-project-color");if(!(!f||!y))try{let u=await window.jujuApi.addProject({name:f.value.trim(),color:y.value});u&&u.success&&(f.value="",y.value="#4E79A7",await A(),await x(),s.showNotification("success","Project Added",`Project "${f.value.trim()}" created successfully`))}catch(u){s.showNotification("error","Add Failed",`Failed to add project: ${u.message}`)}}))}async function A(){let r=document.getElementById("projects-list");if(r)try{r.innerHTML="",w.forEach(d=>{let p=document.createElement("div");p.className="project-item",p.innerHTML=`
                        <div class="project-info">
                            <span class="project-name">${d.name}</span>
                            <div class="project-color">
                                <input type="color" value="${d.color||"#4E79A7"}" 
                                       data-project-id="${d.id}">
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-delete" data-id="${d.id}" data-name="${d.name}" title="Delete Project" aria-label="Delete Project">&times;</button>
                        </div>
                    `;let f=p.querySelector('input[type="color"]');f&&f.addEventListener("change",async y=>{try{await window.jujuApi.updateProjectColor(d.id,y.target.value),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),s.showNotification("success","Color Updated",`Project "${d.name}" color updated`)}catch(u){s.showNotification("error","Update Failed",`Failed to update color: ${u.message}`)}}),r.appendChild(p)}),_()}catch{r.innerHTML='<div class="error">Failed to load projects</div>',s.showNotification("error","Load Failed","Failed to load projects")}}K.forEach(r=>{r.closest(".date-filter-buttons")&&r.addEventListener("click",()=>ce(r.dataset.range))}),Fe.addEventListener("click",()=>ce("custom")),I?.addEventListener("change",r=>{F=r.target.value,j=1,k()}),V?.addEventListener("click",()=>{j>1&&(j--,k())}),J?.addEventListener("click",()=>{let{totalPages:r}=W();j<r&&(j++,k())}),Me?.addEventListener("click",()=>{H&&(H.value=""),M&&(M.value=""),j=1,k()}),document.getElementById("projects-list").addEventListener("click",async function(r){if(r.target.classList.contains("btn-delete")){r.preventDefault(),r.stopPropagation();let d=r.target,p=d.dataset.id,f=d.dataset.name||`Project ${p}`;if(!p){s.showNotification("error","Error","Project ID not found");return}try{let y=await s.deleteProjectWithFallback(p,f);y.success?(await A(),await x(),window.jujuApi&&typeof window.jujuApi.refreshMenu=="function"&&window.jujuApi.refreshMenu()):y.cancelled||console.error("Project deletion failed:",y.error)}catch{s.showNotification("error","Delete Failed","An unexpected error occurred while deleting the project")}}}),H?.addEventListener("change",()=>{j=1,k()}),M?.addEventListener("change",()=>{j=1,k()}),He?.addEventListener("click",()=>{let{filteredSessions:r}=W();if(!r.length){s.showNotification("warning","No Data","No sessions to export for the current filter.");return}let d=Object.keys(r[0]).filter(u=>u!=="id");d.includes("mood")||r.some(u=>"mood"in u)&&d.push("mood");let p=r.map(u=>{let v={};return d.forEach(C=>{v[C]=u[C]??""}),v}),f=document.getElementById("export-format-select"),y=f?f.value:"txt";window.jujuApi.exportSessions({sessions:p,fields:d,format:y}).then(u=>{u&&u.success?s.showNotification("success","Exported","Sessions exported successfully."):s.showNotification("error","Export Failed",u&&u.error?u.error:"Unknown error")}).catch(u=>{s.showNotification("error","Export Failed",u&&u.message?u.message:"Unknown error")})}),E(),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),await _e(),await x(),s.on("sessionDeleted",()=>{x()}),s.on("projectDeleted",()=>{A(),x()})}catch(l){eventSystem&&eventSystem.showNotification("error","Initialization Failed","Failed to initialize dashboard. Please check console for details.");let m=document.getElementById("charts");m&&(m.innerHTML=`<div class="error-message">Failed to initialize dashboard. Please check console for details. Error: ${l.message}</div>`)}});})();
