(()=>{var $e=Object.defineProperty;var $=(r,e)=>()=>(r&&(e=r(r=0)),e);var K=(r,e)=>{for(var o in e)$e(r,o,{get:e[o],enumerable:!0})};var J,I,F,oe,ne=$(()=>{J=["#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F","#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#E494A6","#F1A861","#86BCB6","#A8A07D","#B881A3"],I={grid:{display:!0,color:"rgba(224, 224, 224, 0.1)"},ticks:{color:"#E0E0E0",font:{size:11},padding:5}},F={display:!0,position:"top",labels:{color:"#E0E0E0",font:{size:12},padding:15}},oe={callbacks:{label:function(r){let e=r.dataset,o=r.raw;return`${e.label}: ${o.toFixed(1)} hours`}}}});async function Ie(){let r=Date.now();if(!N||r-ae>xe)try{N=await window.jujuApi.loadProjects(),ae=r}catch(e){console.warn("Error loading projects:",e),N=[]}return N}async function Se(r,e){let t=(await Ie()).find(a=>a.name===r);return t&&t.color?t.color:J[e%J.length]}async function G(r){let e=[];for(let o=0;o<r.length;o++)e.push(await Se(r[o],o));return e}async function re(r,e,o,t,a=null){let n=document.getElementById(r);if(!n)return console.error(`Canvas element with ID ${r} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;if(!e.length||!o.length||o.every(s=>!s.data.length)){let s=n.getContext("2d");return s.save(),s.textAlign="center",s.textBaseline="middle",s.fillStyle="#888888",s.font="14px Poppins",s.fillText("No data available for this period",n.width/2,n.height/2),s.restore(),null}let i=n.getContext("2d"),d=o.filter(s=>s.data.some(c=>c>0)),f=d.map(s=>s.label),u=await G(f);return d.forEach((s,c)=>{s.backgroundColor=u[c]}),new Chart(i,{type:"bar",data:{labels:e,datasets:d},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:0,bottom:0,left:0,right:0}},scales:{x:{stacked:!0,...I,ticks:{...I.ticks,callback:function(s,c){if(!e||c>=e.length)return"";let m=e[c];if(a&&a[m])return a[m];if(a&&m&&m.includes("-"))try{let b=new Date(m+"T00:00:00");return!isNaN(b.getTime())&&b.getDate()!==1?b.toLocaleDateString("en-US",{month:"numeric",day:"numeric"}):""}catch{return m}return m}}},y:{stacked:!0,...I,title:{display:!0,text:t,color:"#E0E0E0"}}},plugins:{legend:F,tooltip:oe}}})}function M(r,e,o,t=3){let a=document.getElementById(r);if(!a)return console.error(`Canvas element with ID ${r} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let n=a.getContext("2d");if(!e||!o||e.length!==4||o.length!==4)return console.warn(`[Charts] Invalid data for multi-bar comparison chart ${r}. Expected 4 labels and 4 values.`),n.save(),n.textAlign="center",n.textBaseline="middle",n.fillStyle="#888888",n.font="12px Poppins",n.fillText("Invalid data",a.width/2,a.height/2),n.restore(),null;let i="rgba(78, 121, 167, 0.4)",d="#F28E2B",f=o.map((s,c)=>c===t?d:i),u=o.map((s,c)=>c===t?d:"#4E79A7");return new Chart(n,{type:"bar",data:{labels:e,datasets:[{label:"Hours",data:o,backgroundColor:f,borderColor:u,borderWidth:1,barPercentage:1,categoryPercentage:.9}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:2,bottom:2,left:20,right:15}},scales:{x:{beginAtZero:!0,position:"top",grid:{display:!1,drawBorder:!1},ticks:{color:"#888888",font:{size:10},maxTicksLimit:4,padding:2,callback:s=>s.toFixed(1)+"h"}},y:{grid:{display:!1,drawBorder:!1},ticks:{color:"#CCCCCC",font:{size:11},padding:4,maxRotation:0,minRotation:0,autoSkip:!1,callback:function(s,c){return this.getLabelForValue(s).replace(/(Sun|Mon|Tue|Wed|Thu|Fri|Sat)day/,"$1").replace(" Weeks Ago","w ago").replace(" Months Ago","m ago")}}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,callbacks:{title:function(s){return s[0].label},label:function(s){return`Hours: ${s.parsed.x.toFixed(1)}`}}}}}})}async function se(r,e,o){let t=document.getElementById(r);if(!t)return console.error(`Canvas element with ID ${r} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let a=t.getContext("2d"),n=.01,i=[],d=[];if(e.forEach((u,s)=>{o[s]>=n&&(i.push(u),d.push(o[s]))}),i.length===0)return console.log(`[Charts] No significant data for pie chart ${r}.`),null;let f=await G(i);return new Chart(a,{type:"pie",data:{labels:i,datasets:[{data:d,backgroundColor:f,borderColor:"#1E1E1E",borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{...F,position:"top"},tooltip:{callbacks:{label:function(u){let s=u.label||"",c=u.parsed||0,m=u.chart.data.datasets[0].data.reduce((E,v)=>E+v,0),b=m>0?(c/m*100).toFixed(1):0;return`${s}: ${c.toFixed(1)} hours (${b}%)`}}}}}})}async function ie(r,e){let o=document.getElementById(r).getContext("2d"),t=await G(e.datasets.map(n=>n.label)),a=e.datasets.map((n,i)=>({...n,backgroundColor:t[i],borderColor:t[i],fill:!0,tension:.4,borderWidth:1,pointRadius:0,pointHoverRadius:0}));return new Chart(o,{type:"line",data:{labels:e.labels,datasets:a},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},scales:{y:{stacked:!0,...I,title:{display:!0,text:"Cumulative Hours",color:"#E0E0E0"}},x:I},plugins:{title:{display:!0,text:"Cumulative Hours by Project",color:"#E0E0E0",padding:{bottom:15}},legend:{...F,position:"bottom"},tooltip:{callbacks:{label:function(n){let i=n.dataset.label||"";return i&&(i+=": "),n.parsed.y!==null&&(i+=n.parsed.y.toFixed(1)+" total hours"),i}}}}}})}var N,ae,xe,le=$(()=>{ne();N=null,ae=0,xe=5e3});function ce(r){let e=parseInt(String(r),10);if(r==null||isNaN(e)||e<0)return"?";let o=Math.floor(e/60),t=e%60;return`${o}h ${t}m`}function de(r){r=new Date(Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())),r.setUTCDate(r.getUTCDate()+4-(r.getUTCDay()||7));var e=new Date(Date.UTC(r.getUTCFullYear(),0,1)),o=Math.ceil(((r.getTime()-e.getTime())/864e5+1)/7);return o}var X=$(()=>{});function ue(r){if(!r||r.length===0)return console.log("[Charts] No sessions for daily breakdown chart."),{labels:[],monthLabels:{},datasets:[]};let e={},o=new Set,t=null,a=null;if(r.forEach(c=>{let m=c.date;try{let b=new Date(m+"T00:00:00");if(!m||isNaN(b.getTime()))return;(t===null||b<t)&&(t=b),(a===null||b>a)&&(a=b);let E=c.project||"Unassigned";o.add(E);let v=(c.duration_minutes||0)/60;e[m]||(e[m]={}),e[m][E]=(e[m][E]||0)+v}catch{}}),t===null||a===null)return{labels:[],monthLabels:{},datasets:[]};let n=[],i={},d=new Date(t);for(new Date().setHours(0,0,0,0);d<=a;){let c=d.getFullYear(),m=(d.getMonth()+1).toString().padStart(2,"0"),b=d.getDate().toString().padStart(2,"0"),E=`${c}-${m}-${b}`;n.push(E),d.getDate()===1&&(i[E]=d.toLocaleDateString("en-GB",{month:"short"})),d.setDate(d.getDate()+1)}let s=Array.from(o).sort().map(c=>({label:c,data:n.map(m=>e[m]?.[c]||0),backgroundColor:"#000000"}));return{labels:n,monthLabels:i,datasets:s}}function he(r){if(!r||r.length===0)return console.log("[Charts] No sessions for weekly chart."),{labels:[],datasets:[]};let e={},o=new Set,t=new Set;r.forEach(d=>{try{let f=new Date(d.date+"T00:00:00");if(isNaN(f.getTime()))return;let u=f.getFullYear(),s=de(f),c=`${u}-W${s.toString().padStart(2,"0")}`;t.add(c);let m=d.project||"Unassigned";o.add(m);let b=(d.duration_minutes||0)/60;e[c]||(e[c]={}),e[c][m]=(e[c][m]||0)+b}catch{}});let a=Array.from(t).sort(),i=Array.from(o).sort().map(d=>{let f=0,u=a.map(s=>(f+=e[s]?.[d]||0,f));return{label:d,data:u,backgroundColor:"#000000",borderWidth:2,fill:!0}});return{labels:a,datasets:i.reverse()}}function fe(r){let e={};r.forEach(a=>{let n=a.project||"Unassigned";e[n]=(e[n]||0)+(a.duration_minutes||0)});let o=Object.keys(e).sort(),t=o.map(a=>e[a]/60);return{labels:o,data:t}}var me=$(()=>{X()});var ge={};K(ge,{destroyCharts:()=>pe,updateCharts:()=>Te});function Ae(){if(typeof Chart>"u")throw new Error("Chart.js is not loaded. Cannot create charts.")}function pe(){T&&T.destroy(),P&&P.destroy(),B&&B.destroy(),H&&H.destroy(),U&&U.destroy(),_&&_.destroy(),T=P=B=null,H=U=_=null,console.log("[Charts] Destroyed existing chart instances.")}async function Te(r,e,o){try{Ae();let t=document.getElementById("chart-range-title");t&&(t.textContent=`Showing data for: ${o}`),pe(),console.log("[Charts] Called destroyCharts before creating new charts.");try{console.log("[Charts] Fetching comparison stats...");let a=await window.jujuApi.getComparisonStats();if(a){let n=a.day;if(n&&n.past&&n.current){let f=[...n.past.map(m=>m.label),n.current.label],u=[...n.past.map(m=>m.value),n.current.value];H=M("day-comparison-bar-chart",f,u,3);let s=document.getElementById("day-comparison-details");s&&(s.textContent=`Today: ${n.current.value.toFixed(1)}h (${n.current.range})`);let c=document.getElementById("day-comparison-title");if(c){let m=n.past.length>0?n.past[n.past.length-1].label:"Previous Day";c.textContent=`Compared to Previous ${m.split(" ")[1]}s`}}else console.warn("Day comparison data missing or invalid:",n);let i=a.week;if(i&&i.past&&i.current){let f=[...i.past.map(c=>c.label),i.current.label],u=[...i.past.map(c=>c.value),i.current.value];U=M("week-comparison-bar-chart",f,u,3);let s=document.getElementById("week-comparison-details");s&&(s.textContent=`This Week: ${i.current.value.toFixed(1)}h (${i.current.range})`)}else console.warn("Week comparison data missing or invalid:",i);let d=a.month;if(d&&d.past&&d.current){let f=[...d.past.map(c=>c.label),d.current.label],u=[...d.past.map(c=>c.value),d.current.value];_=M("month-comparison-bar-chart",f,u,3);let s=document.getElementById("month-comparison-details");s&&(s.textContent=`This Month: ${d.current.value.toFixed(1)}h (${d.current.range})`)}else console.warn("Month comparison data missing or invalid:",d)}else console.warn("Comparison stats data is missing.")}catch(a){console.error("[Charts] Error with comparison stats:",a),["day","week","month"].forEach(n=>{let i=document.getElementById(`${n}-comparison-details`);i&&(i.textContent="Error loading stats")})}if(!r||r.length===0)return console.log("[Charts] No filtered session data for main charts."),{yearlyChart:null,weeklyChart:null,pieChart:null};console.log(`[Charts] Updating main charts for "${o}" with ${r.length} sessions.`);try{let a=ue(r);T=await re("yearly-chart",a.labels,a.datasets,"Hours",a.monthLabels);let n=he(r);P=await ie("weekly-chart",n);let i=fe(r);return B=await se("pie-chart",i.labels,i.data),{yearlyChart:T,weeklyChart:P,pieChart:B}}catch(a){return console.error("[Charts] Error creating charts:",a),{yearlyChart:null,weeklyChart:null,pieChart:null}}}catch(t){return console.error("[Charts] Error updating charts:",t),{yearlyChart:null,weeklyChart:null,pieChart:null}}}var T,P,B,H,U,_,ye=$(()=>{le();me();T=null,P=null,B=null,H=null,U=null,_=null});var we={};K(we,{default:()=>j});var Q,Pe,j,Z=$(()=>{Q=class{constructor(){this.events={},this.notificationContainer=null,this.modal=null,this.init()}init(){this.notificationContainer=document.getElementById("notification-container"),this.modal=document.getElementById("confirmation-modal"),this.setupModalListeners()}on(e,o){this.events[e]||(this.events[e]=[]),this.events[e].push(o)}off(e,o){if(!this.events[e])return;let t=this.events[e].indexOf(o);t>-1&&this.events[e].splice(t,1)}emit(e,o){this.events[e]&&this.events[e].forEach(t=>{try{t(o)}catch(a){console.error(`Error in event handler for ${e}:`,a)}})}showNotification(e,o,t,a=5e3){if(!this.notificationContainer)return;let n=document.createElement("div");n.className=`notification ${e}`;let i=this.getNotificationIcon(e);return n.innerHTML=`
            <div class="notification-icon">${i}</div>
            <div class="notification-content">
                <div class="notification-title">${o}</div>
                <div class="notification-message">${t}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
        `,this.notificationContainer.appendChild(n),setTimeout(()=>n.classList.add("show"),10),a>0&&setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},a),n}getNotificationIcon(e){return{success:"\u2713",error:"\u2715",warning:"\u26A0",info:"\u2139"}[e]||"\u2139"}showConfirmation(e,o,t,a){return this.modal?new Promise((n,i)=>{let d=document.getElementById("modal-title"),f=document.getElementById("modal-message"),u=document.getElementById("modal-confirm"),s=document.getElementById("modal-cancel"),c=document.getElementById("modal-close");d&&(d.textContent=e),f&&(f.textContent=o);let m=()=>{this.hideModal(),E(),t&&t(),n(!0)},b=()=>{this.hideModal(),E(),a&&a(),n(!1)},E=()=>{u.removeEventListener("click",m),s.removeEventListener("click",b),c.removeEventListener("click",b),this.modal.removeEventListener("click",v)},v=k=>{k.target===this.modal&&b()};u.addEventListener("click",m),s.addEventListener("click",b),c.addEventListener("click",b),this.modal.addEventListener("click",v),this.showModal()}):Promise.reject("Modal not found")}showModal(){this.modal&&(this.modal.classList.add("show"),document.body.style.overflow="hidden")}hideModal(){this.modal&&(this.modal.classList.remove("show"),document.body.style.overflow="")}setupModalListeners(){this.modal&&document.addEventListener("keydown",e=>{e.key==="Escape"&&this.modal.classList.contains("show")&&this.hideModal()})}async deleteWithConfirmation(e,o,t,a){let n=`Delete ${e}`,i=`Are you sure you want to delete "${t}"? This action cannot be undone.`;if(!await this.showConfirmation(n,i))return{success:!1,cancelled:!0};try{this.showNotification("info","Deleting...",`Deleting ${e.toLowerCase()} "${t}"...`,0);let f=await a(o);if(f&&f.success)return this.showNotification("success","Deleted",`${e} "${t}" has been deleted successfully.`),this.emit(`${e.toLowerCase()}Deleted`,{id:o,name:t}),{success:!0};{let u=f&&f.error?f.error:"Unknown error occurred";return this.showNotification("error","Delete Failed",`Failed to delete ${e.toLowerCase()}: ${u}`),{success:!1,error:u}}}catch(f){return console.error(`Error deleting ${e.toLowerCase()}:`,f),this.showNotification("error","Delete Failed",`An error occurred while deleting the ${e.toLowerCase()}.`),{success:!1,error:f.message}}}async deleteSessionWithFallback(e,o){let t=[async a=>{if(window.jujuApi&&typeof window.jujuApi.deleteSession=="function")return await window.jujuApi.deleteSession(a);throw new Error("Delete API not available")},async a=>await this.manualDeleteSession(a)];for(let a=0;a<t.length;a++)try{let n=await this.deleteWithConfirmation("Session",e,o,t[a]);if(n.success||n.cancelled)return n;console.warn(`Delete method ${a+1} failed, trying next method...`)}catch(n){if(console.error(`Delete method ${a+1} error:`,n),a===t.length-1)throw n}}async deleteProjectWithFallback(e,o){let t=[async a=>{if(window.jujuApi&&typeof window.jujuApi.deleteProject=="function")return await window.jujuApi.deleteProject(a);throw new Error("Delete API not available")},async a=>await this.manualDeleteProject(a)];for(let a=0;a<t.length;a++)try{let n=await this.deleteWithConfirmation("Project",e,o,t[a]);if(n.success||n.cancelled)return n;console.warn(`Delete method ${a+1} failed, trying next method...`)}catch(n){if(console.error(`Delete method ${a+1} error:`,n),a===t.length-1)throw n}}async manualDeleteSession(e){throw new Error("Manual session deletion not implemented")}async manualDeleteProject(e){throw new Error("Manual project deletion not implemented")}},Pe=new Q,j=Pe});var ve={};K(ve,{setupTabs:()=>Be,updateSessionsTable:()=>Fe});function Be(){document.querySelectorAll(".tab").forEach(r=>{r.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),r.classList.add("active");let e=r.dataset.tab,o=document.getElementById(e);o?o.classList.add("active"):console.error(`Tab content not found for ID: ${e}`)})}),console.log("[UI] Tabs setup complete.")}function Fe(r,e){if(!W){console.error("[UI] Cannot update sessions table: recentSessionsBody element not found.");return}if(W.innerHTML="",!r||r.length===0){W.innerHTML=`
            <tr><td colspan="7" class="no-data">No sessions match the current filter or page.</td></tr>`,console.log("[UI] Sessions table updated with no data message.");return}r.forEach(o=>{let t=document.createElement("tr");t.setAttribute("data-session-key",`${o.id}-${o.date}-${o.start_time}`);let a="Invalid Date";try{let s=new Date(o.date+"T00:00:00");if(!isNaN(s.getTime())){let c=s.getFullYear(),m=(s.getMonth()+1).toString().padStart(2,"0"),b=s.getDate().toString().padStart(2,"0");a=`${c}-${m}-${b}`}}catch{}let n=typeof o.start_time=="string"?o.start_time.slice(0,5):"??:??",i=typeof o.end_time=="string"?o.end_time.slice(0,5):"??:??",d=o.project||"N/A",f=o.notes||"",u=`${d} on ${a}`;t.innerHTML=`
            <td class="editable" data-field="date" data-id="${o.id}">${a}</td>
            <td class="editable" data-field="project" data-id="${o.id}">${d}</td>
            <td data-field="duration_minutes" data-id="${o.id}">${ce(o.duration_minutes)}</td>
            <td class="editable" data-field="start_time" data-id="${o.id}">${n}</td>
            <td class="editable" data-field="end_time" data-id="${o.id}">${i}</td>
            <td class="editable" data-field="notes" data-id="${o.id}">${f}</td>
            <td class="actions">
                <button class="btn btn-delete" data-id="${o.id}" data-info="${u}" title="Delete Session">\xD7</button>
            </td>
        `,W.appendChild(t)}),Ne(e),Ue(e),console.log("[UI] Sessions table updated.")}function Ne(r){document.querySelectorAll("#recent-sessions-body td.editable").forEach(e=>{let o=Me.bind(e,r);e.removeEventListener("click",e._boundHandleCellClick),e.addEventListener("click",o),e._boundHandleCellClick=o})}async function Me(r){if(this.querySelector("input, textarea, select"))return;let e=this.textContent,o=this.dataset.field;this.setAttribute("data-original-value",e);let t;if(o==="project"){t=document.createElement("select"),t.classList.add("inline-edit-input"),t.style.width="100%",t.style.height="100%";let i=document.createElement("option");i.text="Loading...",t.add(i);try{let d=await window.jujuApi.getProjectNames();t.innerHTML="";let f=document.createElement("option");f.value="",f.text="-- Select Project --",t.add(f),d.forEach(u=>{let s=document.createElement("option");s.value=u,s.text=u,u===e&&(s.selected=!0),t.add(s)})}catch(d){console.error("Failed to load project names:",d),j.showNotification("error","Error","Failed to load project names")}}else o==="start_time"||o==="end_time"?(t=document.createElement("input"),t.type="time",t.value=/^\d{2}:\d{2}$/.test(e)?e:"00:00"):o==="date"?(t=document.createElement("input"),t.type="date",t.value=/^\d{4}-\d{2}-\d{2}$/.test(e)?e:new Date().toISOString().slice(0,10)):o==="notes"?(t=document.createElement("textarea"),t.value=e,t.rows=2):(t=document.createElement("input"),t.type="text",t.value=e);t.classList.add("inline-edit-input"),t.style.width="100%",t.style.boxSizing="border-box",t.tagName==="TEXTAREA"&&(t.rows=1,t.style.resize="none",t.style.minHeight="32px",t.style.maxHeight="80px",t.style.lineHeight="1.4"),this.innerHTML="",this.appendChild(t),t.focus(),t.type==="text"&&t.select();let a=be.bind(t,r),n=He.bind(t,r);t.addEventListener("blur",a),t.addEventListener("keydown",n),t._boundBlurHandler=a,t._boundKeydownHandler=n}async function He(r,e){if(e.key==="Enter"){if(this.tagName==="TEXTAREA"&&e.shiftKey)return;e.preventDefault(),console.log("[UI] Enter key pressed, saving..."),await be.call(this,r)}else if(e.key==="Escape"){console.log("[UI] Escape key pressed, cancelling edit.");let o=this.parentElement,t=o.getAttribute("data-original-value");this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),o.textContent=t,o.removeAttribute("data-original-value")}}async function be(r){let e=this.parentElement;if(!e||!e.dataset){console.warn("[UI] handleCellUpdate called on detached or invalid element."),this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler);try{this.remove()}catch{}return}let o=this.value.trim(),t=e.getAttribute("data-original-value"),a=e.dataset.id,n=e.dataset.field;if(this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),o===t){e.textContent=t,e.removeAttribute("data-original-value");return}e.classList.add("saving"),e.innerHTML='<span class="spinner"></span>';try{let i=await window.jujuApi.updateSession(Number(a),n,o);e.classList.remove("saving"),e.classList.add("success"),setTimeout(()=>e.classList.remove("success"),1e3),j.showNotification("success","Updated",`Session ${n} updated successfully`),window.jujuApi&&typeof window.jujuApi.loadSessions=="function"?window.jujuApi.loadSessions():typeof r=="function"&&r()}catch(i){e.classList.remove("saving"),e.classList.add("error"),setTimeout(()=>e.classList.remove("error"),1200),e.textContent=t,j.showNotification("error","Update Failed",`Failed to update session: ${i.message}`)}finally{e.removeAttribute("data-original-value")}}function Ue(r){document.querySelectorAll("#recent-sessions-body .btn-delete").forEach(e=>{e._boundDeleteHandler&&e.removeEventListener("click",e._boundDeleteHandler);let o=async t=>{t.preventDefault(),t.stopPropagation();let a=t.target.dataset.id,n=t.target.dataset.info||`Session ${a}`;if(!a){j.showNotification("error","Error","Session ID not found");return}console.log("[UI] Delete button clicked for session:",a,n);try{let i=await j.deleteSessionWithFallback(a,n);i.success?typeof r=="function"&&r():i.cancelled||console.error("[UI] Session deletion failed:",i.error)}catch(i){console.error("[UI] Unexpected error during session deletion:",i),j.showNotification("error","Delete Failed","An unexpected error occurred while deleting the session")}};e.addEventListener("click",o),e._boundDeleteHandler=o,console.log("[UI] Enhanced delete handler attached for session id:",e.dataset.id)})}var W,Ee=$(()=>{X();Z();W=document.getElementById("recent-sessions-body")});document.addEventListener("DOMContentLoaded",async()=>{try{let z=function(l,h=null,g=null){let p=new Date;p.setHours(0,0,0,0);let y=new Date(p),w=new Date(p);w.setHours(23,59,59,999);let C="";switch(l){case"7d":y.setDate(p.getDate()-6),C="Last 7 Days";break;case"1m":y=new Date(p.getFullYear(),p.getMonth()-1,p.getDate()),C="Last Month";break;case"3m":y=new Date(p.getFullYear(),p.getMonth()-3,p.getDate()),C="Last Quarter";break;case"1y":y=new Date(p.getFullYear(),0,1),C="This Year";break;case"all":y=null,w=null,C="All Time";break;case"custom":try{if(y=h?new Date(h+"T00:00:00"):null,w=g?new Date(g+"T23:59:59.999"):null,y&&w&&y>w)return alert("Start date cannot be after end date."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"};C=`Custom (${h||"..."} - ${g||"..."})`}catch(D){return console.error("Error parsing custom dates:",D),alert("Invalid custom date format."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"}}break;default:y=new Date(p.getFullYear(),0,1),C="This Year"}return y&&!(y instanceof Date&&!isNaN(y))&&(y=null),w&&!(w instanceof Date&&!isNaN(w))&&(w=null),{startDate:y,endDate:w,rangeTitle:C}},V=function(l,h){return s?l===null&&h===null?[...s]:s.filter(g=>{try{let p=new Date(g.date+"T00:00:00");if(isNaN(p.getTime()))return!1;let y=l===null||p>=l,w=h===null||p<=h;return y&&w}catch(p){return console.warn("Error parsing session date during filter:",g.date,p),!1}}):[]},ke=function(){if(!S)return;let l=S.value;S.innerHTML='<option value="All">All Projects</option>',c&&c.length>0&&c.forEach(h=>{let g=document.createElement("option");g.value=h.name,g.textContent=h.name,h.name===l&&(g.selected=!0),S.appendChild(g)})},q=function(){if(!s)return{visibleSessions:[],totalPages:1};let l=[...s];k&&k!=="All"&&(l=l.filter(w=>w.project===k)),l.sort((w,C)=>{let D=new Date(w.date+"T00:00:00");return new Date(C.date+"T00:00:00")-D});let h=Math.ceil(l.length/E),g=(v-1)*E,p=g+E;return{visibleSessions:l.slice(g,p),totalPages:h}},A=function(){let{visibleSessions:l,totalPages:h}=q();f(l,L),ee&&(ee.textContent=`Page ${v} of ${h}`),R&&(R.disabled=v<=1),O&&(O.disabled=v>=h),console.log(`[Dashboard] Session display refreshed. Page: ${v}/${h}, Filter: ${k}`)};var r=z,e=V,o=ke,t=q,a=A;let{updateCharts:n,destroyCharts:i}=await Promise.resolve().then(()=>(ye(),ge)),{setupTabs:d,updateSessionsTable:f}=await Promise.resolve().then(()=>(Ee(),ve)),u=await Promise.resolve().then(()=>(Z(),we)).then(l=>l.default),s=[],c=[],m="1y",b="This Year",E=20,v=1,k="All",Y=document.querySelectorAll(".btn-filter"),Ce=document.getElementById("date-from"),De=document.getElementById("date-to"),je=document.getElementById("apply-custom-date"),S=document.getElementById("project-filter-select"),R=document.getElementById("prev-page-btn"),O=document.getElementById("next-page-btn"),ee=document.getElementById("page-info");window.onSessionsLoaded=function(l){if(console.log("[Dashboard] onSessionsLoaded called",l),typeof l=="string")try{l=JSON.parse(l)}catch(h){console.error("Failed to parse sessions JSON",h),l=[]}window.allSessions=l,s=l,L()},window.onProjectsLoaded=function(l){if(typeof l=="string")try{l=JSON.parse(l)}catch(h){console.error("Failed to parse projects JSON",h),l=[]}c=l,typeof x=="function"&&x()};async function te(l){console.log(`[Dashboard] Date filter changed to: ${l}`);let h=null,g=null;if(l==="custom"&&(h=Ce.value,g=De.value,!h||!g)){u.showNotification("warning","Invalid Range",'Please select both "From" and "To" dates for custom range.');return}let{startDate:p,endDate:y,rangeTitle:w}=z(l,h,g);if(w==="Invalid Range")return;let C=V(p,y);console.log(`[Dashboard] Filtered sessions count for chart "${w}": ${C.length}`),m=l,b=w,Y.forEach(D=>{D.dataset.range===l?D.classList.add("active"):D.classList.remove("active")}),l==="custom"&&Y.forEach(D=>{D.closest(".date-filter-buttons")&&D.classList.remove("active")});try{await n(C,s,w)}catch(D){console.error(`[Dashboard] Error updating charts for range ${l}:`,D),u.showNotification("error","Chart Error","Failed to update charts")}}async function L(){if(!s){console.log("[Dashboard] No sessions data available, skipping refresh");return}let{startDate:l,endDate:h}=z(m),g=V(l,h);try{await n(g,s,b)}catch(p){console.error("[Dashboard] Error updating charts:",p),u.showNotification("error","Chart Error","Failed to update charts")}A()}async function Le(){console.log("[DEBUG] initProjectManagement called");let l=document.getElementById("projects-list"),h=document.getElementById("add-project-form");if(!l||!h){console.error("Project management elements not found");return}await x(),h.addEventListener("submit",async g=>{g.preventDefault();let p=document.getElementById("new-project-name"),y=document.getElementById("new-project-color");if(!(!p||!y))try{let w=await window.jujuApi.addProject({name:p.value.trim(),color:y.value});w&&w.success&&(p.value="",y.value="#4E79A7",await x(),await L(),u.showNotification("success","Project Added",`Project "${p.value.trim()}" created successfully`))}catch(w){console.error("Error adding project:",w),u.showNotification("error","Add Failed",`Failed to add project: ${w.message}`)}})}async function x(){let l=document.getElementById("projects-list");if(!l){console.error("Projects list element not found");return}try{l.innerHTML="",c.forEach(h=>{let g=document.createElement("div");g.className="project-item",g.innerHTML=`
                        <div class="project-info">
                            <span class="project-name">${h.name}</span>
                            <div class="project-color">
                                <input type="color" value="${h.color||"#4E79A7"}" 
                                       data-project-id="${h.id}">
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-delete" data-id="${h.id}" data-name="${h.name}" title="Delete Project" aria-label="Delete Project">&times;</button>
                        </div>
                    `;let p=g.querySelector('input[type="color"]');p&&p.addEventListener("change",async y=>{try{await window.jujuApi.updateProjectColor(h.id,y.target.value),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),u.showNotification("success","Color Updated",`Project "${h.name}" color updated`)}catch(w){console.error("Error updating project color:",w),u.showNotification("error","Update Failed",`Failed to update color: ${w.message}`)}}),l.appendChild(g)})}catch(h){console.error("Error loading projects:",h),l.innerHTML='<div class="error">Failed to load projects</div>',u.showNotification("error","Load Failed","Failed to load projects")}}Y.forEach(l=>{l.closest(".date-filter-buttons")&&l.addEventListener("click",()=>te(l.dataset.range))}),je.addEventListener("click",()=>te("custom")),S?.addEventListener("change",l=>{k=l.target.value,v=1,A()}),R?.addEventListener("click",()=>{v>1&&(v--,A())}),O?.addEventListener("click",()=>{let{totalPages:l}=q();v<l&&(v++,A())}),document.getElementById("projects-list").addEventListener("click",async function(l){if(l.target.classList.contains("btn-delete")){l.preventDefault(),l.stopPropagation();let h=l.target,g=h.dataset.id,p=h.dataset.name||`Project ${g}`;if(!g){u.showNotification("error","Error","Project ID not found");return}console.log("[Dashboard] Project delete button clicked",g,p);try{let y=await u.deleteProjectWithFallback(g,p);y.success?(await x(),await L()):y.cancelled||console.error("[Dashboard] Project deletion failed:",y.error)}catch(y){console.error("[Dashboard] Unexpected error during project deletion:",y),u.showNotification("error","Delete Failed","An unexpected error occurred while deleting the project")}}}),d(),console.log("Calling window.jujuApi.loadProjects and loadSessions"),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),await Le(),await L(),u.on("sessionDeleted",()=>{console.log("[Dashboard] Session deleted event received, refreshing data"),L()}),u.on("projectDeleted",()=>{console.log("[Dashboard] Project deleted event received, refreshing data"),x(),L()})}catch(n){console.error("[Dashboard] Error initializing dashboard:",n),eventSystem&&eventSystem.showNotification("error","Initialization Failed","Failed to initialize dashboard. Please check console for details.");let i=document.getElementById("charts");i&&(i.innerHTML=`<div class="error-message">Failed to initialize dashboard. Please check console for details. Error: ${n.message}</div>`)}});})();
