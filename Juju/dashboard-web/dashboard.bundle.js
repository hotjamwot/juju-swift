(()=>{var ke=Object.defineProperty;var k=(n,e)=>()=>(n&&(e=n(n=0)),e);var ae=(n,e)=>{for(var a in e)ke(n,a,{get:e[a],enumerable:!0})};var V,L,P,ne,oe=k(()=>{V=["#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F","#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#E494A6","#F1A861","#86BCB6","#A8A07D","#B881A3"],L={grid:{display:!0,color:"rgba(224, 224, 224, 0.1)"},ticks:{color:"#E0E0E0",font:{size:11},padding:5}},P={display:!0,position:"top",labels:{color:"#E0E0E0",font:{size:12},padding:15}},ne={callbacks:{label:function(n){let e=n.dataset,a=n.raw;return`${e.label}: ${a.toFixed(1)} hours`}}}});async function xe(){let n=Date.now();if(!F||n-re>Le)try{F=await window.jujuApi.loadProjects(),re=n}catch(e){console.warn("Error loading projects:",e),F=[]}return F}async function Te(n,e){let t=(await xe()).find(l=>l.name===n);return t&&t.color?t.color:V[e%V.length]}async function q(n){let e=[];for(let a=0;a<n.length;a++)e.push(await Te(n[a],a));return e}async function se(n,e,a,t,l=null){let o=document.getElementById(n);if(!o)return console.error(`Canvas element with ID ${n} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;if(!e.length||!a.length||a.every(s=>!s.data.length)){let s=o.getContext("2d");return s.save(),s.textAlign="center",s.textBaseline="middle",s.fillStyle="#888888",s.font="14px Poppins",s.fillText("No data available for this period",o.width/2,o.height/2),s.restore(),null}let i=o.getContext("2d"),u=a.filter(s=>s.data.some(d=>d>0)),b=u.map(s=>s.label),m=await q(b);return u.forEach((s,d)=>{s.backgroundColor=m[d]}),new Chart(i,{type:"bar",data:{labels:e,datasets:u},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:0,bottom:0,left:0,right:0}},scales:{x:{stacked:!0,...L,ticks:{...L.ticks,callback:function(s,d){if(!e||d>=e.length)return"";let f=e[d];if(l&&l[f])return l[f];if(l&&f&&f.includes("-"))try{let C=new Date(f+"T00:00:00");return!isNaN(C.getTime())&&C.getDate()!==1?C.toLocaleDateString("en-US",{month:"numeric",day:"numeric"}):""}catch{return f}return f}}},y:{stacked:!0,...L,title:{display:!0,text:t,color:"#E0E0E0"}}},plugins:{legend:P,tooltip:ne}}})}function H(n,e,a,t=3){let l=document.getElementById(n);if(!l)return console.error(`Canvas element with ID ${n} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let o=l.getContext("2d");if(!e||!a||e.length!==4||a.length!==4)return console.warn(`[Charts] Invalid data for multi-bar comparison chart ${n}. Expected 4 labels and 4 values.`),o.save(),o.textAlign="center",o.textBaseline="middle",o.fillStyle="#888888",o.font="12px Poppins",o.fillText("Invalid data",l.width/2,l.height/2),o.restore(),null;let i="rgba(78, 121, 167, 0.4)",u="#F28E2B",b=a.map((s,d)=>d===t?u:i),m=a.map((s,d)=>d===t?u:"#4E79A7");return new Chart(o,{type:"bar",data:{labels:e,datasets:[{label:"Hours",data:a,backgroundColor:b,borderColor:m,borderWidth:1,barPercentage:1,categoryPercentage:.9}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:2,bottom:2,left:20,right:15}},scales:{x:{beginAtZero:!0,position:"top",grid:{display:!1,drawBorder:!1},ticks:{color:"#888888",font:{size:10},maxTicksLimit:4,padding:2,callback:s=>s.toFixed(1)+"h"}},y:{grid:{display:!1,drawBorder:!1},ticks:{color:"#CCCCCC",font:{size:11},padding:4,maxRotation:0,minRotation:0,autoSkip:!1,callback:function(s,d){return this.getLabelForValue(s).replace(/(Sun|Mon|Tue|Wed|Thu|Fri|Sat)day/,"$1").replace(" Weeks Ago","w ago").replace(" Months Ago","m ago")}}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,callbacks:{title:function(s){return s[0].label},label:function(s){return`Hours: ${s.parsed.x.toFixed(1)}`}}}}}})}async function le(n,e,a){let t=document.getElementById(n);if(!t)return console.error(`Canvas element with ID ${n} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let l=t.getContext("2d"),o=.01,i=[],u=[];if(e.forEach((m,s)=>{a[s]>=o&&(i.push(m),u.push(a[s]))}),i.length===0)return console.log(`[Charts] No significant data for pie chart ${n}.`),null;let b=await q(i);return new Chart(l,{type:"pie",data:{labels:i,datasets:[{data:u,backgroundColor:b,borderColor:"#1E1E1E",borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{...P,position:"top"},tooltip:{callbacks:{label:function(m){let s=m.label||"",d=m.parsed||0,f=m.chart.data.datasets[0].data.reduce((w,j)=>w+j,0),C=f>0?(d/f*100).toFixed(1):0;return`${s}: ${d.toFixed(1)} hours (${C}%)`}}}}}})}async function ie(n,e){let a=document.getElementById(n).getContext("2d"),t=await q(e.datasets.map(o=>o.label)),l=e.datasets.map((o,i)=>({...o,backgroundColor:t[i],borderColor:t[i],fill:!0,tension:.4,borderWidth:1,pointRadius:0,pointHoverRadius:0}));return new Chart(a,{type:"line",data:{labels:e.labels,datasets:l},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},scales:{y:{stacked:!0,...L,title:{display:!0,text:"Cumulative Hours",color:"#E0E0E0"}},x:L},plugins:{title:{display:!0,text:"Cumulative Hours by Project",color:"#E0E0E0",padding:{bottom:15}},legend:{...P,position:"bottom"},tooltip:{callbacks:{label:function(o){let i=o.dataset.label||"";return i&&(i+=": "),o.parsed.y!==null&&(i+=o.parsed.y.toFixed(1)+" total hours"),i}}}}}})}var F,re,Le,ce=k(()=>{oe();F=null,re=0,Le=5e3});function de(n){let e=parseInt(String(n),10);if(n==null||isNaN(e)||e<0)return"?";let a=Math.floor(e/60),t=e%60;return`${a}h ${t}m`}function ue(n){n=new Date(Date.UTC(n.getFullYear(),n.getMonth(),n.getDate())),n.setUTCDate(n.getUTCDate()+4-(n.getUTCDay()||7));var e=new Date(Date.UTC(n.getUTCFullYear(),0,1)),a=Math.ceil(((n.getTime()-e.getTime())/864e5+1)/7);return a}var K=k(()=>{});function pe(n){if(!n||n.length===0)return console.log("[Charts] No sessions for daily breakdown chart."),{labels:[],monthLabels:{},datasets:[]};let e={},a=new Set,t=null,l=null;if(n.forEach(d=>{let f=d.date;try{let C=new Date(f+"T00:00:00");if(!f||isNaN(C.getTime()))return;(t===null||C<t)&&(t=C),(l===null||C>l)&&(l=C);let w=d.project||"Unassigned";a.add(w);let j=(d.duration_minutes||0)/60;e[f]||(e[f]={}),e[f][w]=(e[f][w]||0)+j}catch{}}),t===null||l===null)return{labels:[],monthLabels:{},datasets:[]};let o=[],i={},u=new Date(t);for(new Date().setHours(0,0,0,0);u<=l;){let d=u.getFullYear(),f=(u.getMonth()+1).toString().padStart(2,"0"),C=u.getDate().toString().padStart(2,"0"),w=`${d}-${f}-${C}`;o.push(w),u.getDate()===1&&(i[w]=u.toLocaleDateString("en-GB",{month:"short"})),u.setDate(u.getDate()+1)}let s=Array.from(a).sort().map(d=>({label:d,data:o.map(f=>e[f]?.[d]||0),backgroundColor:"#000000"}));return{labels:o,monthLabels:i,datasets:s}}function me(n){if(!n||n.length===0)return console.log("[Charts] No sessions for weekly chart."),{labels:[],datasets:[]};let e={},a=new Set,t=new Set;n.forEach(u=>{try{let b=new Date(u.date+"T00:00:00");if(isNaN(b.getTime()))return;let m=b.getFullYear(),s=ue(b),d=`${m}-W${s.toString().padStart(2,"0")}`;t.add(d);let f=u.project||"Unassigned";a.add(f);let C=(u.duration_minutes||0)/60;e[d]||(e[d]={}),e[d][f]=(e[d][f]||0)+C}catch{}});let l=Array.from(t).sort(),i=Array.from(a).sort().map(u=>{let b=0,m=l.map(s=>(b+=e[s]?.[u]||0,b));return{label:u,data:m,backgroundColor:"#000000",borderWidth:2,fill:!0}});return{labels:l,datasets:i.reverse()}}function fe(n){let e={};n.forEach(l=>{let o=l.project||"Unassigned";e[o]=(e[o]||0)+(l.duration_minutes||0)});let a=Object.keys(e).sort(),t=a.map(l=>e[l]/60);return{labels:a,data:t}}var he=k(()=>{K()});var ye={};ae(ye,{destroyCharts:()=>ge,updateCharts:()=>Se});function Ae(){if(typeof Chart>"u")throw new Error("Chart.js is not loaded. Cannot create charts.")}function ge(){S&&S.destroy(),$&&$.destroy(),I&&I.destroy(),N&&N.destroy(),M&&M.destroy(),_&&_.destroy(),S=$=I=null,N=M=_=null,console.log("[Charts] Destroyed existing chart instances.")}async function Se(n,e,a){try{Ae();let t=document.getElementById("chart-range-title");t&&(t.textContent=`Showing data for: ${a}`),ge();try{console.log("[Charts] Fetching comparison stats...");let l=await window.jujuApi.getComparisonStats();if(l){let o=l.day;if(o&&o.past&&o.current){let b=[...o.past.map(f=>f.label),o.current.label],m=[...o.past.map(f=>f.value),o.current.value];N=H("day-comparison-bar-chart",b,m,3);let s=document.getElementById("day-comparison-details");s&&(s.textContent=`Today: ${o.current.value.toFixed(1)}h (${o.current.range})`);let d=document.getElementById("day-comparison-title");if(d){let f=o.past.length>0?o.past[o.past.length-1].label:"Previous Day";d.textContent=`Compared to Previous ${f.split(" ")[1]}s`}}else console.warn("Day comparison data missing or invalid:",o);let i=l.week;if(i&&i.past&&i.current){let b=[...i.past.map(d=>d.label),i.current.label],m=[...i.past.map(d=>d.value),i.current.value];M=H("week-comparison-bar-chart",b,m,3);let s=document.getElementById("week-comparison-details");s&&(s.textContent=`This Week: ${i.current.value.toFixed(1)}h (${i.current.range})`)}else console.warn("Week comparison data missing or invalid:",i);let u=l.month;if(u&&u.past&&u.current){let b=[...u.past.map(d=>d.label),u.current.label],m=[...u.past.map(d=>d.value),u.current.value];_=H("month-comparison-bar-chart",b,m,3);let s=document.getElementById("month-comparison-details");s&&(s.textContent=`This Month: ${u.current.value.toFixed(1)}h (${u.current.range})`)}else console.warn("Month comparison data missing or invalid:",u)}else console.warn("Comparison stats data is missing.")}catch(l){console.error("[Charts] Error with comparison stats:",l),["day","week","month"].forEach(o=>{let i=document.getElementById(`${o}-comparison-details`);i&&(i.textContent="Error loading stats")})}if(!n||n.length===0)return console.log("[Charts] No filtered session data for main charts."),{yearlyChart:null,weeklyChart:null,pieChart:null};console.log(`[Charts] Updating main charts for "${a}" with ${n.length} sessions.`);try{let l=pe(n);S=await se("yearly-chart",l.labels,l.datasets,"Hours",l.monthLabels);let o=me(n);$=await ie("weekly-chart",o);let i=fe(n);return I=await le("pie-chart",i.labels,i.data),{yearlyChart:S,weeklyChart:$,pieChart:I}}catch(l){return console.error("[Charts] Error creating charts:",l),{yearlyChart:null,weeklyChart:null,pieChart:null}}}catch(t){return console.error("[Charts] Error updating charts:",t),{yearlyChart:null,weeklyChart:null,pieChart:null}}}var S,$,I,N,M,_,be=k(()=>{ce();he();S=null,$=null,I=null,N=null,M=null,_=null});var Ce={};ae(Ce,{setupTabs:()=>$e,updateSessionsTable:()=>Ie});function $e(){document.querySelectorAll(".tab").forEach(n=>{n.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),n.classList.add("active");let e=n.dataset.tab,a=document.getElementById(e);a?a.classList.add("active"):console.error(`Tab content not found for ID: ${e}`)})}),console.log("[UI] Tabs setup complete.")}function Ie(n,e){if(!U){console.error("[UI] Cannot update sessions table: recentSessionsBody element not found.");return}if(U.innerHTML="",!n||n.length===0){U.innerHTML=`
            <tr><td colspan="6" class="no-data">No sessions match the current filter or page.</td></tr>`,console.log("[UI] Sessions table updated with no data message.");return}n.forEach(a=>{let t=document.createElement("tr");t.setAttribute("data-session-key",`${a.id}-${a.date}-${a.start_time}`);let l="Invalid Date";try{let m=new Date(a.date+"T00:00:00");if(!isNaN(m.getTime())){let s=m.getFullYear(),d=(m.getMonth()+1).toString().padStart(2,"0"),f=m.getDate().toString().padStart(2,"0");l=`${s}-${d}-${f}`}}catch{}let o=typeof a.start_time=="string"?a.start_time.slice(0,5):"??:??",i=typeof a.end_time=="string"?a.end_time.slice(0,5):"??:??",u=a.project||"N/A",b=a.notes||"";t.innerHTML=`
            <td class="editable" data-field="date" data-id="${a.id}">${l}</td>
            <td class="editable" data-field="project" data-id="${a.id}">${u}</td>
            <td data-field="duration_minutes" data-id="${a.id}">${de(a.duration_minutes)}</td>
            <td class="editable" data-field="start_time" data-id="${a.id}">${o}</td>
            <td class="editable" data-field="end_time" data-id="${a.id}">${i}</td>
            <td class="editable" data-field="notes" data-id="${a.id}">${b}</td>
            <td class="actions">
                <button class="btn btn-delete" data-id="${a.id}" title="Delete Session">\xD7</button>
            </td>
        `,U.appendChild(t)}),Be(e),He(e),console.log("[UI] Sessions table updated.")}function Be(n){document.querySelectorAll("#recent-sessions-body td.editable").forEach(e=>{let a=Pe.bind(e,n);e.removeEventListener("click",e._boundHandleCellClick),e.addEventListener("click",a),e._boundHandleCellClick=a})}async function Pe(n){if(this.querySelector("input, textarea, select"))return;let e=this.textContent,a=this.dataset.field;this.setAttribute("data-original-value",e);let t;if(a==="project"){t=document.createElement("select"),t.classList.add("inline-edit-input"),t.style.width="100%",t.style.height="100%";let i=document.createElement("option");i.text="Loading...",t.add(i);try{let u=await window.jujuApi.getProjectNames();t.innerHTML="";let b=document.createElement("option");b.value="",b.text="-- Select Project --",t.add(b),u.forEach(m=>{let s=document.createElement("option");s.value=m,s.text=m,m===e&&(s.selected=!0),t.add(s)})}catch(u){console.error("Failed to load project names:",u)}}else a==="start_time"||a==="end_time"?(t=document.createElement("input"),t.type="time",t.value=/^\d{2}:\d{2}$/.test(e)?e:"00:00"):a==="date"?(t=document.createElement("input"),t.type="date",t.value=/^\d{4}-\d{2}-\d{2}$/.test(e)?e:new Date().toISOString().slice(0,10)):a==="notes"?(t=document.createElement("textarea"),t.value=e,t.rows=2):(t=document.createElement("input"),t.type="text",t.value=e);t.classList.add("inline-edit-input"),t.style.width="100%",t.style.boxSizing="border-box",t.tagName==="TEXTAREA"&&(t.rows=1,t.style.resize="none",t.style.minHeight="32px",t.style.maxHeight="80px",t.style.lineHeight="1.4"),this.innerHTML="",this.appendChild(t),t.focus(),t.type==="text"&&t.select();let l=we.bind(t,n),o=Fe.bind(t,n);t.addEventListener("blur",l),t.addEventListener("keydown",o),t._boundBlurHandler=l,t._boundKeydownHandler=o}async function Fe(n,e){if(e.key==="Enter"){if(this.tagName==="TEXTAREA"&&e.shiftKey)return;e.preventDefault(),console.log("[UI] Enter key pressed, saving..."),await we.call(this,n)}else if(e.key==="Escape"){console.log("[UI] Escape key pressed, cancelling edit.");let a=this.parentElement,t=a.getAttribute("data-original-value");this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),a.textContent=t,a.removeAttribute("data-original-value")}}async function we(n){let e=this.parentElement;if(!e||!e.dataset){console.warn("[UI] handleCellUpdate called on detached or invalid element."),this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler);try{this.remove()}catch{}return}let a=this.value.trim(),t=e.getAttribute("data-original-value"),l=e.dataset.id,o=e.dataset.field;if(this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),a===t){e.textContent=t,e.removeAttribute("data-original-value");return}e.classList.add("saving"),e.innerHTML='<span class="spinner"></span>';try{let i=await window.jujuApi.updateSession(Number(l),o,a);e.classList.remove("saving"),e.classList.add("success"),setTimeout(()=>e.classList.remove("success"),1e3),window.jujuApi&&typeof window.jujuApi.loadSessions=="function"?window.jujuApi.loadSessions():typeof n=="function"&&n()}catch{e.classList.remove("saving"),e.classList.add("error"),setTimeout(()=>e.classList.remove("error"),1200),e.textContent=t}finally{e.removeAttribute("data-original-value")}}function He(n){document.querySelectorAll("#recent-sessions-body .btn-delete").forEach(e=>{e.addEventListener("click",async a=>{let t=a.target.dataset.id;if(t&&confirm("Are you sure you want to delete this session? This cannot be undone."))try{let l=await window.jujuApi.deleteSession(Number(t));console.log(`[UI] Session deleted successfully: ${t}. Result:`,l),typeof n=="function"&&n()}catch(l){console.error("[UI] Error deleting session:",l),alert("Failed to delete session. Please try again.")}})})}var U,Ee=k(()=>{K();U=document.getElementById("recent-sessions-body")});document.addEventListener("DOMContentLoaded",async()=>{try{let B=function(r,c=null,h=null){let g=new Date;g.setHours(0,0,0,0);let y=new Date(g),p=new Date(g);p.setHours(23,59,59,999);let E="";switch(r){case"7d":y.setDate(g.getDate()-6),E="Last 7 Days";break;case"1m":y=new Date(g.getFullYear(),g.getMonth()-1,g.getDate()),E="Last Month";break;case"3m":y=new Date(g.getFullYear(),g.getMonth()-3,g.getDate()),E="Last Quarter";break;case"1y":y=new Date(g.getFullYear(),0,1),E="This Year";break;case"all":y=null,p=null,E="All Time";break;case"custom":try{if(y=c?new Date(c+"T00:00:00"):null,p=h?new Date(h+"T23:59:59.999"):null,y&&p&&y>p)return alert("Start date cannot be after end date."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"};E=`Custom (${c||"..."} - ${h||"..."})`}catch(v){return console.error("Error parsing custom dates:",v),alert("Invalid custom date format."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"}}break;default:y=new Date(g.getFullYear(),0,1),E="This Year"}return y&&!(y instanceof Date&&!isNaN(y))&&(y=null),p&&!(p instanceof Date&&!isNaN(p))&&(p=null),{startDate:y,endDate:p,rangeTitle:E}},O=function(r,c){return m?r===null&&c===null?[...m]:m.filter(h=>{try{let g=new Date(h.date+"T00:00:00");if(isNaN(g.getTime()))return!1;let y=r===null||g>=r,p=c===null||g<=c;return y&&p}catch(g){return console.warn("Error parsing session date during filter:",h.date,g),!1}}):[]},Z=function(){if(!D)return;let r=[...new Set(m.map(c=>c.project||"N/A"))].sort();D.innerHTML='<option value="All">All Projects</option>',r.forEach(c=>{if(c){let h=document.createElement("option");h.value=c,h.textContent=c,D.appendChild(h)}}),D.value=j,console.log("[Dashboard] Project filter populated.")},z=function(){let r=m;j!=="All"&&(r=m.filter(E=>(E.project||"N/A")===j)),r.sort((E,v)=>{let ee=new Date(`${E.date||""}T${E.start_time||""}`).getTime(),te=new Date(`${v.date||""}T${v.start_time||""}`).getTime(),De=isNaN(ee)?-1/0:ee;return(isNaN(te)?-1/0:te)-De});let c=r.length,h=Math.max(1,Math.ceil(c/C));w>h&&(w=h),w<1&&(w=1);let g=(w-1)*C,y=g+C;return{visibleSessions:r.slice(g,y),currentPage:w,totalPages:h}},T=function(){let{visibleSessions:r,currentPage:c,totalPages:h}=z();w=c,b(r,x),X&&(X.textContent=`Page ${w} of ${h}`),R&&(R.disabled=w<=1),W&&(W.disabled=w>=h),console.log(`[Dashboard] Session display refreshed. Page: ${w}/${h}, Filter: ${j}`)};var n=B,e=O,a=Z,t=z,l=T;let{updateCharts:o,destroyCharts:i}=await Promise.resolve().then(()=>(be(),ye)),{setupTabs:u,updateSessionsTable:b}=await Promise.resolve().then(()=>(Ee(),Ce)),m=[],s=[],d="1y",f="This Year",C=20,w=1,j="All",Y=document.querySelectorAll(".btn-filter"),J=document.getElementById("date-from"),G=document.getElementById("date-to"),ve=document.getElementById("apply-custom-date"),D=document.getElementById("project-filter-select"),R=document.getElementById("prev-page-btn"),W=document.getElementById("next-page-btn"),X=document.getElementById("page-info");window.onSessionsLoaded=function(r){if(console.log("[Dashboard] onSessionsLoaded called",r),typeof r=="string")try{r=JSON.parse(r)}catch(c){console.error("Failed to parse sessions JSON",c),r=[]}window.allSessions=r,m=r,x()},window.onProjectsLoaded=function(r){if(typeof r=="string")try{r=JSON.parse(r)}catch(c){console.error("Failed to parse projects JSON",c),r=[]}s=r,typeof A=="function"&&A()};async function Q(r){console.log(`[Dashboard] Date filter changed to: ${r}`);let c=null,h=null;if(r==="custom"&&(c=J.value,h=G.value,!c||!h)){alert("Please select both 'From' and 'To' dates for custom range.");return}let{startDate:g,endDate:y,rangeTitle:p}=B(r,c,h);if(p==="Invalid Range")return;let E=O(g,y);console.log(`[Dashboard] Filtered sessions count for chart "${p}": ${E.length}`),d=r,f=p,Y.forEach(v=>{v.dataset.range===r?v.classList.add("active"):v.classList.remove("active")}),r==="custom"&&Y.forEach(v=>{v.closest(".date-filter-buttons")&&v.classList.remove("active")});try{await o(E,m,p)}catch(v){console.error(`[Dashboard] Error updating charts for range ${r}:`,v)}}async function x(){console.log("[Dashboard] Refreshing dashboard data...");try{D.options.length<=1&&Z(),T();let r,c;d==="custom"?{startDate:r,endDate:c}=B(d,J.value,G.value):{startDate:r,endDate:c}=B(d);let h=O(r,c);await o(h,m,f)}catch(r){console.error("[Dashboard] Error refreshing dashboard data:",r)}}async function je(){console.log("[DEBUG] initProjectManagement called");let r=document.getElementById("projects-list"),c=document.getElementById("add-project-form");if(!r||!c){console.error("Project management elements not found");return}await A(),c.addEventListener("submit",async h=>{h.preventDefault();let g=document.getElementById("new-project-name"),y=document.getElementById("new-project-color");if(!(!g||!y))try{let p=await window.jujuApi.addProject({name:g.value.trim(),color:y.value});p&&p.success&&(g.value="",y.value="#4E79A7",await A(),await x())}catch(p){console.error("Error adding project:",p),alert("Failed to add project: "+p.message)}})}async function A(){let r=document.getElementById("projects-list");if(!r){console.error("Projects list element not found");return}try{r.innerHTML="",s.forEach(c=>{let h=document.createElement("div");h.className="project-item",h.innerHTML=`
                        <div class="project-info">
                            <span class="project-name">${c.name}</span>
                            <div class="project-color">
                                <input type="color" value="${c.color||"#4E79A7"}" 
                                       data-project-id="${c.id}">
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-delete" data-id="${c.id}" title="Delete Project" aria-label="Delete Project">&times;</button>
                        </div>
                    `;let g=h.querySelector('input[type="color"]');g&&g.addEventListener("change",async y=>{try{await window.jujuApi.updateProjectColor(c.id,y.target.value),window.jujuApi.loadProjects(),window.jujuApi.loadSessions()}catch(p){console.error("Error updating project color:",p),alert("Failed to update color: "+p.message)}}),r.appendChild(h)})}catch(c){console.error("Error loading projects:",c),r.innerHTML='<div class="error">Failed to load projects</div>'}}Y.forEach(r=>{r.closest(".date-filter-buttons")&&r.addEventListener("click",()=>Q(r.dataset.range))}),ve.addEventListener("click",()=>Q("custom")),D?.addEventListener("change",r=>{j=r.target.value,w=1,T()}),R?.addEventListener("click",()=>{w>1&&(w--,T())}),W?.addEventListener("click",()=>{let{totalPages:r}=z();w<r&&(w++,T())}),document.getElementById("projects-list").addEventListener("click",async function(r){if(r.target.classList.contains("btn-delete")){let c=r.target,h=c.dataset.id,g=s.find(p=>String(p.id)===String(h));if(!g||!confirm(`Are you sure you want to delete ${g.name}?`))return;c.disabled=!0;let y=c.innerHTML;c.innerHTML='<span class="spinner"></span>';try{let p=await window.jujuApi.deleteProject(h);if(p&&p.success)await A(),await x();else{let E=p&&p.error?p.error:"Unknown error";alert("Failed to delete project: "+E),console.error("Error deleting project:",E),c.disabled=!1,c.innerHTML=y}}catch(p){alert("Failed to delete project: "+(p&&p.message?p.message:p)),console.error("Error deleting project:",p),c.disabled=!1,c.innerHTML=y}}}),u(),console.log("Calling window.jujuApi.loadProjects and loadSessions"),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),await je(),await x()}catch(o){console.error("[Dashboard] Error initializing dashboard:",o);let i=document.getElementById("charts");i&&(i.innerHTML=`<div class="error-message">Failed to initialize dashboard. Please check console for details. Error: ${o.message}</div>`)}});})();
