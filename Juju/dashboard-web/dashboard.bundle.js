(()=>{var Se=Object.defineProperty;var L=(r,e)=>()=>(r&&(e=r(r=0)),e);var G=(r,e)=>{for(var n in e)Se(r,n,{get:e[n],enumerable:!0})};var Q,$,F,ie,se=L(()=>{Q=["#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F","#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#E494A6","#F1A861","#86BCB6","#A8A07D","#B881A3"],$={grid:{display:!0,color:"rgba(224, 224, 224, 0.1)"},ticks:{color:"#E0E0E0",font:{size:11},padding:5}},F={display:!0,position:"top",labels:{color:"#E0E0E0",font:{size:12},padding:15}},ie={callbacks:{label:function(r){let e=r.dataset,n=r.raw;return`${e.label}: ${n.toFixed(1)} hours`}}}});async function Be(){let r=Date.now();if(!M||r-le>Ie)try{M=await window.jujuApi.loadProjects(),le=r}catch(e){console.warn("Error loading projects:",e),M=[]}return M}async function Ne(r,e){let t=(await Be()).find(o=>o.name===r);return t&&t.color?t.color:Q[e%Q.length]}async function Z(r){let e=[];for(let n=0;n<r.length;n++)e.push(await Ne(r[n],n));return e}async function ce(r,e,n,t,o=null){let a=document.getElementById(r);if(!a)return console.error(`Canvas element with ID ${r} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;if(!e.length||!n.length||n.every(i=>!i.data.length)){let i=a.getContext("2d");return i.save(),i.textAlign="center",i.textBaseline="middle",i.fillStyle="#888888",i.font="14px Poppins",i.fillText("No data available for this period",a.width/2,a.height/2),i.restore(),null}let s=a.getContext("2d"),d=n.filter(i=>i.data.some(c=>c>0)),f=d.map(i=>i.label),u=await Z(f);return d.forEach((i,c)=>{i.backgroundColor=u[c]}),new Chart(s,{type:"bar",data:{labels:e,datasets:d},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:0,bottom:0,left:0,right:0}},scales:{x:{stacked:!0,...$,ticks:{...$.ticks,callback:function(i,c){if(!e||c>=e.length)return"";let m=e[c];if(o&&o[m])return o[m];if(o&&m&&m.includes("-"))try{let v=new Date(m+"T00:00:00");return!isNaN(v.getTime())&&v.getDate()!==1?v.toLocaleDateString("en-US",{month:"numeric",day:"numeric"}):""}catch{return m}return m}}},y:{stacked:!0,...$,title:{display:!0,text:t,color:"#E0E0E0"}}},plugins:{legend:F,tooltip:ie}}})}function H(r,e,n,t=3){let o=document.getElementById(r);if(!o)return console.error(`Canvas element with ID ${r} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let a=o.getContext("2d");if(!e||!n||e.length!==4||n.length!==4)return console.warn(`[Charts] Invalid data for multi-bar comparison chart ${r}. Expected 4 labels and 4 values.`),a.save(),a.textAlign="center",a.textBaseline="middle",a.fillStyle="#888888",a.font="12px Poppins",a.fillText("Invalid data",o.width/2,o.height/2),a.restore(),null;let s="rgba(78, 121, 167, 0.4)",d="#F28E2B",f=n.map((i,c)=>c===t?d:s),u=n.map((i,c)=>c===t?d:"#4E79A7");return new Chart(a,{type:"bar",data:{labels:e,datasets:[{label:"Hours",data:n,backgroundColor:f,borderColor:u,borderWidth:1,borderRadius:4,barPercentage:1,categoryPercentage:.9}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:2,bottom:2,left:20,right:15}},scales:{x:{beginAtZero:!0,position:"top",grid:{display:!1,drawBorder:!1},ticks:{color:"#888888",font:{size:10},maxTicksLimit:4,padding:2,callback:i=>i.toFixed(1)+"h"}},y:{grid:{display:!1,drawBorder:!1},ticks:{color:"#CCCCCC",font:{size:11},padding:4,maxRotation:0,minRotation:0,autoSkip:!1,callback:function(i,c){return this.getLabelForValue(i).replace(/(Sun|Mon|Tue|Wed|Thu|Fri|Sat)day/,"$1").replace(" Weeks Ago","w ago").replace(" Months Ago","m ago")}}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,callbacks:{title:function(i){return i[0].label},label:function(i){return`Hours: ${i.parsed.x.toFixed(1)}`}}}}}})}async function de(r,e,n){let t=document.getElementById(r);if(!t)return console.error(`Canvas element with ID ${r} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let o=t.getContext("2d"),a=.01,s=[],d=[];if(e.forEach((u,i)=>{n[i]>=a&&(s.push(u),d.push(n[i]))}),s.length===0)return console.log(`[Charts] No significant data for pie chart ${r}.`),null;let f=await Z(s);return new Chart(o,{type:"pie",data:{labels:s,datasets:[{data:d,backgroundColor:f,borderColor:"#1E1E1E",borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{...F,position:"top"},tooltip:{callbacks:{label:function(u){let i=u.label||"",c=u.parsed||0,m=u.chart.data.datasets[0].data.reduce((C,b)=>C+b,0),v=m>0?(c/m*100).toFixed(1):0;return`${i}: ${c.toFixed(1)} hours (${v}%)`}}}}}})}async function ue(r,e){let n=document.getElementById(r).getContext("2d"),t=await Z(e.datasets.map(a=>a.label)),o=e.datasets.map((a,s)=>({...a,backgroundColor:t[s],borderColor:t[s],fill:!0,tension:.4,borderWidth:1,pointRadius:0,pointHoverRadius:0}));return new Chart(n,{type:"line",data:{labels:e.labels,datasets:o},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},scales:{y:{stacked:!0,...$,title:{display:!0,text:"Cumulative Hours",color:"#E0E0E0"}},x:$},plugins:{title:{display:!0,text:"Cumulative Hours by Project",color:"#E0E0E0",padding:{bottom:15}},legend:{...F,position:"bottom"},tooltip:{callbacks:{label:function(a){let s=a.dataset.label||"";return s&&(s+=": "),a.parsed.y!==null&&(s+=a.parsed.y.toFixed(1)+" total hours"),s}}}}}})}var M,le,Ie,fe=L(()=>{se();M=null,le=0,Ie=5e3});function he(r){let e=parseInt(String(r),10);if(r==null||isNaN(e)||e<0)return"?";let n=Math.floor(e/60),t=e%60;return`${n}h ${t}m`}function me(r){r=new Date(Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())),r.setUTCDate(r.getUTCDate()+4-(r.getUTCDay()||7));var e=new Date(Date.UTC(r.getUTCFullYear(),0,1)),n=Math.ceil(((r.getTime()-e.getTime())/864e5+1)/7);return n}var ee=L(()=>{});function pe(r){if(!r||r.length===0)return console.log("[Charts] No sessions for daily breakdown chart."),{labels:[],monthLabels:{},datasets:[]};let e={},n=new Set,t=null,o=null;if(r.forEach(c=>{let m=c.date;try{let v=new Date(m+"T00:00:00");if(!m||isNaN(v.getTime()))return;(t===null||v<t)&&(t=v),(o===null||v>o)&&(o=v);let C=c.project||"Unassigned";n.add(C);let b=(c.duration_minutes||0)/60;e[m]||(e[m]={}),e[m][C]=(e[m][C]||0)+b}catch{}}),t===null||o===null)return{labels:[],monthLabels:{},datasets:[]};let a=[],s={},d=new Date(t);for(new Date().setHours(0,0,0,0);d<=o;){let c=d.getFullYear(),m=(d.getMonth()+1).toString().padStart(2,"0"),v=d.getDate().toString().padStart(2,"0"),C=`${c}-${m}-${v}`;a.push(C),d.getDate()===1&&(s[C]=d.toLocaleDateString("en-GB",{month:"short"})),d.setDate(d.getDate()+1)}let i=Array.from(n).sort().map(c=>({label:c,data:a.map(m=>e[m]?.[c]||0),backgroundColor:"#000000"}));return{labels:a,monthLabels:s,datasets:i}}function ge(r){if(!r||r.length===0)return console.log("[Charts] No sessions for weekly chart."),{labels:[],datasets:[]};let e={},n=new Set,t=new Set;r.forEach(d=>{try{let f=new Date(d.date+"T00:00:00");if(isNaN(f.getTime()))return;let u=f.getFullYear(),i=me(f),c=`${u}-W${i.toString().padStart(2,"0")}`;t.add(c);let m=d.project||"Unassigned";n.add(m);let v=(d.duration_minutes||0)/60;e[c]||(e[c]={}),e[c][m]=(e[c][m]||0)+v}catch{}});let o=Array.from(t).sort(),s=Array.from(n).sort().map(d=>{let f=0,u=o.map(i=>(f+=e[i]?.[d]||0,f));return{label:d,data:u,backgroundColor:"#000000",borderWidth:2,fill:!0}});return{labels:o,datasets:s.reverse()}}function ye(r){let e={};r.forEach(o=>{let a=o.project||"Unassigned";e[a]=(e[a]||0)+(o.duration_minutes||0)});let n=Object.keys(e).sort(),t=n.map(o=>e[o]/60);return{labels:n,data:t}}var we=L(()=>{ee()});var be={};G(be,{destroyCharts:()=>ve,updateCharts:()=>Fe});function Pe(){if(typeof Chart>"u")throw new Error("Chart.js is not loaded. Cannot create charts.")}function ve(){I&&I.destroy(),B&&B.destroy(),N&&N.destroy(),_&&_.destroy(),W&&W.destroy(),Y&&Y.destroy(),I=B=N=null,_=W=Y=null,console.log("[Charts] Destroyed existing chart instances.")}async function Fe(r,e,n){try{Pe();let t=document.getElementById("chart-range-title");t&&(t.textContent=`Showing data for: ${n}`),ve(),console.log("[Charts] Called destroyCharts before creating new charts.");try{console.log("[Charts] Fetching comparison stats...");let o=await window.jujuApi.getComparisonStats();if(o){let a=o.day;if(a&&a.past&&a.current){let f=[...a.past.map(m=>m.label),a.current.label],u=[...a.past.map(m=>m.value),a.current.value];_=H("day-comparison-bar-chart",f,u,3);let i=document.getElementById("day-comparison-details");i&&(i.textContent=`Today: ${a.current.value.toFixed(1)}h (${a.current.range})`);let c=document.getElementById("day-comparison-title");c&&(c.textContent="Compared to Previous")}else console.warn("Day comparison data missing or invalid:",a);let s=o.week;if(s&&s.past&&s.current){let f=[...s.past.map(c=>c.label),s.current.label],u=[...s.past.map(c=>c.value),s.current.value];W=H("week-comparison-bar-chart",f,u,3);let i=document.getElementById("week-comparison-details");i&&(i.textContent=`This Week: ${s.current.value.toFixed(1)}h (${s.current.range})`)}else console.warn("Week comparison data missing or invalid:",s);let d=o.month;if(d&&d.past&&d.current){let f=[...d.past.map(c=>c.label),d.current.label],u=[...d.past.map(c=>c.value),d.current.value];Y=H("month-comparison-bar-chart",f,u,3);let i=document.getElementById("month-comparison-details");i&&(i.textContent=`This Month: ${d.current.value.toFixed(1)}h (${d.current.range})`)}else console.warn("Month comparison data missing or invalid:",d)}else console.warn("Comparison stats data is missing.")}catch(o){console.error("[Charts] Error with comparison stats:",o),["day","week","month"].forEach(a=>{let s=document.getElementById(`${a}-comparison-details`);s&&(s.textContent="Error loading stats")})}if(!r||r.length===0)return console.log("[Charts] No filtered session data for main charts."),{yearlyChart:null,weeklyChart:null,pieChart:null};console.log(`[Charts] Updating main charts for "${n}" with ${r.length} sessions.`);try{let o=pe(r);I=await ce("yearly-chart",o.labels,o.datasets,"Hours",o.monthLabels);let a=ge(r);B=await ue("weekly-chart",a);let s=ye(r);return N=await de("pie-chart",s.labels,s.data),{yearlyChart:I,weeklyChart:B,pieChart:N}}catch(o){return console.error("[Charts] Error creating charts:",o),{yearlyChart:null,weeklyChart:null,pieChart:null}}}catch(t){return console.error("[Charts] Error updating charts:",t),{yearlyChart:null,weeklyChart:null,pieChart:null}}}var I,B,N,_,W,Y,Ce=L(()=>{fe();we();I=null,B=null,N=null,_=null,W=null,Y=null});var Ee={};G(Ee,{default:()=>D});var te,Me,D,ne=L(()=>{te=class{constructor(){this.events={},this.notificationContainer=null,this.modal=null,this.init()}init(){this.notificationContainer=document.getElementById("notification-container"),this.modal=document.getElementById("confirmation-modal"),this.setupModalListeners()}on(e,n){this.events[e]||(this.events[e]=[]),this.events[e].push(n)}off(e,n){if(!this.events[e])return;let t=this.events[e].indexOf(n);t>-1&&this.events[e].splice(t,1)}emit(e,n){this.events[e]&&this.events[e].forEach(t=>{try{t(n)}catch(o){console.error(`Error in event handler for ${e}:`,o)}})}showNotification(e,n,t,o=5e3){if(!this.notificationContainer)return;let a=document.createElement("div");a.className=`notification ${e}`;let s=this.getNotificationIcon(e);return a.innerHTML=`
            <div class="notification-icon">${s}</div>
            <div class="notification-content">
                <div class="notification-title">${n}</div>
                <div class="notification-message">${t}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
        `,this.notificationContainer.appendChild(a),setTimeout(()=>a.classList.add("show"),10),o>0&&setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>a.remove(),300)},o),a}getNotificationIcon(e){return{success:"\u2713",error:"\u2715",warning:"\u26A0",info:"\u2139"}[e]||"\u2139"}showConfirmation(e,n,t,o){return this.modal?new Promise((a,s)=>{let d=document.getElementById("modal-title"),f=document.getElementById("modal-message"),u=document.getElementById("modal-confirm"),i=document.getElementById("modal-cancel"),c=document.getElementById("modal-close");d&&(d.textContent=e),f&&(f.textContent=n);let m=()=>{this.hideModal(),C(),t&&t(),a(!0)},v=()=>{this.hideModal(),C(),o&&o(),a(!1)},C=()=>{u.removeEventListener("click",m),i.removeEventListener("click",v),c.removeEventListener("click",v),this.modal.removeEventListener("click",b)},b=A=>{A.target===this.modal&&v()};u.addEventListener("click",m),i.addEventListener("click",v),c.addEventListener("click",v),this.modal.addEventListener("click",b),this.showModal()}):Promise.reject("Modal not found")}showModal(){this.modal&&(this.modal.classList.add("show"),document.body.style.overflow="hidden")}hideModal(){this.modal&&(this.modal.classList.remove("show"),document.body.style.overflow="")}setupModalListeners(){this.modal&&document.addEventListener("keydown",e=>{e.key==="Escape"&&this.modal.classList.contains("show")&&this.hideModal()})}async deleteWithConfirmation(e,n,t,o){let a=`Delete ${e}`,s=`Are you sure you want to delete "${t}"? This action cannot be undone.`;if(!await this.showConfirmation(a,s))return{success:!1,cancelled:!0};try{let f=await o(n);if(f&&f.success)return this.showNotification("success","Deleted",`${e} "${t}" has been deleted successfully.`),this.emit(`${e.toLowerCase()}Deleted`,{id:n,name:t}),{success:!0};{let u=f&&f.error?f.error:"Unknown error occurred";return this.showNotification("error","Delete Failed",`Failed to delete ${e.toLowerCase()}: ${u}`),{success:!1,error:u}}}catch(f){return this.showNotification("error","Delete Failed",`An error occurred while deleting the ${e.toLowerCase()}.`),{success:!1,error:f.message}}}async deleteSessionWithFallback(e,n){let t=[async o=>{if(window.jujuApi&&typeof window.jujuApi.deleteSession=="function")return await window.jujuApi.deleteSession(o);throw new Error("Delete API not available")},async o=>await this.manualDeleteSession(o)];for(let o=0;o<t.length;o++)try{let a=await this.deleteWithConfirmation("Session",e,n,t[o]);if(a.success||a.cancelled)return a}catch(a){if(o===t.length-1)throw a}}async deleteProjectWithFallback(e,n){let t=[async o=>{if(window.jujuApi&&typeof window.jujuApi.deleteProject=="function")return await window.jujuApi.deleteProject(o);throw new Error("Delete API not available")},async o=>await this.manualDeleteProject(o)];for(let o=0;o<t.length;o++)try{let a=await this.deleteWithConfirmation("Project",e,n,t[o]);if(a.success||a.cancelled)return a}catch(a){if(o===t.length-1)throw a}}async manualDeleteSession(e){throw new Error("Manual session deletion not implemented")}async manualDeleteProject(e){throw new Error("Manual project deletion not implemented")}},Me=new te,D=Me});var De={};G(De,{setupTabs:()=>He,updateSessionsTable:()=>_e});function He(){document.querySelectorAll(".tab").forEach(r=>{r.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),r.classList.add("active");let e=r.dataset.tab,n=document.getElementById(e);n&&n.classList.add("active")})})}function _e(r,e){if(U){if(U.innerHTML="",!r||r.length===0){U.innerHTML=`
            <tr><td colspan="7" class="no-data">No sessions match the current filter or page.</td></tr>`;return}r.forEach(n=>{let t=document.createElement("tr");t.setAttribute("data-session-key",`${n.id}-${n.date}-${n.start_time}`);let o="Invalid Date";try{let i=new Date(n.date+"T00:00:00");if(!isNaN(i.getTime())){let c=i.getFullYear(),m=(i.getMonth()+1).toString().padStart(2,"0"),v=i.getDate().toString().padStart(2,"0");o=`${c}-${m}-${v}`}}catch{}let a=typeof n.start_time=="string"?n.start_time.slice(0,5):"??:??",s=typeof n.end_time=="string"?n.end_time.slice(0,5):"??:??",d=n.project||"N/A",f=n.notes||"",u=`${d} on ${o}`;t.innerHTML=`
            <td class="editable" data-field="date" data-id="${n.id}">${o}</td>
            <td class="editable" data-field="project" data-id="${n.id}">${d}</td>
            <td data-field="duration_minutes" data-id="${n.id}">${he(n.duration_minutes)}</td>
            <td class="editable" data-field="start_time" data-id="${n.id}">${a}</td>
            <td class="editable" data-field="end_time" data-id="${n.id}">${s}</td>
            <td class="editable" data-field="notes" data-id="${n.id}">${f}</td>
            <td class="actions">
                <button class="btn btn-delete" data-id="${n.id}" data-info="${u}" title="Delete Session">\xD7</button>
            </td>
        `,U.appendChild(t)}),We(e),Re(e)}}function We(r){document.querySelectorAll("#recent-sessions-body td.editable").forEach(e=>{let n=Ye.bind(e,r);e.removeEventListener("click",e._boundHandleCellClick),e.addEventListener("click",n),e._boundHandleCellClick=n})}async function Ye(r){if(this.querySelector("input, textarea, select"))return;let e=this.textContent,n=this.dataset.field;this.setAttribute("data-original-value",e);let t;if(n==="project"){t=document.createElement("select"),t.classList.add("inline-edit-input"),t.style.width="100%",t.style.height="100%";try{let s=await window.jujuApi.getProjectNames();t.innerHTML="";let d=document.createElement("option");d.value="",d.text="-- Select Project --",t.add(d),s.forEach(f=>{let u=document.createElement("option");u.value=f,u.text=f,f===e&&(u.selected=!0),t.add(u)})}catch{D.showNotification("error","Error","Failed to load project names")}}else n==="start_time"||n==="end_time"?(t=document.createElement("input"),t.type="time",t.value=/^\d{2}:\d{2}$/.test(e)?e:"00:00"):n==="date"?(t=document.createElement("input"),t.type="date",t.value=/^\d{4}-\d{2}-\d{2}$/.test(e)?e:new Date().toISOString().slice(0,10)):n==="notes"?(t=document.createElement("textarea"),t.value=e,t.rows=2):(t=document.createElement("input"),t.type="text",t.value=e);t.classList.add("inline-edit-input"),t.style.width="100%",t.style.boxSizing="border-box",t.tagName==="TEXTAREA"&&(t.rows=1,t.style.resize="none",t.style.minHeight="32px",t.style.maxHeight="80px",t.style.lineHeight="1.4"),this.innerHTML="",this.appendChild(t),t.focus(),t.type==="text"&&t.select();let o=je.bind(t,r),a=Ue.bind(t,r);t.addEventListener("blur",o),t.addEventListener("keydown",a),t._boundBlurHandler=o,t._boundKeydownHandler=a}async function Ue(r,e){if(e.key==="Enter"){if(this.tagName==="TEXTAREA"&&e.shiftKey)return;e.preventDefault(),await je.call(this,r)}else if(e.key==="Escape"){let n=this.parentElement,t=n.getAttribute("data-original-value");this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),n.textContent=t,n.removeAttribute("data-original-value")}}async function je(r){let e=this.parentElement;if(!e||!e.dataset){this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler);try{this.remove()}catch{}return}let n=this.value.trim(),t=e.getAttribute("data-original-value"),o=e.dataset.id,a=e.dataset.field;if(this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),n===t){e.textContent=t,e.removeAttribute("data-original-value");return}try{let s=await window.jujuApi.updateSession(Number(o),a,n);e.classList.add("success"),setTimeout(()=>e.classList.remove("success"),1e3),D.showNotification("success","Updated",`Session ${a} updated successfully`),window.jujuApi&&typeof window.jujuApi.loadSessions=="function"?window.jujuApi.loadSessions():typeof r=="function"&&r()}catch(s){e.classList.add("error"),setTimeout(()=>e.classList.remove("error"),1200),e.textContent=t,D.showNotification("error","Update Failed",`Failed to update session: ${s.message}`)}finally{e.removeAttribute("data-original-value")}}function Re(r){document.querySelectorAll("#recent-sessions-body .btn-delete").forEach(e=>{e._boundDeleteHandler&&e.removeEventListener("click",e._boundDeleteHandler);let n=async t=>{t.preventDefault(),t.stopPropagation();let o=t.target.dataset.id,a=t.target.dataset.info||`Session ${o}`;if(!o){D.showNotification("error","Error","Session ID not found");return}try{let s=await D.deleteSessionWithFallback(o,a);s.success?typeof r=="function"&&r():s.cancelled||console.error("Session deletion failed:",s.error)}catch{D.showNotification("error","Delete Failed","An unexpected error occurred while deleting the session")}};e.addEventListener("click",n),e._boundDeleteHandler=n})}var U,ke=L(()=>{ee();ne();U=document.getElementById("recent-sessions-body")});document.addEventListener("DOMContentLoaded",async()=>{try{let V=function(l,h=null,g=null){let p=new Date;p.setHours(0,0,0,0);let y=new Date(p),w=new Date(p);w.setHours(23,59,59,999);let E="";switch(l){case"7d":y.setDate(p.getDate()-6),E="Last 7 Days";break;case"1m":y=new Date(p.getFullYear(),p.getMonth()-1,p.getDate()),E="Last Month";break;case"3m":y=new Date(p.getFullYear(),p.getMonth()-3,p.getDate()),E="Last Quarter";break;case"1y":y=new Date(p.getFullYear(),0,1),E="This Year";break;case"all":y=null,w=null,E="All Time";break;case"custom":try{if(y=h?new Date(h+"T00:00:00"):null,w=g?new Date(g+"T23:59:59.999"):null,y&&w&&y>w)return u.showNotification("warning","Invalid Range","Start date cannot be after end date."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"};E=`Custom (${h||"..."} - ${g||"..."})`}catch{return u.showNotification("error","Invalid Date","Invalid custom date format."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"}}break;default:y=new Date(p.getFullYear(),0,1),E="This Year"}return y&&!(y instanceof Date&&!isNaN(y))&&(y=null),w&&!(w instanceof Date&&!isNaN(w))&&(w=null),{startDate:y,endDate:w,rangeTitle:E}},q=function(l,h){return i?l===null&&h===null?[...i]:i.filter(g=>{try{let p=new Date(g.date+"T00:00:00");if(isNaN(p.getTime()))return!1;let y=l===null||p>=l,w=h===null||p<=h;return y&&w}catch{return!1}}):[]},P=function(){if(!T)return;let l=T.value;T.innerHTML='<option value="All">All Projects</option>',c&&c.length>0&&c.forEach(h=>{let g=document.createElement("option");g.value=h.name,g.textContent=h.name,h.name===l&&(g.selected=!0),T.appendChild(g)})},K=function(){if(!i)return{visibleSessions:[],totalPages:1};let l=[...i];A&&A!=="All"&&(l=l.filter(w=>w.project===A)),l.sort((w,E)=>{try{let j=w.start_time||"00:00",J=E.start_time||"00:00",X=new Date(`${w.date}T${j}`),re=new Date(`${E.date}T${J}`);if(isNaN(X.getTime())||isNaN(re.getTime())){let Te=new Date(w.date+"T00:00:00");return new Date(E.date+"T00:00:00")-Te}return re.getTime()-X.getTime()}catch{let J=new Date(w.date+"T00:00:00");return new Date(E.date+"T00:00:00")-J}});let h=Math.ceil(l.length/C),g=(b-1)*C,p=g+C;return{visibleSessions:l.slice(g,p),totalPages:h}},S=function(){let{visibleSessions:l,totalPages:h}=K();f(l,k),ae&&(ae.textContent=`Page ${b} of ${h}`),O&&(O.disabled=b<=1),z&&(z.disabled=b>=h)};var r=V,e=q,n=P,t=K,o=S;let{updateCharts:a,destroyCharts:s}=await Promise.resolve().then(()=>(Ce(),be)),{setupTabs:d,updateSessionsTable:f}=await Promise.resolve().then(()=>(ke(),De)),u=await Promise.resolve().then(()=>(ne(),Ee)).then(l=>l.default),i=[],c=[],m="1y",v="This Year",C=20,b=1,A="All",R=document.querySelectorAll(".btn-filter"),Le=document.getElementById("date-from"),Ae=document.getElementById("date-to"),xe=document.getElementById("apply-custom-date"),T=document.getElementById("project-filter-select"),O=document.getElementById("prev-page-btn"),z=document.getElementById("next-page-btn"),ae=document.getElementById("page-info");window.onSessionsLoaded=function(l){if(typeof l=="string")try{l=JSON.parse(l)}catch{l=[]}window.allSessions=l,i=l,k()},window.onProjectsLoaded=function(l){if(typeof l=="string")try{l=JSON.parse(l)}catch{l=[]}c=l,P(),typeof x=="function"&&x()};async function oe(l){let h=null,g=null;if(l==="custom"&&(h=Le.value,g=Ae.value,!h||!g)){u.showNotification("warning","Invalid Range",'Please select both "From" and "To" dates for custom range.');return}let{startDate:p,endDate:y,rangeTitle:w}=V(l,h,g);if(w==="Invalid Range")return;let E=q(p,y);m=l,v=w,R.forEach(j=>{j.dataset.range===l?j.classList.add("active"):j.classList.remove("active")}),l==="custom"&&R.forEach(j=>{j.closest(".date-filter-buttons")&&j.classList.remove("active")});try{await a(E,i,w)}catch{u.showNotification("error","Chart Error","Failed to update charts")}}async function k(){if(!i)return;let{startDate:l,endDate:h}=V(m),g=q(l,h);try{await a(g,i,v)}catch{u.showNotification("error","Chart Error","Failed to update charts")}P(),S()}async function $e(){let l=document.getElementById("projects-list"),h=document.getElementById("add-project-form");!l||!h||(await x(),h.addEventListener("submit",async g=>{g.preventDefault();let p=document.getElementById("new-project-name"),y=document.getElementById("new-project-color");if(!(!p||!y))try{let w=await window.jujuApi.addProject({name:p.value.trim(),color:y.value});w&&w.success&&(p.value="",y.value="#4E79A7",await x(),await k(),u.showNotification("success","Project Added",`Project "${p.value.trim()}" created successfully`))}catch(w){u.showNotification("error","Add Failed",`Failed to add project: ${w.message}`)}}))}async function x(){let l=document.getElementById("projects-list");if(l)try{l.innerHTML="",c.forEach(h=>{let g=document.createElement("div");g.className="project-item",g.innerHTML=`
                        <div class="project-info">
                            <span class="project-name">${h.name}</span>
                            <div class="project-color">
                                <input type="color" value="${h.color||"#4E79A7"}" 
                                       data-project-id="${h.id}">
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-delete" data-id="${h.id}" data-name="${h.name}" title="Delete Project" aria-label="Delete Project">&times;</button>
                        </div>
                    `;let p=g.querySelector('input[type="color"]');p&&p.addEventListener("change",async y=>{try{await window.jujuApi.updateProjectColor(h.id,y.target.value),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),u.showNotification("success","Color Updated",`Project "${h.name}" color updated`)}catch(w){u.showNotification("error","Update Failed",`Failed to update color: ${w.message}`)}}),l.appendChild(g)}),P()}catch{l.innerHTML='<div class="error">Failed to load projects</div>',u.showNotification("error","Load Failed","Failed to load projects")}}R.forEach(l=>{l.closest(".date-filter-buttons")&&l.addEventListener("click",()=>oe(l.dataset.range))}),xe.addEventListener("click",()=>oe("custom")),T?.addEventListener("change",l=>{A=l.target.value,b=1,S()}),O?.addEventListener("click",()=>{b>1&&(b--,S())}),z?.addEventListener("click",()=>{let{totalPages:l}=K();b<l&&(b++,S())}),document.getElementById("projects-list").addEventListener("click",async function(l){if(l.target.classList.contains("btn-delete")){l.preventDefault(),l.stopPropagation();let h=l.target,g=h.dataset.id,p=h.dataset.name||`Project ${g}`;if(!g){u.showNotification("error","Error","Project ID not found");return}try{let y=await u.deleteProjectWithFallback(g,p);y.success?(await x(),await k(),window.jujuApi&&typeof window.jujuApi.refreshMenu=="function"&&window.jujuApi.refreshMenu()):y.cancelled||console.error("Project deletion failed:",y.error)}catch{u.showNotification("error","Delete Failed","An unexpected error occurred while deleting the project")}}}),d(),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),await $e(),await k(),u.on("sessionDeleted",()=>{k()}),u.on("projectDeleted",()=>{x(),k()})}catch(a){eventSystem&&eventSystem.showNotification("error","Initialization Failed","Failed to initialize dashboard. Please check console for details.");let s=document.getElementById("charts");s&&(s.innerHTML=`<div class="error-message">Failed to initialize dashboard. Please check console for details. Error: ${a.message}</div>`)}});})();
