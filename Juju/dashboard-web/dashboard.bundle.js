(()=>{var St=Object.defineProperty;var L=(o,t)=>()=>(o&&(t=o(o=0)),t);var Q=(o,t)=>{for(var n in t)St(o,n,{get:t[n],enumerable:!0})};var tt,$,F,st,lt=L(()=>{tt=["#4E79A7","#F28E2B","#E15759","#76B7B2","#59A14F","#EDC948","#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#E494A6","#F1A861","#86BCB6","#A8A07D","#B881A3"],$={grid:{display:!0,color:"rgba(224, 224, 224, 0.1)"},ticks:{color:"#E0E0E0",font:{size:11},padding:5}},F={display:!0,position:"top",labels:{color:"#E0E0E0",font:{size:12},padding:15}},st={callbacks:{label:function(o){let t=o.dataset,n=o.raw;return`${t.label}: ${n.toFixed(1)} hours`}}}});async function Nt(){let o=Date.now();if(!H||o-ct>Pt)try{H=await window.jujuApi.loadProjects(),ct=o}catch(t){console.warn("Error loading projects:",t),H=[]}return H}async function Ft(o,t){let e=(await Nt()).find(a=>a.name===o);return e&&e.color?e.color:tt[t%tt.length]}async function M(o){let t=[];for(let n=0;n<o.length;n++)t.push(await Ft(o[n],n));return t}async function dt(o,t,n,e,a=null){let r=document.getElementById(o);if(!r)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;if(!t.length||!n.length||n.every(s=>!s.data.length)){let s=r.getContext("2d");return s.save(),s.textAlign="center",s.textBaseline="middle",s.fillStyle="#888888",s.font="14px Poppins",s.fillText("No data available for this period",r.width/2,r.height/2),s.restore(),null}let i=r.getContext("2d"),c=n.filter(s=>s.data.some(d=>d>0)),h=c.map(s=>s.label),u=await M(h);return c.forEach((s,d)=>{s.backgroundColor=u[d]}),new Chart(i,{type:"bar",data:{labels:t,datasets:c},options:{indexAxis:"x",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:0,bottom:0,left:0,right:0}},scales:{x:{stacked:!0,...$,ticks:{...$.ticks,callback:function(s,d){if(!t||d>=t.length)return"";let m=t[d];if(a&&a[m])return a[m];if(a&&m&&m.includes("-"))try{let b=new Date(m+"T00:00:00");return!isNaN(b.getTime())&&b.getDate()!==1?b.toLocaleDateString("en-US",{month:"numeric",day:"numeric"}):""}catch{return m}return m}}},y:{stacked:!0,...$,title:{display:!0,text:e,color:"#E0E0E0"}}},plugins:{legend:F,tooltip:st}}})}function _(o,t,n,e=3){let a=document.getElementById(o);if(!a)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let r=a.getContext("2d");if(!t||!n||t.length!==4||n.length!==4)return console.warn(`[Charts] Invalid data for multi-bar comparison chart ${o}. Expected 4 labels and 4 values.`),r.save(),r.textAlign="center",r.textBaseline="middle",r.fillStyle="#888888",r.font="12px Poppins",r.fillText("Invalid data",a.width/2,a.height/2),r.restore(),null;let i="rgba(78, 121, 167, 0.4)",c="#F28E2B",h=n.map((s,d)=>d===e?c:i),u=n.map((s,d)=>d===e?c:"#4E79A7");return new Chart(r,{type:"bar",data:{labels:t,datasets:[{label:"Hours",data:n,backgroundColor:h,borderColor:u,borderWidth:1,borderRadius:4,barPercentage:1,categoryPercentage:.9}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:2,bottom:2,left:20,right:15}},scales:{x:{beginAtZero:!0,position:"top",grid:{display:!1,drawBorder:!1},ticks:{color:"#888888",font:{size:10},maxTicksLimit:4,padding:2,callback:s=>s.toFixed(1)+"h"}},y:{grid:{display:!1,drawBorder:!1},ticks:{color:"#CCCCCC",font:{size:11},padding:4,maxRotation:0,minRotation:0,autoSkip:!1,callback:function(s,d){return this.getLabelForValue(s).replace(/(Sun|Mon|Tue|Wed|Thu|Fri|Sat)day/,"$1").replace(" Weeks Ago","w ago").replace(" Months Ago","m ago")}}}},plugins:{legend:{display:!1},tooltip:{enabled:!0,callbacks:{title:function(s){return s[0].label},label:function(s){return`Hours: ${s.parsed.x.toFixed(1)}`}}}}}})}async function ut(o,t,n){let e=document.getElementById(o);if(!e)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded."),null;let a=e.getContext("2d"),r=.01,i=[],c=[];if(t.forEach((u,s)=>{n[s]>=r&&(i.push(u),c.push(n[s]))}),i.length===0)return console.log(`[Charts] No significant data for pie chart ${o}.`),null;let h=await M(i);return new Chart(a,{type:"pie",data:{labels:i,datasets:[{data:c,backgroundColor:h,borderColor:"#1E1E1E",borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{...F,position:"top"},tooltip:{callbacks:{label:function(u){let s=u.label||"",d=u.parsed||0,m=u.chart.data.datasets[0].data.reduce((C,E)=>C+E,0),b=m>0?(d/m*100).toFixed(1):0;return`${s}: ${d.toFixed(1)} hours (${b}%)`}}}}}})}async function ft(o,t,n="Weekly Hours by Project"){let e=document.getElementById(o).getContext("2d"),a=await M(t.datasets.map(i=>i.label)),r=t.datasets.map((i,c)=>({...i,backgroundColor:a[c],borderColor:a[c],fill:!0,tension:.4,borderWidth:1,pointRadius:0,pointHoverRadius:0}));return new Chart(e,{type:"line",data:{labels:t.labels,datasets:r},options:{responsive:!0,maintainAspectRatio:!1,interaction:{intersect:!1,mode:"index"},scales:{y:{stacked:!0,...$,title:{display:!0,text:"Hours",color:"#E0E0E0"}},x:$},plugins:{title:{display:!0,text:n,color:"#E0E0E0",padding:{bottom:15}},legend:{...F,position:"bottom"},tooltip:{callbacks:{label:function(i){let c=i.dataset.label||"";return c&&(c+=": "),i.parsed.y!==null&&(c+=i.parsed.y.toFixed(1)+" hours"),c}}}}}})}async function ht(o,t,n){let e=document.getElementById(o);if(!e)return console.error(`Canvas element with ID ${o} not found.`),null;if(typeof Chart>"u")return console.error("Chart.js is not loaded. Cannot create chart."),null;let a=e.getContext("2d"),r=await M(t);return new Chart(a,{type:"bar",data:{labels:t,datasets:[{label:"Total Hours",data:n,backgroundColor:r,borderColor:"#1E1E1E",borderWidth:1,borderRadius:6,maxBarThickness:48}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:{top:10,bottom:10,left:10,right:10}},scales:{x:{grid:{display:!1},ticks:{color:"#E0E0E0",font:{size:12},autoSkip:!1}},y:{beginAtZero:!0,grid:{color:"rgba(224, 224, 224, 0.1)"},title:{display:!0,text:"Total Hours",color:"#E0E0E0"},ticks:{color:"#E0E0E0",font:{size:12}}}},plugins:{legend:{display:!1},title:{display:!0,text:"Total Hours by Project",color:"#E0E0E0",padding:{bottom:10}},tooltip:{callbacks:{label:function(i){return`${i.label}: ${i.parsed.y.toFixed(1)} hours`}}}}}})}var H,ct,Pt,mt=L(()=>{lt();H=null,ct=0,Pt=5e3});function pt(o){let t=parseInt(String(o),10);if(o==null||isNaN(t)||t<0)return"?";let n=Math.floor(t/60),e=t%60;return`${n}h ${e}m`}function gt(o){o=new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate())),o.setUTCDate(o.getUTCDate()+4-(o.getUTCDay()||7));var t=new Date(Date.UTC(o.getUTCFullYear(),0,1)),n=Math.ceil(((o.getTime()-t.getTime())/864e5+1)/7);return n}var et=L(()=>{});function yt(o){if(!o||o.length===0)return console.log("[Charts] No sessions for daily breakdown chart."),{labels:[],monthLabels:{},datasets:[]};let t={},n=new Set,e=null,a=null;if(o.forEach(d=>{let m=d.date;try{let b=new Date(m+"T00:00:00");if(!m||isNaN(b.getTime()))return;(e===null||b<e)&&(e=b),(a===null||b>a)&&(a=b);let C=d.project||"Unassigned";n.add(C);let E=(d.duration_minutes||0)/60;t[m]||(t[m]={}),t[m][C]=(t[m][C]||0)+E}catch{}}),e===null||a===null)return{labels:[],monthLabels:{},datasets:[]};let r=[],i={},c=new Date(e);for(new Date().setHours(0,0,0,0);c<=a;){let d=c.getFullYear(),m=(c.getMonth()+1).toString().padStart(2,"0"),b=c.getDate().toString().padStart(2,"0"),C=`${d}-${m}-${b}`;r.push(C),c.getDate()===1&&(i[C]=c.toLocaleDateString("en-GB",{month:"short"})),c.setDate(c.getDate()+1)}let s=Array.from(n).sort().map(d=>({label:d,data:r.map(m=>t[m]?.[d]||0),backgroundColor:"#000000"}));return{labels:r,monthLabels:i,datasets:s}}function wt(o){if(!o||o.length===0)return console.log("[Charts] No sessions for weekly chart."),{labels:[],datasets:[]};let t={},n=new Set,e=new Set;o.forEach(c=>{try{let h=new Date(c.date+"T00:00:00");if(isNaN(h.getTime()))return;let u=h.getFullYear(),s=gt(h),d=`${u}-W${s.toString().padStart(2,"0")}`;e.add(d);let m=c.project||"Unassigned";n.add(m);let b=(c.duration_minutes||0)/60;t[d]||(t[d]={}),t[d][m]=(t[d][m]||0)+b}catch{}});let a=Array.from(e).sort(),i=Array.from(n).sort().map(c=>{let h=a.map(u=>t[u]?.[c]||0);return{label:c,data:h,backgroundColor:"#000000",borderWidth:2,fill:!0}});return{labels:a,datasets:i.reverse()}}function bt(o){let t={};o.forEach(a=>{let r=a.project||"Unassigned";t[r]=(t[r]||0)+(a.duration_minutes||0)});let n=Object.keys(t).sort(),e=n.map(a=>t[a]/60);return{labels:n,data:e}}var Et=L(()=>{et()});var vt={};Q(vt,{destroyCharts:()=>Ct,updateCharts:()=>Mt});function Ht(){if(typeof Chart>"u")throw new Error("Chart.js is not loaded. Cannot create charts.")}function Ct(){I&&I.destroy(),S&&S.destroy(),P&&P.destroy(),W&&W.destroy(),Y&&Y.destroy(),R&&R.destroy(),U&&U.destroy(),I=S=P=null,W=Y=R=null,U=null,console.log("[Charts] Destroyed existing chart instances.")}async function Mt(o,t,n){try{Ht();let e=document.getElementById("chart-range-title");e&&(e.textContent=`Showing data for: ${n}`),Ct(),console.log("[Charts] Called destroyCharts before creating new charts.");try{console.log("[Charts] Fetching comparison stats...");let a=await window.jujuApi.getComparisonStats();if(a){let r=a.day;if(r&&r.past&&r.current){let h=[...r.past.map(m=>m.label),r.current.label],u=[...r.past.map(m=>m.value),r.current.value];W=_("day-comparison-bar-chart",h,u,3);let s=document.getElementById("day-comparison-details");s&&(s.textContent=`Today: ${r.current.value.toFixed(1)}h (${r.current.range})`);let d=document.getElementById("day-comparison-title");d&&(d.textContent="Compared to Previous")}else console.warn("Day comparison data missing or invalid:",r);let i=a.week;if(i&&i.past&&i.current){let h=[...i.past.map(d=>d.label),i.current.label],u=[...i.past.map(d=>d.value),i.current.value];Y=_("week-comparison-bar-chart",h,u,3);let s=document.getElementById("week-comparison-details");s&&(s.textContent=`This Week: ${i.current.value.toFixed(1)}h (${i.current.range})`)}else console.warn("Week comparison data missing or invalid:",i);let c=a.month;if(c&&c.past&&c.current){let h=[...c.past.map(d=>d.label),c.current.label],u=[...c.past.map(d=>d.value),c.current.value];R=_("month-comparison-bar-chart",h,u,3);let s=document.getElementById("month-comparison-details");s&&(s.textContent=`This Month: ${c.current.value.toFixed(1)}h (${c.current.range})`)}else console.warn("Month comparison data missing or invalid:",c)}else console.warn("Comparison stats data is missing.")}catch(a){console.error("[Charts] Error with comparison stats:",a),["day","week","month"].forEach(r=>{let i=document.getElementById(`${r}-comparison-details`);i&&(i.textContent="Error loading stats")})}if(!o||o.length===0)return console.log("[Charts] No filtered session data for main charts."),{yearlyChart:null,weeklyChart:null,pieChart:null};console.log(`[Charts] Updating main charts for "${n}" with ${o.length} sessions.`);try{let a=yt(o);I=await dt("yearly-chart",a.labels,a.datasets,"Hours",a.monthLabels);let r=wt(o);S=await ft("weekly-chart",r,"Weekly Hours by Project");let i=bt(o);return P=await ut("pie-chart",i.labels,i.data),U=await ht("project-bar-chart",i.labels,i.data),{yearlyChart:I,weeklyChart:S,pieChart:P}}catch(a){return console.error("[Charts] Error creating charts:",a),{yearlyChart:null,weeklyChart:null,pieChart:null}}}catch(e){return console.error("[Charts] Error updating charts:",e),{yearlyChart:null,weeklyChart:null,pieChart:null}}}var I,S,P,W,Y,R,U,jt=L(()=>{mt();Et();I=null,S=null,P=null,W=null,Y=null,R=null,U=null});var Dt={};Q(Dt,{default:()=>D});var nt,_t,D,at=L(()=>{nt=class{constructor(){this.events={},this.notificationContainer=null,this.modal=null,this.init()}init(){this.notificationContainer=document.getElementById("notification-container"),this.modal=document.getElementById("confirmation-modal"),this.setupModalListeners()}on(t,n){this.events[t]||(this.events[t]=[]),this.events[t].push(n)}off(t,n){if(!this.events[t])return;let e=this.events[t].indexOf(n);e>-1&&this.events[t].splice(e,1)}emit(t,n){this.events[t]&&this.events[t].forEach(e=>{try{e(n)}catch(a){console.error(`Error in event handler for ${t}:`,a)}})}showNotification(t,n,e,a=5e3){if(!this.notificationContainer)return;let r=document.createElement("div");r.className=`notification ${t}`;let i=this.getNotificationIcon(t);return r.innerHTML=`
            <div class="notification-icon">${i}</div>
            <div class="notification-content">
                <div class="notification-title">${n}</div>
                <div class="notification-message">${e}</div>
            </div>
            <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
        `,this.notificationContainer.appendChild(r),setTimeout(()=>r.classList.add("show"),10),a>0&&setTimeout(()=>{r.classList.remove("show"),setTimeout(()=>r.remove(),300)},a),r}getNotificationIcon(t){return{success:"\u2713",error:"\u2715",warning:"\u26A0",info:"\u2139"}[t]||"\u2139"}showConfirmation(t,n,e,a){return this.modal?new Promise((r,i)=>{let c=document.getElementById("modal-title"),h=document.getElementById("modal-message"),u=document.getElementById("modal-confirm"),s=document.getElementById("modal-cancel"),d=document.getElementById("modal-close");c&&(c.textContent=t),h&&(h.textContent=n);let m=()=>{this.hideModal(),C(),e&&e(),r(!0)},b=()=>{this.hideModal(),C(),a&&a(),r(!1)},C=()=>{u.removeEventListener("click",m),s.removeEventListener("click",b),d.removeEventListener("click",b),this.modal.removeEventListener("click",E)},E=x=>{x.target===this.modal&&b()};u.addEventListener("click",m),s.addEventListener("click",b),d.addEventListener("click",b),this.modal.addEventListener("click",E),this.showModal()}):Promise.reject("Modal not found")}showModal(){this.modal&&(this.modal.classList.add("show"),document.body.style.overflow="hidden")}hideModal(){this.modal&&(this.modal.classList.remove("show"),document.body.style.overflow="")}setupModalListeners(){this.modal&&document.addEventListener("keydown",t=>{t.key==="Escape"&&this.modal.classList.contains("show")&&this.hideModal()})}async deleteWithConfirmation(t,n,e,a){let r=`Delete ${t}`,i=`Are you sure you want to delete "${e}"? This action cannot be undone.`;if(!await this.showConfirmation(r,i))return{success:!1,cancelled:!0};try{let h=await a(n);if(h&&h.success)return this.showNotification("success","Deleted",`${t} "${e}" has been deleted successfully.`),this.emit(`${t.toLowerCase()}Deleted`,{id:n,name:e}),{success:!0};{let u=h&&h.error?h.error:"Unknown error occurred";return this.showNotification("error","Delete Failed",`Failed to delete ${t.toLowerCase()}: ${u}`),{success:!1,error:u}}}catch(h){return this.showNotification("error","Delete Failed",`An error occurred while deleting the ${t.toLowerCase()}.`),{success:!1,error:h.message}}}async deleteSessionWithFallback(t,n){let e=[async a=>{if(window.jujuApi&&typeof window.jujuApi.deleteSession=="function")return await window.jujuApi.deleteSession(a);throw new Error("Delete API not available")},async a=>await this.manualDeleteSession(a)];for(let a=0;a<e.length;a++)try{let r=await this.deleteWithConfirmation("Session",t,n,e[a]);if(r.success||r.cancelled)return r}catch(r){if(a===e.length-1)throw r}}async deleteProjectWithFallback(t,n){let e=[async a=>{if(window.jujuApi&&typeof window.jujuApi.deleteProject=="function")return await window.jujuApi.deleteProject(a);throw new Error("Delete API not available")},async a=>await this.manualDeleteProject(a)];for(let a=0;a<e.length;a++)try{let r=await this.deleteWithConfirmation("Project",t,n,e[a]);if(r.success||r.cancelled)return r}catch(r){if(a===e.length-1)throw r}}async manualDeleteSession(t){throw new Error("Manual session deletion not implemented")}async manualDeleteProject(t){throw new Error("Manual project deletion not implemented")}},_t=new nt,D=_t});var Lt={};Q(Lt,{setupTabs:()=>Wt,updateSessionsTable:()=>Yt});function Wt(){document.querySelectorAll(".tab").forEach(o=>{o.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),o.classList.add("active");let t=o.dataset.tab,n=document.getElementById(t);n&&n.classList.add("active")})})}function Yt(o,t){if(z){if(z.innerHTML="",!o||o.length===0){z.innerHTML=`
            <tr><td colspan="7" class="no-data">No sessions match the current filter or page.</td></tr>`;return}o.forEach(n=>{let e=document.createElement("tr");e.setAttribute("data-session-key",`${n.id}-${n.date}-${n.start_time}`);let a="Invalid Date";try{let s=new Date(n.date+"T00:00:00");if(!isNaN(s.getTime())){let d=s.getFullYear(),m=(s.getMonth()+1).toString().padStart(2,"0"),b=s.getDate().toString().padStart(2,"0");a=`${d}-${m}-${b}`}}catch{}let r=typeof n.start_time=="string"?n.start_time.slice(0,5):"??:??",i=typeof n.end_time=="string"?n.end_time.slice(0,5):"??:??",c=n.project||"N/A",h=n.notes||"",u=`${c} on ${a}`;e.innerHTML=`
            <td class="editable" data-field="date" data-id="${n.id}">${a}</td>
            <td class="editable" data-field="project" data-id="${n.id}">${c}</td>
            <td data-field="duration_minutes" data-id="${n.id}">${pt(n.duration_minutes)}</td>
            <td class="editable" data-field="start_time" data-id="${n.id}">${r}</td>
            <td class="editable" data-field="end_time" data-id="${n.id}">${i}</td>
            <td class="editable" data-field="notes" data-id="${n.id}">${h}</td>
            <td class="actions">
                <button class="btn btn-delete" data-id="${n.id}" data-info="${u}" title="Delete Session">\xD7</button>
            </td>
        `,z.appendChild(e)}),Rt(t),Ot(t)}}function Rt(o){document.querySelectorAll("#recent-sessions-body td.editable").forEach(t=>{let n=Ut.bind(t,o);t.removeEventListener("click",t._boundHandleCellClick),t.addEventListener("click",n),t._boundHandleCellClick=n})}async function Ut(o){if(this.querySelector("input, textarea, select"))return;let t=this.textContent,n=this.dataset.field;this.setAttribute("data-original-value",t);let e;if(n==="project"){e=document.createElement("select"),e.classList.add("inline-edit-input"),e.style.width="100%",e.style.height="100%";try{let i=await window.jujuApi.getProjectNames();e.innerHTML="";let c=document.createElement("option");c.value="",c.text="-- Select Project --",e.add(c),i.forEach(h=>{let u=document.createElement("option");u.value=h,u.text=h,h===t&&(u.selected=!0),e.add(u)})}catch{D.showNotification("error","Error","Failed to load project names")}}else n==="start_time"||n==="end_time"?(e=document.createElement("input"),e.type="time",e.value=/^\d{2}:\d{2}$/.test(t)?t:"00:00"):n==="date"?(e=document.createElement("input"),e.type="date",e.value=/^\d{4}-\d{2}-\d{2}$/.test(t)?t:new Date().toISOString().slice(0,10)):n==="notes"?(e=document.createElement("textarea"),e.value=t,e.rows=2):(e=document.createElement("input"),e.type="text",e.value=t);e.classList.add("inline-edit-input"),e.style.width="100%",e.style.boxSizing="border-box",e.tagName==="TEXTAREA"&&(e.rows=1,e.style.resize="none",e.style.minHeight="32px",e.style.maxHeight="80px",e.style.lineHeight="1.4"),this.innerHTML="",this.appendChild(e),e.focus(),e.type==="text"&&e.select();let a=kt.bind(e,o),r=zt.bind(e,o);e.addEventListener("blur",a),e.addEventListener("keydown",r),e._boundBlurHandler=a,e._boundKeydownHandler=r}async function zt(o,t){if(t.key==="Enter"){if(this.tagName==="TEXTAREA"&&t.shiftKey)return;t.preventDefault(),await kt.call(this,o)}else if(t.key==="Escape"){let n=this.parentElement,e=n.getAttribute("data-original-value");this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),n.textContent=e,n.removeAttribute("data-original-value")}}async function kt(o){let t=this.parentElement;if(!t||!t.dataset){this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler);try{this.remove()}catch{}return}let n=this.value.trim(),e=t.getAttribute("data-original-value"),a=t.dataset.id,r=t.dataset.field;if(this.removeEventListener("blur",this._boundBlurHandler),this.removeEventListener("keydown",this._boundKeydownHandler),n===e){t.textContent=e,t.removeAttribute("data-original-value");return}try{let i=await window.jujuApi.updateSession(Number(a),r,n);t.classList.add("success"),setTimeout(()=>t.classList.remove("success"),1e3),D.showNotification("success","Updated",`Session ${r} updated successfully`),window.jujuApi&&typeof window.jujuApi.loadSessions=="function"?window.jujuApi.loadSessions():typeof o=="function"&&o()}catch(i){t.classList.add("error"),setTimeout(()=>t.classList.remove("error"),1200),t.textContent=e,D.showNotification("error","Update Failed",`Failed to update session: ${i.message}`)}finally{t.removeAttribute("data-original-value")}}function Ot(o){document.querySelectorAll("#recent-sessions-body .btn-delete").forEach(t=>{t._boundDeleteHandler&&t.removeEventListener("click",t._boundDeleteHandler);let n=async e=>{e.preventDefault(),e.stopPropagation();let a=e.target.dataset.id,r=e.target.dataset.info||`Session ${a}`;if(!a){D.showNotification("error","Error","Session ID not found");return}try{let i=await D.deleteSessionWithFallback(a,r);i.success?typeof o=="function"&&o():i.cancelled||console.error("Session deletion failed:",i.error)}catch{D.showNotification("error","Delete Failed","An unexpected error occurred while deleting the session")}};t.addEventListener("click",n),t._boundDeleteHandler=n})}var z,xt=L(()=>{et();at();z=document.getElementById("recent-sessions-body")});document.addEventListener("DOMContentLoaded",async()=>{try{let K=function(l,f=null,g=null){let p=new Date;p.setHours(0,0,0,0);let y=new Date(p),w=new Date(p);w.setHours(23,59,59,999);let v="";switch(l){case"7d":y.setDate(p.getDate()-6),v="Last 7 Days";break;case"1m":y=new Date(p.getFullYear(),p.getMonth()-1,p.getDate()),v="Last Month";break;case"3m":y=new Date(p.getFullYear(),p.getMonth()-3,p.getDate()),v="Last Quarter";break;case"1y":y=new Date(p.getFullYear(),0,1),v="This Year";break;case"all":y=null,w=null,v="All Time";break;case"custom":try{if(y=f?new Date(f+"T00:00:00"):null,w=g?new Date(g+"T23:59:59.999"):null,y&&w&&y>w)return u.showNotification("warning","Invalid Range","Start date cannot be after end date."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"};v=`Custom (${f||"..."} - ${g||"..."})`}catch{return u.showNotification("error","Invalid Date","Invalid custom date format."),{startDate:null,endDate:null,rangeTitle:"Invalid Range"}}break;default:y=new Date(p.getFullYear(),0,1),v="This Year"}return y&&!(y instanceof Date&&!isNaN(y))&&(y=null),w&&!(w instanceof Date&&!isNaN(w))&&(w=null),{startDate:y,endDate:w,rangeTitle:v}},J=function(l,f){return s?l===null&&f===null?[...s]:s.filter(g=>{try{let p=new Date(g.date+"T00:00:00");if(isNaN(p.getTime()))return!1;let y=l===null||p>=l,w=f===null||p<=f;return y&&w}catch{return!1}}):[]},N=function(){if(!T)return;let l=T.value;T.innerHTML='<option value="All">All Projects</option>',d&&d.length>0&&d.forEach(f=>{let g=document.createElement("option");g.value=f.name,g.textContent=f.name,f.name===l&&(g.selected=!0),T.appendChild(g)})},X=function(){if(!s)return{visibleSessions:[],totalPages:1};let l=[...s];x&&x!=="All"&&(l=l.filter(w=>w.project===x)),l.sort((w,v)=>{try{let j=w.start_time||"00:00",Z=v.start_time||"00:00",G=new Date(`${w.date}T${j}`),it=new Date(`${v.date}T${Z}`);if(isNaN(G.getTime())||isNaN(it.getTime())){let It=new Date(w.date+"T00:00:00");return new Date(v.date+"T00:00:00")-It}return it.getTime()-G.getTime()}catch{let Z=new Date(w.date+"T00:00:00");return new Date(v.date+"T00:00:00")-Z}});let f=Math.ceil(l.length/C),g=(E-1)*C,p=g+C;return{visibleSessions:l.slice(g,p),totalPages:f}},B=function(){let{visibleSessions:l,totalPages:f}=X();h(l,k),ot&&(ot.textContent=`Page ${E} of ${f}`),V&&(V.disabled=E<=1),q&&(q.disabled=E>=f)};var o=K,t=J,n=N,e=X,a=B;let{updateCharts:r,destroyCharts:i}=await Promise.resolve().then(()=>(jt(),vt)),{setupTabs:c,updateSessionsTable:h}=await Promise.resolve().then(()=>(xt(),Lt)),u=await Promise.resolve().then(()=>(at(),Dt)).then(l=>l.default),s=[],d=[],m="1y",b="This Year",C=20,E=1,x="All",O=document.querySelectorAll(".btn-filter"),At=document.getElementById("date-from"),$t=document.getElementById("date-to"),Tt=document.getElementById("apply-custom-date"),T=document.getElementById("project-filter-select"),V=document.getElementById("prev-page-btn"),q=document.getElementById("next-page-btn"),ot=document.getElementById("page-info");window.onSessionsLoaded=function(l){if(typeof l=="string")try{l=JSON.parse(l)}catch{l=[]}window.allSessions=l,s=l,k()},window.onProjectsLoaded=function(l){if(typeof l=="string")try{l=JSON.parse(l)}catch{l=[]}d=l,N(),typeof A=="function"&&A()};async function rt(l){let f=null,g=null;if(l==="custom"&&(f=At.value,g=$t.value,!f||!g)){u.showNotification("warning","Invalid Range",'Please select both "From" and "To" dates for custom range.');return}let{startDate:p,endDate:y,rangeTitle:w}=K(l,f,g);if(w==="Invalid Range")return;let v=J(p,y);m=l,b=w,O.forEach(j=>{j.dataset.range===l?j.classList.add("active"):j.classList.remove("active")}),l==="custom"&&O.forEach(j=>{j.closest(".date-filter-buttons")&&j.classList.remove("active")});try{await r(v,s,w)}catch{u.showNotification("error","Chart Error","Failed to update charts")}}async function k(){if(!s)return;let{startDate:l,endDate:f}=K(m),g=J(l,f);try{await r(g,s,b)}catch{u.showNotification("error","Chart Error","Failed to update charts")}N(),B()}async function Bt(){let l=document.getElementById("projects-list"),f=document.getElementById("add-project-form");!l||!f||(await A(),f.addEventListener("submit",async g=>{g.preventDefault();let p=document.getElementById("new-project-name"),y=document.getElementById("new-project-color");if(!(!p||!y))try{let w=await window.jujuApi.addProject({name:p.value.trim(),color:y.value});w&&w.success&&(p.value="",y.value="#4E79A7",await A(),await k(),u.showNotification("success","Project Added",`Project "${p.value.trim()}" created successfully`))}catch(w){u.showNotification("error","Add Failed",`Failed to add project: ${w.message}`)}}))}async function A(){let l=document.getElementById("projects-list");if(l)try{l.innerHTML="",d.forEach(f=>{let g=document.createElement("div");g.className="project-item",g.innerHTML=`
                        <div class="project-info">
                            <span class="project-name">${f.name}</span>
                            <div class="project-color">
                                <input type="color" value="${f.color||"#4E79A7"}" 
                                       data-project-id="${f.id}">
                            </div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-delete" data-id="${f.id}" data-name="${f.name}" title="Delete Project" aria-label="Delete Project">&times;</button>
                        </div>
                    `;let p=g.querySelector('input[type="color"]');p&&p.addEventListener("change",async y=>{try{await window.jujuApi.updateProjectColor(f.id,y.target.value),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),u.showNotification("success","Color Updated",`Project "${f.name}" color updated`)}catch(w){u.showNotification("error","Update Failed",`Failed to update color: ${w.message}`)}}),l.appendChild(g)}),N()}catch{l.innerHTML='<div class="error">Failed to load projects</div>',u.showNotification("error","Load Failed","Failed to load projects")}}O.forEach(l=>{l.closest(".date-filter-buttons")&&l.addEventListener("click",()=>rt(l.dataset.range))}),Tt.addEventListener("click",()=>rt("custom")),T?.addEventListener("change",l=>{x=l.target.value,E=1,B()}),V?.addEventListener("click",()=>{E>1&&(E--,B())}),q?.addEventListener("click",()=>{let{totalPages:l}=X();E<l&&(E++,B())}),document.getElementById("projects-list").addEventListener("click",async function(l){if(l.target.classList.contains("btn-delete")){l.preventDefault(),l.stopPropagation();let f=l.target,g=f.dataset.id,p=f.dataset.name||`Project ${g}`;if(!g){u.showNotification("error","Error","Project ID not found");return}try{let y=await u.deleteProjectWithFallback(g,p);y.success?(await A(),await k(),window.jujuApi&&typeof window.jujuApi.refreshMenu=="function"&&window.jujuApi.refreshMenu()):y.cancelled||console.error("Project deletion failed:",y.error)}catch{u.showNotification("error","Delete Failed","An unexpected error occurred while deleting the project")}}}),c(),window.jujuApi.loadProjects(),window.jujuApi.loadSessions(),await Bt(),await k(),u.on("sessionDeleted",()=>{k()}),u.on("projectDeleted",()=>{A(),k()})}catch(r){eventSystem&&eventSystem.showNotification("error","Initialization Failed","Failed to initialize dashboard. Please check console for details.");let i=document.getElementById("charts");i&&(i.innerHTML=`<div class="error-message">Failed to initialize dashboard. Please check console for details. Error: ${r.message}</div>`)}});})();
